# rate_limiting.conf
# Rate limiting, real IP, scanner detection, and cache configuration for SPARK
#
# Include this file in your main nginx.conf http{} block:
#   include /path/to/spark/nginx/rate_limiting.conf;
#
# Replace placeholders:
#   {{AUTH_CACHE_PATH}}    -> Path for auth response cache (e.g., /tmp/spark_auth_cache)
#   {{LANDING_CACHE_PATH}} -> Path for landing static cache (e.g., /tmp/spark_landing_cache)

# ==============================================================================
# RATE LIMITING ZONES
# ==============================================================================
# $binary_remote_addr is more memory efficient than $remote_addr

# General requests: 30 requests per second
limit_req_zone $binary_remote_addr zone=general:10m rate=30r/s;

# Authentication endpoints: 15 requests per second
limit_req_zone $binary_remote_addr zone=auth:10m rate=15r/s;

# Static files: 90 requests per second (images, CSS, JS)
limit_req_zone $binary_remote_addr zone=static:10m rate=90r/s;

# Scanner protection: 3 requests per minute (for suspicious patterns)
limit_req_zone $binary_remote_addr zone=scanner_protection:10m rate=3r/m;

# ==============================================================================
# REAL CLIENT IP (Cloudflare / cloudflared tunnel)
# ==============================================================================
# When running behind Cloudflare Tunnel, the direct connection comes from
# cloudflared on localhost. CF-Connecting-IP carries the real visitor IP.

real_ip_header CF-Connecting-IP;
real_ip_recursive on;

# Loopback (cloudflared connects from localhost)
set_real_ip_from 127.0.0.1;
set_real_ip_from ::1;

# Cloudflare IPv4 ranges
# Source: https://www.cloudflare.com/ips-v4/
set_real_ip_from 173.245.48.0/20;
set_real_ip_from 103.21.244.0/22;
set_real_ip_from 103.22.200.0/22;
set_real_ip_from 103.31.4.0/22;
set_real_ip_from 141.101.64.0/18;
set_real_ip_from 108.162.192.0/18;
set_real_ip_from 190.93.240.0/20;
set_real_ip_from 188.114.96.0/20;
set_real_ip_from 197.234.240.0/22;
set_real_ip_from 198.41.128.0/17;
set_real_ip_from 162.158.0.0/15;
set_real_ip_from 104.16.0.0/13;
set_real_ip_from 104.24.0.0/14;
set_real_ip_from 172.64.0.0/13;
set_real_ip_from 131.0.72.0/22;

# Cloudflare IPv6 ranges
# Source: https://www.cloudflare.com/ips-v6/
set_real_ip_from 2400:cb00::/32;
set_real_ip_from 2606:4700::/32;
set_real_ip_from 2803:f800::/32;
set_real_ip_from 2405:b500::/32;
set_real_ip_from 2405:8100::/32;
set_real_ip_from 2a06:98c0::/29;
set_real_ip_from 2c0f:f248::/32;

# ==============================================================================
# SCANNER / BOT DETECTION MAP (URI-based)
# ==============================================================================
# Identifies malicious scanning patterns by request URI.
# Used in server blocks: if ($is_scanner_request) { return 444; }

map $request_uri $is_scanner_request {
    default 0;

    # =================================================================
    # PATH MANIPULATION / EVASION ATTEMPTS (always malicious)
    # =================================================================
    "~*^//" 1;                      # Double slash at start
    "~*\.\." 1;                     # Path traversal (..)
    "~*%2e" 1;                      # URL-encoded dot
    "~*%2f" 1;                      # URL-encoded forward slash
    "~*%5c" 1;                      # URL-encoded backslash
    "~*\\\\" 1;                     # Literal backslash
    "~*%00" 1;                      # Null byte injection
    "~*%0[ad]" 1;                   # CRLF injection (%0a, %0d)
    "~*%u00" 1;                     # Unicode encoding attempt

    # =================================================================
    # BACKUP / CONFIG FILES
    # =================================================================
    "~*\.(env|sql|dump|bak|backup|zip|tar\.gz|conf|ini|log)$" 1;
    "~*\.(old|orig|save|swp|tmp|rar|7z)$" 1;
    "~*~$" 1;

    # =================================================================
    # PHP EXPLOITS
    # =================================================================
    "~*(phpinfo|execute|shell|rce|debug|cmd|eval|system)\.php$" 1;
    "~*(c99|r57|alfa|wso|b374k)\.php$" 1;

    # =================================================================
    # HIDDEN FILES / DIRECTORIES
    # =================================================================
    "~*/(\.git|\.aws|\.ssh|\.env|\.htaccess|\.htpasswd|\.svn|\.hg)" 1;
    "~*/\.DS_Store" 1;

    # =================================================================
    # WORDPRESS (full coverage)
    # =================================================================
    "~*wp-" 1;
    "~*wordpress" 1;
    "~*xmlrpc\.php" 1;

    # =================================================================
    # OTHER CMS
    # =================================================================
    "~*joomla" 1;
    "~*drupal" 1;
    "~*magento" 1;
    "~*typo3" 1;

    # =================================================================
    # PHP ADMIN PANELS
    # =================================================================
    "~*(phpmyadmin|pma|myadmin|mysql|phpMyAdmin)" 1;

    # =================================================================
    # ADMIN / CONFIG PATHS
    # =================================================================
    "~*(db|dump|backup|config|credentials|keys|secrets)/" 1;
    "~*admin\.php" 1;
    "~*administrator" 1;

    # =================================================================
    # CLOUD METADATA (SSRF)
    # =================================================================
    "~*latest/meta-data" 1;
    "~*169\.254\.169\.254" 1;

    # =================================================================
    # GRAPHQL INTROSPECTION
    # =================================================================
    "~*graphql.*introspection" 1;

    # =================================================================
    # JAVA / TOMCAT / JENKINS
    # =================================================================
    "~*manager/html" 1;
    "~*jenkins" 1;
    "~*hudson" 1;
    "~*solr" 1;
    "~*actuator" 1;

    # =================================================================
    # CONTAINER / ORCHESTRATION
    # =================================================================
    "~*docker" 1;
    "~*k8s" 1;
    "~*kubernetes" 1;
    "~*portainer" 1;

    # =================================================================
    # CGI
    # =================================================================
    "~*cgi-bin" 1;

    # =================================================================
    # INTERNAL PATHS
    # =================================================================
    "~*/internal/" 1;
    "~*/hidden/" 1;

    # =================================================================
    # MICROSOFT EXCHANGE / OUTLOOK
    # =================================================================
    "~*/owa/" 1;
    "~*/ecp/" 1;
    "~*autodiscover" 1;
    "~*aspnet_client" 1;
    "~*/remote/login" 1;

    # =================================================================
    # NON-PYTHON FILE EXTENSIONS (ASP.NET, Java, ColdFusion, Perl)
    # =================================================================
    "~*\.(asp|aspx|jsp|jspx|do|action)$" 1;
    "~*\.(cgi|pl|cfm|cfc)$" 1;

    # =================================================================
    # FRAMEWORK DEBUG TOOLS (Laravel, Symfony, Django)
    # =================================================================
    "~*/telescope" 1;
    "~*/horizon" 1;
    "~*/_profiler" 1;
    "~*/__debug__" 1;

    # =================================================================
    # ASP.NET DIAGNOSTICS
    # =================================================================
    "~*elmah\.axd" 1;
    "~*trace\.axd" 1;
    "~*web\.config" 1;

    # =================================================================
    # APACHE STATUS PAGES
    # =================================================================
    "~*/server-status" 1;
    "~*/server-info" 1;

    # =================================================================
    # DEPENDENCY / BUILD FILES
    # =================================================================
    "~*/vendor/" 1;
    "~*/node_modules/" 1;
    "~*composer\.(json|lock)$" 1;
    "~*package\.json$" 1;
    "~*package-lock\.json$" 1;
    "~*requirements\.txt$" 1;
    "~*Pipfile" 1;
    "~*Gemfile" 1;
    "~*Makefile$" 1;
    "~*Gruntfile" 1;
    "~*Gulpfile" 1;
    "~*webpack\.config" 1;

    # =================================================================
    # IDE / EDITOR CONFIGS
    # =================================================================
    "~*/\.vscode/" 1;
    "~*/\.idea/" 1;
    "~*/\.project$" 1;
    "~*/\.settings/" 1;

    # =================================================================
    # JAVA ENTERPRISE (JBoss, WebLogic, Axis, Struts)
    # =================================================================
    "~*jmx-console" 1;
    "~*web-console" 1;
    "~*/invoker/" 1;
    "~*jolokia" 1;
    "~*hawtio" 1;
    "~*wls-wsat" 1;
    "~*ws_utc" 1;
    "~*axis2/" 1;
    "~*struts/" 1;

    # =================================================================
    # COLDFUSION
    # =================================================================
    "~*CFIDE" 1;
    "~*cfide" 1;
    "~*lucee" 1;
    "~*railo" 1;

    # =================================================================
    # MONITORING TOOLS
    # =================================================================
    "~*nagios" 1;
    "~*zabbix" 1;
    "~*munin" 1;
    "~*cacti" 1;
    "~*grafana" 1;
    "~*kibana" 1;
    "~*prometheus" 1;

    # =================================================================
    # ROUTER / IoT EXPLOITS
    # =================================================================
    "~*/HNAP1/" 1;
    "~*/boaform/" 1;
    "~*/GponForm/" 1;
    "~*/goform/" 1;
    "~*setup\.cgi" 1;
    "~*apply\.cgi" 1;

    # =================================================================
    # WINDOWS METADATA
    # =================================================================
    "~*Thumbs\.db" 1;
    "~*desktop\.ini" 1;

    # =================================================================
    # CMS ADDITIONAL
    # =================================================================
    "~*prestashop" 1;
    "~*shopify" 1;
    "~*moodle" 1;
    "~*confluence" 1;
    "~*bitbucket" 1;

    # =================================================================
    # OTHER CLASSIC SCANNER TARGETS
    # =================================================================
    "~*login\.php" 1;
    "~*index\.php" 1;
    "~*crossdomain\.xml" 1;
    "~*clientaccesspolicy\.xml" 1;
    "~*nmaplowercheck" 1;
}

# ==============================================================================
# STATIC CONTENT IDENTIFICATION MAP
# ==============================================================================
map $request_uri $is_static_content {
    default 0;
    "~*\.(jpg|jpeg|png|gif|webp|css|js|ico|svg|woff|woff2|ttf|eot)$" 1;
    "~*/users/.*/profile/" 1;
    "~*/users/.*/files/" 1;
}

# ==============================================================================
# CACHE ZONES
# ==============================================================================

# Auth response cache (reduces FastAPI load for repeated auth checks)
proxy_cache_path "{{AUTH_CACHE_PATH}}" levels=1:2 keys_zone=auth_cache:10m max_size=10g inactive=60m use_temp_path=off;

# Landing page static assets cache
proxy_cache_path "{{LANDING_CACHE_PATH}}" levels=1:2 keys_zone=landing_static:50m max_size=2g inactive=7d use_temp_path=off;

# ==============================================================================
# SUSPICIOUS IP MAP (manual additions)
# ==============================================================================
map $binary_remote_addr $is_suspicious_ip {
    default 0;
    # Add IPs as needed:
    # 1.2.3.4 1;
}
