# rate_limiting.conf
# Rate limiting configuration for SPARK
#
# Include this file in your main nginx.conf:
#   include /path/to/spark/nginx/rate_limiting.conf;

# Rate limiting zones
# $binary_remote_addr is more memory efficient than $remote_addr

# General requests: 10 requests per second
limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;

# Static files: 50 requests per second (images, CSS, JS)
limit_req_zone $binary_remote_addr zone=static:10m rate=50r/s;

# Authentication endpoints: 5 requests per second (stricter)
limit_req_zone $binary_remote_addr zone=auth:10m rate=5r/s;

# Cache for authentication responses (reduces FastAPI load)
proxy_cache_path /tmp/spark_auth_cache levels=1:2 keys_zone=auth_cache:10m max_size=100m inactive=10m use_temp_path=off;

# Map to detect scanner/bot requests
map $http_user_agent $is_scanner_request {
    default 0;
    "~*(curl|wget|python-requests|scanner|bot|crawl|spider)" 1;
}

# Map for suspicious IP blocking (add IPs as needed)
map $binary_remote_addr $is_suspicious_ip {
    default 0;
    # Example: block specific IP
    # 1.2.3.4 1;
}
