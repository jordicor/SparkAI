{% extends 'base_admin.html' %}

{% block title %}LLM Management - AURVEK{% endblock %}

{% block styles %}
<style>
    /* Page-specific styles that override or extend admin CSS */
    .price-cell {
        font-family: monospace;
        font-size: 0.85rem;
    }
</style>
{% endblock %}

{% block page_title %}LLM Management{% endblock %}

{% block page_subtitle %}
<p class="page-subtitle">Manage language models available in your application</p>
{% endblock %}

{% block page_actions %}
<a href="/admin/llm/new" class="btn btn-success">
    <i class="fas fa-plus me-1"></i>Add New Model
</a>
{% endblock %}

{% block tabs %}
<div class="internal-tabs">
    <a href="/admin/llms" class="internal-tab active">All Models</a>
    <a href="/admin/openrouter" class="internal-tab">
        <i class="fas fa-sync me-1"></i> OpenRouter Sync
    </a>
</div>
{% endblock %}

{% block content %}
<!-- Stats -->
<div class="stats-row">
    <span class="stat-badge">
        <i class="fas fa-robot"></i> <strong id="totalCount">{{ llms|length }}</strong> Total Models
    </span>
    <span class="stat-badge" id="statsFiltered" style="display: none;">
        <i class="fas fa-filter"></i> <strong id="filteredCount">0</strong> Shown
    </span>
    {% set vision_count = llms|selectattr('5')|list|length %}
    <span class="stat-badge">
        <i class="fas fa-eye"></i> <strong>{{ vision_count }}</strong> Vision Models
    </span>
    <span class="stat-badge" id="statsSelected" style="display: none;">
        <i class="fas fa-check-square"></i> <strong id="selectedCount">0</strong> Selected
    </span>
</div>

<!-- Filters Section -->
<div class="section-container">
    <div class="section-title">
        <i class="fas fa-filter"></i> Filters
    </div>
    <div class="flex-row">
        <div class="flex-column">
            <div class="mb-3">
                <label class="form-label">Provider</label>
                <select class="form-select" id="providerFilter" onchange="applyFilters()">
                    <option value="">All Providers</option>
                    {% for provider in providers %}
                    <option value="{{ provider }}">{{ provider }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="flex-column">
            <div class="mb-3">
                <label class="form-label">Search</label>
                <input type="text" class="form-control" id="searchFilter" placeholder="Search by model name..." oninput="applyFilters()">
            </div>
        </div>
        <div class="flex-column">
            <div class="mb-3">
                <label class="form-label">Vision Capability</label>
                <select class="form-select" id="visionFilter" onchange="applyFilters()">
                    <option value="">All Models</option>
                    <option value="yes">Vision Only</option>
                    <option value="no">No Vision</option>
                </select>
            </div>
        </div>
        <div class="flex-column">
            <div class="mb-3">
                <label class="form-label">Sort By</label>
                <select class="form-select" id="sortBy" onchange="applyFilters()">
                    <option value="model">Model Name (A-Z)</option>
                    <option value="model-desc">Model Name (Z-A)</option>
                    <option value="provider">Provider</option>
                    <option value="input-price">Input Price (Low-High)</option>
                    <option value="output-price">Output Price (Low-High)</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Models Table Section -->
<div class="section-container">
    <div class="section-title">
        <i class="fas fa-list"></i> Language Models
        <span style="margin-left: auto; display: flex; gap: 8px;">
            <button id="deleteSelectedButton" onclick="deleteSelectedLlms()" class="btn btn-sm btn-outline-danger" style="display:none;">
                <i class="fas fa-trash"></i> Delete Selected
            </button>
            <button id="selectButton" onclick="toggleSelection()" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-check-square"></i> Select
            </button>
        </span>
    </div>
    <div class="table-wrapper">
        <table class="table">
            <thead>
                <tr>
                    <th style="width: 40px;">
                        <input type="checkbox" id="selectAllCheckbox" onclick="toggleSelectAll()" style="display:none; cursor:pointer; transform: scale(1.2);">
                    </th>
                    <th>Provider</th>
                    <th>Model</th>
                    <th>Input Cost ($/1M)</th>
                    <th>Output Cost ($/1M)</th>
                    <th>Vision</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody id="llmTableBody">
                {% for llm in llms %}
                <tr class="llm-row"
                    data-provider="{{ llm[1] }}"
                    data-model="{{ llm[2]|lower }}"
                    data-vision="{{ 'yes' if llm[5] else 'no' }}"
                    data-input-price="{{ llm[3] }}"
                    data-output-price="{{ llm[4] }}"
                    data-id="{{ llm[0] }}">
                    <td>
                        {% if llm[1] == 'OpenRouter' %}
                        <input type="checkbox" class="llm-checkbox" value="{{ llm[0] }}" disabled title="Manage via OpenRouter Sync" style="display:none; cursor:not-allowed; transform: scale(1.2); opacity: 0.4;">
                        {% else %}
                        <input type="checkbox" class="llm-checkbox" value="{{ llm[0] }}" onclick="event.stopPropagation(); updateSelectedCount();" style="display:none; cursor:pointer; transform: scale(1.2);">
                        {% endif %}
                    </td>
                    <td>
                        <span class="badge provider-badge provider-{{ llm[1] }}">{{ llm[1] }}</span>
                    </td>
                    <td><strong>{{ llm[2] }}</strong></td>
                    <td class="price-cell">${{ "%.4f"|format(llm[3]) }}</td>
                    <td class="price-cell">${{ "%.4f"|format(llm[4]) }}</td>
                    <td>
                        {% if llm[5] %}
                        <span class="vision-badge"><i class="fas fa-eye me-1"></i>Vision</span>
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td class="text-end table-actions">
                        <a href="/admin/llm/edit/{{ llm[0] }}" class="btn btn-sm btn-outline-primary" title="Edit" data-bs-toggle="tooltip">
                            <i class="fas fa-edit"></i>
                        </a>
                        <button onclick="deleteLlm({{ llm[0] }})" class="btn btn-sm btn-outline-danger" title="Delete" data-bs-toggle="tooltip">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts_inline %}
<script>
    // --- Helper: transition modal in-place (avoids backdrop stacking) ---
    function transitionModal(type, title, message) {
        const el = NotificationModal._modalElement;
        el.classList.remove('modal-success', 'modal-error', 'modal-warning', 'modal-info', 'modal-confirm');
        el.classList.add(`modal-${type}`);
        document.getElementById('notificationModalIcon').innerHTML = NotificationModal._getIcon(type);
        NotificationModal.update({
            title: title,
            message: message,
            showCancel: false,
            showConfirm: true,
            confirmText: 'OK'
        });
        const btn = document.getElementById('notificationModalConfirmBtn');
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        newBtn.addEventListener('click', () => NotificationModal.hide());
    }

    // --- Single delete (with modal) ---
    function deleteLlm(llmId) {
        NotificationModal.confirm(
            'Delete LLM',
            'Are you sure you want to delete this model? This action cannot be undone.',
            () => {
                fetch(`/admin/llm/delete/${llmId}`, {
                    method: 'DELETE'
                }).then(response => {
                    if (response.ok) {
                        const row = document.querySelector(`tr[data-id="${llmId}"]`);
                        if (row) row.remove();
                        updateStats();
                        transitionModal('success', 'Deleted', 'Model deleted successfully.');
                    } else {
                        transitionModal('error', 'Delete Failed', 'Failed to delete LLM. Please try again.');
                    }
                }).catch(() => {
                    transitionModal('error', 'Error', 'Network error. Please try again.');
                });
            },
            null,
            { confirmText: 'Delete', cancelText: 'Cancel', hideOnConfirm: false }
        );
    }

    // --- Bulk delete (with modal + loading) ---
    function deleteSelectedLlms() {
        const checkboxes = document.querySelectorAll('.llm-checkbox:checked');
        const idsToDelete = Array.from(checkboxes).map(cb => parseInt(cb.value));

        if (idsToDelete.length === 0) {
            NotificationModal.warning('No Selection', 'Please select at least one model to delete.');
            return;
        }

        NotificationModal.confirm(
            'Delete Selected',
            `Are you sure you want to delete <strong>${idsToDelete.length}</strong> selected model(s)? This action cannot be undone.`,
            () => {
                // Transition to loading state in-place (same modal, no new backdrop)
                transitionModal('info', 'Deleting...', '<div class="text-center py-3"><i class="fas fa-spinner fa-spin fa-2x"></i><div class="mt-2">Deleting selected models...</div></div>');
                const confirmBtn = document.getElementById('notificationModalConfirmBtn');
                confirmBtn.style.display = 'none';

                fetch('/admin/llm/bulk-delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ llm_ids: idsToDelete })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        idsToDelete.forEach(id => {
                            const row = document.querySelector(`tr[data-id="${id}"]`);
                            if (row) row.remove();
                        });
                        toggleSelection();
                        updateStats();
                        transitionModal('success', 'Deleted', `Successfully deleted ${data.deleted} model(s).`);
                    } else {
                        transitionModal('error', 'Delete Failed', data.detail || 'Failed to delete models. Please try again.');
                    }
                })
                .catch(() => {
                    transitionModal('error', 'Error', 'Network error. Please try again.');
                });
            },
            null,
            { confirmText: 'Delete', cancelText: 'Cancel', hideOnConfirm: false }
        );
    }

    // --- Selection mode toggle ---
    function toggleSelection() {
        const checkboxes = document.querySelectorAll('.llm-checkbox');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const isHidden = checkboxes.length === 0 || checkboxes[0].style.display === 'none';
        const selectButton = document.getElementById('selectButton');
        const deleteButton = document.getElementById('deleteSelectedButton');
        const statsSelected = document.getElementById('statsSelected');

        if (isHidden) {
            checkboxes.forEach(cb => {
                cb.checked = false;
                cb.style.display = 'inline';
            });
            selectAllCheckbox.style.display = 'inline';
            selectAllCheckbox.checked = false;
            selectButton.innerHTML = '<i class="fas fa-times"></i> Cancel';
            selectButton.classList.remove('btn-outline-secondary');
            selectButton.classList.add('btn-secondary');
            deleteButton.style.display = 'inline-block';
            statsSelected.style.display = 'inline-flex';
        } else {
            checkboxes.forEach(cb => {
                cb.style.display = 'none';
                cb.checked = false;
            });
            selectAllCheckbox.style.display = 'none';
            selectAllCheckbox.checked = false;
            selectButton.innerHTML = '<i class="fas fa-check-square"></i> Select';
            selectButton.classList.remove('btn-secondary');
            selectButton.classList.add('btn-outline-secondary');
            deleteButton.style.display = 'none';
            statsSelected.style.display = 'none';
        }
        updateSelectedCount();
    }

    // --- Select / Deselect all (only non-disabled, visible rows) ---
    function toggleSelectAll() {
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const checkboxes = document.querySelectorAll('.llm-checkbox:not(:disabled)');
        checkboxes.forEach(cb => {
            const row = cb.closest('tr');
            if (row.style.display !== 'none') {
                cb.checked = selectAllCheckbox.checked;
            }
        });
        updateSelectedCount();
    }

    // --- Update selected counter + sync selectAll state ---
    function updateSelectedCount() {
        const checkedCount = document.querySelectorAll('.llm-checkbox:checked').length;
        document.getElementById('selectedCount').textContent = checkedCount;

        const selectableVisible = Array.from(document.querySelectorAll('.llm-checkbox:not(:disabled)')).filter(cb => cb.closest('tr').style.display !== 'none');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        if (selectableVisible.length > 0) {
            const visibleChecked = selectableVisible.filter(cb => cb.checked).length;
            selectAllCheckbox.checked = visibleChecked === selectableVisible.length;
            selectAllCheckbox.indeterminate = visibleChecked > 0 && visibleChecked < selectableVisible.length;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        }
    }

    // --- Filters & sorting ---
    function applyFilters() {
        const providerFilter = document.getElementById('providerFilter').value;
        const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
        const visionFilter = document.getElementById('visionFilter').value;
        const sortBy = document.getElementById('sortBy').value;

        const rows = Array.from(document.querySelectorAll('.llm-row'));
        let visibleCount = 0;

        rows.forEach(row => {
            const provider = row.dataset.provider;
            const model = row.dataset.model;
            const vision = row.dataset.vision;

            let visible = true;
            if (providerFilter && provider !== providerFilter) visible = false;
            if (searchFilter && !model.includes(searchFilter)) visible = false;
            if (visionFilter && vision !== visionFilter) visible = false;

            row.style.display = visible ? '' : 'none';
            if (visible) visibleCount++;
        });

        const tbody = document.getElementById('llmTableBody');
        const visibleRows = rows.filter(r => r.style.display !== 'none');

        visibleRows.sort((a, b) => {
            switch (sortBy) {
                case 'model':
                    return a.dataset.model.localeCompare(b.dataset.model);
                case 'model-desc':
                    return b.dataset.model.localeCompare(a.dataset.model);
                case 'provider':
                    return a.dataset.provider.localeCompare(b.dataset.provider) ||
                           a.dataset.model.localeCompare(b.dataset.model);
                case 'input-price':
                    return parseFloat(a.dataset.inputPrice) - parseFloat(b.dataset.inputPrice);
                case 'output-price':
                    return parseFloat(a.dataset.outputPrice) - parseFloat(b.dataset.outputPrice);
                default:
                    return 0;
            }
        });

        visibleRows.forEach(row => tbody.appendChild(row));
        rows.filter(r => r.style.display === 'none').forEach(row => tbody.appendChild(row));

        const totalCount = rows.length;
        const statsFiltered = document.getElementById('statsFiltered');
        if (visibleCount !== totalCount) {
            statsFiltered.style.display = 'inline-flex';
            document.getElementById('filteredCount').textContent = visibleCount;
        } else {
            statsFiltered.style.display = 'none';
        }

        // Sync selectAll checkbox when filters change
        updateSelectedCount();
    }

    function updateStats() {
        const rows = document.querySelectorAll('.llm-row');
        document.getElementById('totalCount').textContent = rows.length;
        applyFilters();
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        applyFilters();
    });
</script>
{% endblock %}
