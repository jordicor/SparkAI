{% extends 'base.html' %}

{% block title %}Settings - SPARK{% endblock %}

{% block styles %}
{# Theme CSS loaded by theme-loader.js #}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.13/css/intlTelInput.css">
<style>
    /* --- Usage tab styles --- */
    .stat-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.25rem;
        height: 100%;
        border-left: 3px solid var(--accent);
    }
    .stat-card.primary { border-left-color: var(--accent); }
    .stat-card.success { border-left-color: var(--success); }
    .stat-card.info { border-left-color: var(--info); }
    .stat-card.warning { border-left-color: var(--warning); }
    .stat-card .amount {
        font-size: 1.75rem;
        font-weight: bold;
        color: var(--text-primary);
    }
    .stat-card .label {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-bottom: 0.25rem;
    }
    .stat-card .subtext {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: 0.25rem;
    }
    .filters-row {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: end;
        margin-bottom: 20px;
    }
    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    .filter-group label {
        font-size: 0.8rem;
        color: var(--text-secondary);
        font-weight: 500;
    }
    .filter-group select {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        border-radius: 6px;
        padding: 6px 12px;
        font-size: 0.9rem;
    }
    .filter-group select:focus {
        outline: none;
        border-color: var(--accent);
    }
    .type-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    .type-badge.ai_tokens { background: rgba(88, 101, 242, 0.2); color: var(--accent); }
    .type-badge.tts { background: rgba(67, 181, 129, 0.2); color: var(--success); }
    .type-badge.stt { background: rgba(52, 152, 219, 0.2); color: var(--info); }
    .type-badge.image { background: rgba(250, 166, 26, 0.2); color: var(--warning); }
    .type-badge.video { background: rgba(231, 76, 60, 0.2); color: var(--danger); }
    .type-badge.domain { background: rgba(155, 89, 182, 0.2); color: #9b59b6; }
    .chart-container {
        position: relative;
        height: 220px;
        width: 100%;
    }
    .usage-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid var(--border-color);
    }
    .usage-item:last-child {
        border-bottom: none;
    }
    .usage-item .details {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    .usage-item .ops {
        font-size: 0.85rem;
        color: var(--text-muted);
    }
    .usage-item .cost {
        font-weight: bold;
        font-size: 1.1rem;
    }
    .daily-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 12px;
        background: var(--bg-tertiary);
        border-radius: 8px;
        margin-bottom: 8px;
    }
    .daily-item .date {
        font-weight: 500;
    }
    .daily-item .stats {
        display: flex;
        gap: 20px;
        font-size: 0.9rem;
    }
    .daily-item .stat-val {
        color: var(--text-secondary);
    }
    .daily-item .stat-val strong {
        color: var(--text-primary);
    }
    .balance-info {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px;
        background: var(--bg-tertiary);
        border-radius: 8px;
        margin-top: 10px;
    }
    .balance-info .balance-amount {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--success);
    }
    .balance-info .balance-label {
        font-size: 0.85rem;
        color: var(--text-secondary);
    }

    /* --- Change password styles --- */
    .password-requirements {
        font-size: 0.85rem;
        color: var(--text-muted);
    }
    .password-requirements li {
        margin-bottom: 0.25rem;
    }
    .password-requirements li.valid {
        color: var(--success);
    }
    .password-requirements li.valid::before {
        content: '\f00c';
        font-family: 'Font Awesome 6 Free';
        font-weight: 900;
        margin-right: 0.5rem;
    }
    .password-requirements li.invalid::before {
        content: '\f00d';
        font-family: 'Font Awesome 6 Free';
        font-weight: 900;
        margin-right: 0.5rem;
        color: var(--danger);
    }
    .password-match {
        font-size: 0.85rem;
        margin-top: 0.5rem;
    }
    .password-match.match {
        color: var(--success);
    }
    .password-match.no-match {
        color: var(--danger);
    }
    .btn-show-password {
        background-color: var(--bg-tertiary);
        border-color: var(--border-color);
        color: var(--text-primary);
    }
    .btn-show-password:hover {
        background-color: var(--bg-secondary);
        border-color: var(--border-color);
        color: var(--text-primary);
    }

    /* --- API Keys tab styles (mockup) --- */
    .api-key-row {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 14px 16px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        margin-bottom: 10px;
        transition: all 0.2s;
    }
    .api-key-row:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .provider-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        font-weight: 700;
        color: #fff;
        flex-shrink: 0;
    }
    .api-key-row .provider-info {
        flex: 1;
        min-width: 0;
    }
    .api-key-row .provider-name {
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--text-primary);
    }
    .api-key-row .provider-desc {
        font-size: 0.75rem;
        color: var(--text-muted);
    }
    .api-key-input-group {
        display: flex;
        align-items: center;
        gap: 6px;
        flex: 1;
        max-width: 280px;
    }
    .api-key-input-group .form-control {
        font-size: 0.82rem;
        padding: 6px 10px;
    }
    .api-key-row .status-indicator {
        font-size: 0.72rem;
        padding: 3px 10px;
        border-radius: 12px;
        font-weight: 600;
        white-space: nowrap;
    }
    .api-key-row .provider-link {
        font-size: 0.72rem;
        color: var(--text-muted);
        text-decoration: none;
        white-space: nowrap;
    }
    .api-key-row .provider-link:hover {
        color: var(--accent);
    }
    @media (max-width: 768px) {
        .api-key-row {
            flex-wrap: wrap;
            gap: 10px;
        }
        .api-key-input-group {
            max-width: 100%;
            width: 100%;
        }
    }

    /* --- Tab layout --- */
    .settings-tabs { margin-bottom: 0; }
    .tab-pane { padding-top: 0.5rem; }

    /* --- Web Search section --- */
    .ws-engine-options { display: flex; flex-direction: column; gap: 8px; }
    .ws-engine-option {
        display: flex; align-items: center; gap: 12px;
        padding: 10px 14px; border-radius: 8px;
        border: 1px solid var(--border-color);
        background: var(--bg-tertiary);
        cursor: pointer; transition: all 0.15s ease;
    }
    .ws-engine-option:hover { border-color: var(--accent); }
    .ws-engine-option.active { border-color: var(--accent); background: color-mix(in srgb, var(--accent) 8%, var(--bg-tertiary)); }
    .ws-engine-option.disabled {
        opacity: 0.5; cursor: not-allowed;
        pointer-events: none;
    }
    .ws-engine-option input[type="radio"] { accent-color: var(--accent); margin: 0; }
    .ws-engine-label { font-weight: 500; color: var(--text-primary); }
    .ws-engine-desc { font-size: 0.82rem; color: var(--text-muted); margin-top: 2px; }
    .ws-badge-rec {
        font-size: 0.7rem; font-weight: 600; padding: 2px 7px;
        border-radius: 4px; background: var(--accent); color: #fff;
        margin-left: 6px; vertical-align: middle;
    }
</style>
{% endblock %}

{% block page_title %}Settings{% endblock %}
{% block back_url %}/{% endblock %}

{% block toolbar %}{% endblock %}

{% block content %}
<!-- Nav Tabs -->
<ul class="nav nav-tabs settings-tabs" id="settingsTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab" aria-controls="profile" aria-selected="true">
            <i class="fas fa-user me-1"></i> Profile
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="usage-tab" data-bs-toggle="tab" data-bs-target="#usage" type="button" role="tab" aria-controls="usage" aria-selected="false">
            <i class="fas fa-chart-bar me-1"></i> Usage & Billing
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="api-keys-tab" data-bs-toggle="tab" data-bs-target="#api-keys" type="button" role="tab" aria-controls="api-keys" aria-selected="false">
            <i class="fas fa-key me-1"></i> API Keys
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="settingsTabContent">

    <!-- ==================== Profile Tab ==================== -->
    <div class="tab-pane fade show active" id="profile" role="tabpanel" aria-labelledby="profile-tab">
        <form method="post" action="/api/edit-profile" id="editProfileForm" enctype="multipart/form-data">
            <div class="section-container">
                <div class="section-title">Account Information</div>
                <div class="flex-row">
                    <div class="flex-column">
                        <div class="mb-3">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="username" name="username" value="{{ user_data['username'] }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="email" name="email" value="{{ user_data['email'] or '' }}">
                            <small class="form-text text-muted">Required for magic link recovery if your magic link expires</small>
                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="phone" name="phone_number" value="{{ user_data['phone_number'] }}" data-original="{{ user_data['phone_number'] }}">
                            <button type="button" class="btn btn-secondary mt-2" id="sendCodeButton" style="display: none;">Send Verification Code</button>
                        </div>
                        <div class="mb-3" id="verificationCodeContainer" style="display: none;">
                            <label for="verificationCode" class="form-label">Verification Code</label>
                            <input type="text" class="form-control" id="verificationCode" name="verification_code">
                        </div>
                        <div class="mb-3">
                            <label for="balance" class="form-label">Balance</label>
                            <input type="text" class="form-control" id="balance" value="${{ user_details['balance'] }}" readonly>
                        </div>
                    </div>
                    <div class="flex-column">
                        <div class="mb-3">
                            <label for="voice" class="form-label">
                                Voice Settings
                                <span class="info-icon" data-bs-toggle="tooltip" data-bs-html="true" title="
                                    This voice setting serves two purposes:
                                    <ul>
                                        <li>In the webchat: You can listen to your own messages read aloud by clicking the 'speaker' button.</li>
                                        <li>For MP3 exports: This voice will represent you in the exported conversation with the AI.</li>
                                    </ul>
                                    Choose a voice that best represents you or fits the context of your interactions.
                                ">ℹ️</span>
                            </label>
                            <select class="form-select" id="voice" name="sample_voice_id">
                                <!-- Options will be loaded dynamically with JavaScript -->
                            </select>
                            <small class="form-text text-muted">Select the voice that will be used for your messages when listening in the chat or exporting conversations to MP3.</small>
                            <div id="playButtonContainer" class="mt-2">
                                <!-- Play button and category dropdown will be added here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-container">
                <div class="section-title">User Information</div>
                <div class="flex-row">
                    <div class="flex-column d-flex justify-content-center align-items-center">
                        <div class="mb-3 text-center">
                            <label for="profilePicture" class="form-label">Profile Picture</label>
                            <div class="avatar-wrapper" style="margin: 0 auto;">
                                <div class="avatar-container" id="profilePictureContainer">
                                    {% if user_data['profile_picture'] %}
                                        <img src="{{ user_data['profile_picture'] }}" alt="Profile Picture" id="currentProfilePicture">
                                        <div class="avatar-icons">
                                            <span class="avatar-icon edit"><i class="fas fa-pencil-alt"></i></span>
                                            <span class="avatar-icon delete"><i class="fas fa-trash"></i></span>
                                        </div>
                                    {% else %}
                                        <span class="avatar-initial" id="defaultProfileInitial">{{ user_data['username']|first|upper }}</span>
                                        <div class="avatar-icons">
                                            <span class="avatar-icon edit"><i class="fas fa-pencil-alt"></i></span>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="avatar-preview hidden" id="previewContainer">
                                    <img id="previewImage" alt="Preview">
                                    <div class="avatar-icons">
                                        <span class="avatar-icon edit"><i class="fas fa-pencil-alt"></i></span>
                                        <span class="avatar-icon cancel"><i class="fas fa-times"></i></span>
                                    </div>
                                </div>
                                <input type="file" id="profilePicture" name="profile_picture" accept="image/*">
                            </div>
                        </div>
                    </div>
                    <div class="flex-column">
                        <div class="mb-3">
                            <label for="userInfo" class="form-label">
                                About You
                                <span class="info-icon" data-bs-toggle="tooltip" data-bs-html="true" title="This information helps the AI understand you better. It's completely confidential and only used to enhance your AI interactions.">ℹ️</span>
                            </label>
                            <textarea class="form-control" id="userInfo" name="user_info" rows="4" placeholder="Tell us about yourself, your interests, preferences, and how you'd like the AI to interact with you.">{{ user_data['user_info'] }}</textarea>
                            <small class="form-text text-muted">Share details about your background, hobbies, communication style, or any specific preferences for AI interactions.</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-container">
                <div class="section-title">
                    Interaction Profile
                    <span class="info-icon" data-bs-toggle="tooltip" data-bs-html="true" title="Choose how you want to interact with the AI. You can use your real profile or an alter-ego (alternative personality) for different purposes.">ℹ️</span>
                </div>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="profileType" id="useRealProfile" value="real" checked>
                        <label class="form-check-label" for="useRealProfile">
                            Use my real profile
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="profileType" id="useAlterEgo" value="alterEgo">
                        <label class="form-check-label" for="useAlterEgo">
                            Use an alter-ego
                        </label>
                    </div>
                </div>

                <div id="alterEgoSelection" class="mb-3" style="display: none;">
                    <label for="alterEgo" class="form-label">Select Alter-Ego</label>
                    <select class="form-select" id="alterEgo" name="alter_ego_id">
                        <option value="0">Select an alter-ego</option>
                        <!-- Options will be loaded dynamically with JavaScript -->
                    </select>
                    <div id="alterEgoDetails" class="mt-3">
                        <!-- Alter-ego details will be displayed here -->
                    </div>
                    <div class="d-flex align-items-center mt-2">
                        <button type="button" class="btn btn-secondary" id="createAlterEgoButton">Create New Alter-Ego</button>
                        <span class="info-icon ms-2" data-bs-toggle="tooltip" data-bs-html="true" title="
                            Create alter-egos for various purposes:
                            <ul>
                                <li>Role-playing different characters</li>
                                <li>Professional interactions</li>
                                <li>Specific hobbies or interests</li>
                                <li>Language learning personas</li>
                                <li>Creative writing voices</li>
                            </ul>
                            Alter-egos allow you to:
                            <ul>
                                <li>Customize AI interactions for different contexts</li>
                                <li>Explore fictional identities</li>
                                <li>Separate personal and professional information</li>
                                <li>Tailor AI responses to specific needs</li>
                                <li>Experiment with different communication styles</li>
                            </ul>
                            Use alter-egos to enhance your AI experience and protect your privacy when needed.
                        ">ℹ️</span>
                    </div>
                </div>
            </div>

            <div class="section-container">
                <div class="section-title">
                    After Login
                    <span class="info-icon" data-bs-toggle="tooltip" data-bs-html="true" title="Choose which page to land on after logging in.">&#8505;&#65039;</span>
                </div>
                <div class="mb-3">
                    <label class="form-label">When I log in, take me to:</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="afterLogin" id="afterLoginHome" value="/home">
                        <label class="form-check-label" for="afterLoginHome">
                            Home
                            <small class="text-muted d-block">Main page with search, favorites and library</small>
                        </label>
                    </div>
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="radio" name="afterLogin" id="afterLoginChat" value="/chat">
                        <label class="form-check-label" for="afterLoginChat">
                            Chat
                            <small class="text-muted d-block">Go straight to your conversations</small>
                        </label>
                    </div>
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="radio" name="afterLogin" id="afterLoginExplore" value="/explore">
                        <label class="form-check-label" for="afterLoginExplore">
                            Explore
                            <small class="text-muted d-block">Browse and discover public products</small>
                        </label>
                    </div>
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="radio" name="afterLogin" id="afterLoginDashboard" value="/dashboard">
                        <label class="form-check-label" for="afterLoginDashboard">
                            Dashboard
                            <small class="text-muted d-block">Stats, usage and account overview</small>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Web Search -->
            <div class="section-container" id="webSearchSection">
                <div class="section-title">
                    <i class="fas fa-search me-2"></i>Web Search
                </div>

                <div class="mb-3">
                    <label class="form-label">Search engine</label>
                    <div class="ws-engine-options">
                        <label class="ws-engine-option" id="wsEngineNative">
                            <input type="radio" name="wsEngine" value="native">
                            <div>
                                <div class="ws-engine-label">Native <span class="ws-badge-rec">Recommended</span></div>
                                <div class="ws-engine-desc">Uses the AI model's built-in web search. Faster and more integrated with the conversation.</div>
                            </div>
                        </label>
                        <label class="ws-engine-option" id="wsEnginePerplexity">
                            <input type="radio" name="wsEngine" value="perplexity">
                            <div>
                                <div class="ws-engine-label">Perplexity</div>
                                <div class="ws-engine-desc">Uses Perplexity as external search engine. Separate service.</div>
                            </div>
                        </label>
                    </div>
                </div>



            </div>

            {% if can_change_password %}
            <!-- Change Password -->
            <div class="section-container">
                <div class="section-title">
                    <i class="fas fa-lock me-2"></i>Change Password
                </div>
                <div>
                    <div class="flex-row">
                        <div class="flex-column">
                            <div class="mb-3">
                                <label for="old-password" class="form-label">Current Password</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="old-password" name="old_password">
                                    <button class="btn btn-show-password" type="button" onclick="togglePassword('old-password', this)">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <small class="form-text text-muted">Required to verify your identity</small>
                            </div>
                        </div>
                    </div>
                    <div class="flex-row">
                        <div class="flex-column">
                            <div class="mb-3">
                                <label for="new-password" class="form-label">New Password</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="new-password" name="new_password"
                                           minlength="6" oninput="checkPasswordStrength()">
                                    <button class="btn btn-show-password" type="button" onclick="togglePassword('new-password', this)">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <ul class="password-requirements mt-2 list-unstyled">
                                    <li id="req-length" class="invalid">At least 6 characters</li>
                                    <li id="req-different" class="invalid">Different from current password</li>
                                </ul>
                            </div>
                        </div>
                        <div class="flex-column">
                            <div class="mb-3">
                                <label for="confirm-password" class="form-label">Confirm New Password</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="confirm-password"
                                           oninput="checkPasswordMatch()">
                                    <button class="btn btn-show-password" type="button" onclick="togglePassword('confirm-password', this)">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <div id="password-match-status" class="password-match"></div>
                            </div>
                        </div>
                    </div>
                    <div id="pw-error-message" class="alert alert-danger" style="display: none;">
                        <i class="fas fa-exclamation-circle me-2"></i><span id="pw-error-text"></span>
                    </div>
                    <div id="pw-success-message" class="alert alert-success" style="display: none;">
                        <i class="fas fa-check-circle me-2"></i><span id="pw-success-text"></span>
                    </div>
                    <button type="button" class="btn btn-primary" id="changePasswordBtn">
                        <i class="fas fa-save me-1"></i> Change Password
                    </button>
                </div>
            </div>
            {% endif %}

            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    {% if is_manager|default(false) or is_admin|default(false) %}
                    <a href="/curation-settings" class="btn btn-outline-secondary ms-2">
                        <i class="fas fa-layer-group"></i> Curation Settings
                    </a>
                    {% endif %}
                </div>
                <a href="#" id="deleteAccountBtn" class="text-danger">Delete my account</a>
            </div>
        </form>

        <!-- Modal for Alter-Ego -->
        <div class="modal fade" id="alterEgoModal" tabindex="-1" aria-labelledby="alterEgoModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="alterEgoModalLabel">Create/Edit Alter-Ego</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="alterEgoForm">
                            <input type="hidden" id="alterEgoId" name="id">
                            <div class="mb-3">
                                <label for="alterEgoName" class="form-label">Name</label>
                                <input type="text" class="form-control" id="alterEgoName" name="name" required>
                            </div>
                            <div class="mb-3">
                                <label for="alterEgoDescription" class="form-label">Description</label>
                                <textarea class="form-control" id="alterEgoDescription" name="description" rows="3"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="alterEgoProfilePicture" class="form-label">Profile Picture</label>
                                <div class="avatar-wrapper">
                                    <div class="avatar-container" id="alterEgoPictureContainer">
                                        <span class="avatar-initial" id="defaultAlterEgoInitial">P</span>
                                        <div class="avatar-icons">
                                            <span class="avatar-icon edit"><i class="fas fa-pencil-alt"></i></span>
                                        </div>
                                    </div>
                                    <div class="avatar-preview hidden" id="previewAlterContainer">
                                        <img id="previewAlterEgoImage" alt="Preview">
                                        <div class="avatar-icons">
                                            <span class="avatar-icon edit"><i class="fas fa-pencil-alt"></i></span>
                                            <span class="avatar-icon cancel"><i class="fas fa-times"></i></span>
                                        </div>
                                    </div>
                                    <input type="file" id="alterEgoProfilePicture" name="profile_picture" accept="image/*">
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="saveAlterEgo">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== Usage & Billing Tab ==================== -->
    <div class="tab-pane fade" id="usage" role="tabpanel" aria-labelledby="usage-tab">
        <!-- Current Balance -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="stat-card success">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                        <div>
                            <div class="label"><i class="fas fa-wallet me-1"></i>Current Balance</div>
                            <div class="amount" id="usageCurrentBalance">$0.00</div>
                        </div>
                        <a href="/payment" class="btn btn-success">
                            <i class="fas fa-plus me-1"></i> Add Funds
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters-row">
            <div class="filter-group">
                <label>Time Period</label>
                <select id="usageDateRange" onchange="loadUsageData()">
                    <option value="7">Last 7 days</option>
                    <option value="30" selected>Last 30 days</option>
                    <option value="90">Last 90 days</option>
                    <option value="all">All time</option>
                </select>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3 col-6 mb-3">
                <div class="stat-card primary">
                    <div class="label"><i class="fas fa-bolt me-1"></i>Total Operations</div>
                    <div class="amount" id="statOperations">-</div>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
                <div class="stat-card info">
                    <div class="label"><i class="fas fa-microchip me-1"></i>Tokens Used</div>
                    <div class="amount" id="statTokens">-</div>
                    <div class="subtext" id="statTokensBreakdown">-</div>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
                <div class="stat-card warning">
                    <div class="label"><i class="fas fa-receipt me-1"></i>Total Spent</div>
                    <div class="amount" id="statCost">-</div>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
                <div class="stat-card success">
                    <div class="label"><i class="fas fa-calendar-day me-1"></i>Avg. Daily</div>
                    <div class="amount" id="statAvgDaily">-</div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Usage by Type -->
            <div class="col-lg-5 mb-4">
                <div class="section-container h-100">
                    <div class="section-title"><i class="fas fa-chart-pie me-2"></i>Usage by Type</div>
                    <div id="usageByType">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-spinner fa-spin me-2"></i>Loading...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Spending Trend Chart -->
            <div class="col-lg-7 mb-4">
                <div class="section-container h-100">
                    <div class="section-title"><i class="fas fa-chart-area me-2"></i>Spending Trend</div>
                    <div class="chart-container">
                        <canvas id="usageSpendingChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Daily Breakdown -->
        <div class="section-container">
            <div class="section-title"><i class="fas fa-calendar-alt me-2"></i>Recent Activity</div>
            <div id="usageDailyBreakdown">
                <div class="text-center text-muted py-4">
                    <i class="fas fa-spinner fa-spin me-2"></i>Loading...
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== API Keys Tab ==================== -->
    <div class="tab-pane fade" id="api-keys" role="tabpanel" aria-labelledby="api-keys-tab">
        {% if api_key_mode == 'system_only' %}
        <!-- User cannot configure own keys - show info message -->
        <div class="alert alert-info">
            <h4><i class="fas fa-info-circle"></i> System API Keys</h4>
            <p>Your account is configured to use the platform's API keys. You don't need to configure anything.</p>
            <a href="/chat" class="btn btn-primary">Go to Chat</a>
        </div>
        {% else %}

        {% if requires_own_keys %}
        <div class="alert alert-warning mb-4">
            <h5><i class="fas fa-exclamation-triangle"></i> API Keys Required</h5>
            <p class="mb-0">Your account requires you to configure your own API keys to use AI services.
            Please configure at least one provider below.</p>
        </div>
        {% endif %}

        <!-- Storage Mode Selection -->
        <div class="section-container">
            <div class="section-title">
                <i class="fas fa-database"></i> Storage Mode
                <span class="info-icon" data-bs-toggle="tooltip" data-bs-html="true" title="
                    <strong>Session Only:</strong> Keys are stored temporarily and cleared when you close the browser tab.<br><br>
                    <strong>Browser Persistent:</strong> Keys are stored in your browser and persist across sessions.<br><br>
                    <strong>Server:</strong> Keys are encrypted and stored on the server, accessible from any device.
                "><i class="fas fa-info-circle"></i></span>
            </div>

            <div class="storage-mode-selector">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="storageMode" id="modeSession" value="session" checked>
                    <label class="form-check-label" for="modeSession">
                        <i class="fas fa-clock"></i> Session Only
                        <small class="text-muted d-block">Keys are cleared when you close the tab</small>
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="storageMode" id="modePersistent" value="persistent">
                    <label class="form-check-label" for="modePersistent">
                        <i class="fas fa-laptop"></i> Browser Persistent
                        <small class="text-muted d-block">Keys remain in this browser until deleted</small>
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="storageMode" id="modeServer" value="server">
                    <label class="form-check-label" for="modeServer">
                        <i class="fas fa-server"></i> Server Storage
                        <small class="text-muted d-block">Keys are encrypted and stored on the server</small>
                    </label>
                </div>
            </div>

            <div class="alert alert-info mt-3" id="storageInfo">
                <i class="fas fa-shield-alt"></i>
                <span id="storageInfoText">Your keys are stored only for this browser session and will be cleared when you close the tab.</span>
            </div>
        </div>

        <!-- API Keys Form -->
        <div class="section-container">
            <div class="section-title">
                <i class="fas fa-plug"></i> API Keys
            </div>

            <form id="apiKeysForm">
                <!-- OpenAI -->
                <div class="api-key-row">
                    <div class="provider-icon" style="background: linear-gradient(135deg, #10a37f, #0d8c6b);">O</div>
                    <div class="provider-info">
                        <div class="provider-name">OpenAI</div>
                        <div class="provider-desc">GPT-4, GPT-4o, DALL-E, TTS</div>
                    </div>
                    <div class="api-key-input-group">
                        <input type="password" class="form-control" id="key-openai" placeholder="sk-..." autocomplete="off">
                        <button type="button" class="btn btn-outline-secondary btn-sm toggle-visibility" data-target="key-openai" title="Toggle visibility">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <span class="status-indicator" id="status-openai"></span>
                    <button type="button" class="btn btn-outline-primary btn-sm test-btn" data-provider="openai">Test</button>
                    <button type="button" class="btn btn-outline-danger btn-sm clear-btn" data-provider="openai" title="Clear"><i class="fas fa-times"></i></button>
                    <a href="https://platform.openai.com/api-keys" target="_blank" class="provider-link" title="Get API Key"><i class="fas fa-external-link-alt"></i></a>
                </div>

                <!-- Anthropic -->
                <div class="api-key-row">
                    <div class="provider-icon" style="background: linear-gradient(135deg, #d97706, #b45309);">A</div>
                    <div class="provider-info">
                        <div class="provider-name">Anthropic</div>
                        <div class="provider-desc">Claude 3.5, Claude 3.7</div>
                    </div>
                    <div class="api-key-input-group">
                        <input type="password" class="form-control" id="key-anthropic" placeholder="sk-ant-..." autocomplete="off">
                        <button type="button" class="btn btn-outline-secondary btn-sm toggle-visibility" data-target="key-anthropic" title="Toggle visibility">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <span class="status-indicator" id="status-anthropic"></span>
                    <button type="button" class="btn btn-outline-primary btn-sm test-btn" data-provider="anthropic">Test</button>
                    <button type="button" class="btn btn-outline-danger btn-sm clear-btn" data-provider="anthropic" title="Clear"><i class="fas fa-times"></i></button>
                    <a href="https://console.anthropic.com/settings/keys" target="_blank" class="provider-link" title="Get API Key"><i class="fas fa-external-link-alt"></i></a>
                </div>

                <!-- Google -->
                <div class="api-key-row">
                    <div class="provider-icon" style="background: linear-gradient(135deg, #4285f4, #2a65c9);">G</div>
                    <div class="provider-info">
                        <div class="provider-name">Google AI</div>
                        <div class="provider-desc">Gemini Pro, Gemini Ultra</div>
                    </div>
                    <div class="api-key-input-group">
                        <input type="password" class="form-control" id="key-google" placeholder="AIza..." autocomplete="off">
                        <button type="button" class="btn btn-outline-secondary btn-sm toggle-visibility" data-target="key-google" title="Toggle visibility">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <span class="status-indicator" id="status-google"></span>
                    <button type="button" class="btn btn-outline-primary btn-sm test-btn" data-provider="google">Test</button>
                    <button type="button" class="btn btn-outline-danger btn-sm clear-btn" data-provider="google" title="Clear"><i class="fas fa-times"></i></button>
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="provider-link" title="Get API Key"><i class="fas fa-external-link-alt"></i></a>
                </div>

                <!-- xAI -->
                <div class="api-key-row">
                    <div class="provider-icon" style="background: linear-gradient(135deg, #1a1a2e, #333355);">X</div>
                    <div class="provider-info">
                        <div class="provider-name">xAI</div>
                        <div class="provider-desc">Grok</div>
                    </div>
                    <div class="api-key-input-group">
                        <input type="password" class="form-control" id="key-xai" placeholder="xai-..." autocomplete="off">
                        <button type="button" class="btn btn-outline-secondary btn-sm toggle-visibility" data-target="key-xai" title="Toggle visibility">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <span class="status-indicator" id="status-xai"></span>
                    <button type="button" class="btn btn-outline-primary btn-sm test-btn" data-provider="xai">Test</button>
                    <button type="button" class="btn btn-outline-danger btn-sm clear-btn" data-provider="xai" title="Clear"><i class="fas fa-times"></i></button>
                    <a href="https://console.x.ai/" target="_blank" class="provider-link" title="Get API Key"><i class="fas fa-external-link-alt"></i></a>
                </div>

                <!-- ElevenLabs -->
                <div class="api-key-row">
                    <div class="provider-icon" style="background: linear-gradient(135deg, #6a4fc9, #5235a8);">E</div>
                    <div class="provider-info">
                        <div class="provider-name">ElevenLabs</div>
                        <div class="provider-desc">Text-to-Speech, Voice Cloning</div>
                    </div>
                    <div class="api-key-input-group">
                        <input type="password" class="form-control" id="key-elevenlabs" placeholder="Enter your ElevenLabs API key" autocomplete="off">
                        <button type="button" class="btn btn-outline-secondary btn-sm toggle-visibility" data-target="key-elevenlabs" title="Toggle visibility">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <span class="status-indicator" id="status-elevenlabs"></span>
                    <button type="button" class="btn btn-outline-primary btn-sm test-btn" data-provider="elevenlabs">Test</button>
                    <button type="button" class="btn btn-outline-danger btn-sm clear-btn" data-provider="elevenlabs" title="Clear"><i class="fas fa-times"></i></button>
                    <a href="https://elevenlabs.io/app/settings/api-keys" target="_blank" class="provider-link" title="Get API Key"><i class="fas fa-external-link-alt"></i></a>
                </div>
            </form>

            <!-- Actions -->
            <div class="d-flex gap-2 mt-4 pt-2">
                <button type="button" class="btn btn-outline-primary" id="testAllCredentials">
                    <i class="fas fa-vial me-1"></i> Test All
                </button>
                <button type="button" class="btn btn-primary" id="saveAllCredentials">
                    <i class="fas fa-save me-1"></i> Save All
                </button>
                <button type="button" class="btn btn-outline-danger ms-auto" id="clearAllCredentials">
                    <i class="fas fa-trash-alt me-1"></i> Clear All
                </button>
            </div>
        </div>

        <!-- Security Notice -->
        <div class="alert alert-warning">
            <h5><i class="fas fa-exclamation-triangle"></i> Security Information</h5>
            <ul class="mb-0">
                <li>Your API keys are transmitted securely over HTTPS when making AI requests.</li>
                <li>In <strong>Session</strong> and <strong>Browser</strong> modes, keys are never stored on the server.</li>
                <li>In <strong>Server</strong> mode, keys are encrypted before storage using AES-256 encryption.</li>
                <li>Never share your API keys with anyone.</li>
                <li>You can revoke and regenerate keys from each provider's dashboard if compromised.</li>
            </ul>
        </div>
        {% endif %}
    </div>

</div>
{% endblock %}

{% block scripts %}
<script src="{{ get_static_url('/static/js/edit_profile.js') }}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.13/js/intlTelInput.min.js"></script>
{% if api_key_mode != 'system_only' %}
<script src="{{ get_static_url('/static/js/api-credentials.js') }}"></script>
{% endif %}
<script src="{{ get_static_url('/static/js/settings.js') }}"></script>
{% endblock %}

{% block scripts_inline %}
<script>
    let currentAlterEgoId = "{{ user_data['current_alter_ego_id'] }}";
    let currentUserVoiceId = "{{ current_user_voice_id }}";
    let currentUserId = "{{ current_user_id }}";
    let originalPhoneNumber = "{{ user_data['phone_number'] }}";
    let homePreferences = {{ home_preferences | tojson }};

    {% if can_change_password %}
    // Change password functions
    function togglePassword(inputId, button) {
        const input = document.getElementById(inputId);
        const icon = button.querySelector('i');
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }

    function checkPasswordStrength() {
        const newPassword = document.getElementById('new-password').value;
        const oldPassword = document.getElementById('old-password').value;

        const reqLength = document.getElementById('req-length');
        if (newPassword.length >= 6) {
            reqLength.classList.remove('invalid');
            reqLength.classList.add('valid');
        } else {
            reqLength.classList.remove('valid');
            reqLength.classList.add('invalid');
        }

        const reqDifferent = document.getElementById('req-different');
        if (newPassword && oldPassword && newPassword !== oldPassword) {
            reqDifferent.classList.remove('invalid');
            reqDifferent.classList.add('valid');
        } else if (newPassword && oldPassword && newPassword === oldPassword) {
            reqDifferent.classList.remove('valid');
            reqDifferent.classList.add('invalid');
        }

        checkPasswordMatch();
    }

    function checkPasswordMatch() {
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        const statusDiv = document.getElementById('password-match-status');

        if (!confirmPassword) {
            statusDiv.textContent = '';
            statusDiv.className = 'password-match';
            return;
        }

        if (newPassword === confirmPassword) {
            statusDiv.innerHTML = '<i class="fas fa-check me-1"></i>Passwords match';
            statusDiv.className = 'password-match match';
        } else {
            statusDiv.innerHTML = '<i class="fas fa-times me-1"></i>Passwords do not match';
            statusDiv.className = 'password-match no-match';
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const oldPwInput = document.getElementById('old-password');
        if (oldPwInput) oldPwInput.addEventListener('input', checkPasswordStrength);

        const changeBtn = document.getElementById('changePasswordBtn');
        if (changeBtn) {
            changeBtn.addEventListener('click', async function() {
                const oldPassword = document.getElementById('old-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                const errorDiv = document.getElementById('pw-error-message');
                const errorText = document.getElementById('pw-error-text');
                const successDiv = document.getElementById('pw-success-message');
                const successText = document.getElementById('pw-success-text');

                errorDiv.style.display = 'none';
                successDiv.style.display = 'none';

                if (!oldPassword || !newPassword || !confirmPassword) {
                    errorText.textContent = 'Please fill in all password fields.';
                    errorDiv.style.display = 'block';
                    return;
                }
                if (newPassword !== confirmPassword) {
                    errorText.textContent = 'Passwords do not match.';
                    errorDiv.style.display = 'block';
                    return;
                }
                if (newPassword.length < 6) {
                    errorText.textContent = 'Password must be at least 6 characters.';
                    errorDiv.style.display = 'block';
                    return;
                }
                if (newPassword === oldPassword) {
                    errorText.textContent = 'New password must be different from current password.';
                    errorDiv.style.display = 'block';
                    return;
                }

                changeBtn.disabled = true;
                changeBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Changing...';

                try {
                    const formData = new URLSearchParams();
                    formData.append('old_password', oldPassword);
                    formData.append('new_password', newPassword);

                    const response = await fetch('/api/change-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: formData
                    });

                    if (response.ok) {
                        successText.textContent = 'Password changed successfully!';
                        successDiv.style.display = 'block';
                        document.getElementById('old-password').value = '';
                        document.getElementById('new-password').value = '';
                        document.getElementById('confirm-password').value = '';
                        document.getElementById('password-match-status').textContent = '';
                        document.getElementById('req-length').className = 'invalid';
                        document.getElementById('req-different').className = 'invalid';
                    } else {
                        const data = await response.json();
                        if (response.status === 400 && data.detail === "Current password is incorrect") {
                            errorText.textContent = 'Current password is incorrect.';
                        } else if (data.detail) {
                            errorText.textContent = data.detail;
                        } else {
                            errorText.textContent = 'Error changing password. Please try again.';
                        }
                        errorDiv.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error:', error);
                    errorText.textContent = 'An unexpected error occurred. Please try again.';
                    errorDiv.style.display = 'block';
                } finally {
                    changeBtn.disabled = false;
                    changeBtn.innerHTML = '<i class="fas fa-save me-1"></i> Change Password';
                }
            });
        }
    });
    {% endif %}

    // --- Web Search settings (load + UI interactions, save triggered by edit_profile.js on form submit) ---
    (async function initWebSearchSettings() {
        const engineNative = document.getElementById('wsEngineNative');
        const enginePerplexity = document.getElementById('wsEnginePerplexity');
        const radioNative = engineNative?.querySelector('input[type="radio"]');
        const radioPerplexity = enginePerplexity?.querySelector('input[type="radio"]');

        if (!radioNative) return;

        // Load current settings from API
        try {
            const res = await fetch('/api/user/web-search-settings');
            if (res.ok) {
                const data = await res.json();
                if (data.web_search_mode === 'native') {
                    radioNative.checked = true;
                    engineNative.classList.add('active');
                } else {
                    radioPerplexity.checked = true;
                    enginePerplexity.classList.add('active');
                }
                if (!data.perplexity_available) {
                    enginePerplexity.classList.add('disabled');
                    enginePerplexity.querySelector('.ws-engine-desc').textContent = 'Not available on this server.';
                }
            }
        } catch (e) {
            console.error('Failed to load web search settings', e);
        }

        // Engine selection (visual toggle only, saved on form submit)
        [radioNative, radioPerplexity].forEach(radio => {
            radio.addEventListener('change', function() {
                engineNative.classList.toggle('active', radioNative.checked);
                enginePerplexity.classList.toggle('active', radioPerplexity.checked);
            });
        });
        enginePerplexity.addEventListener('click', function(e) {
            if (this.classList.contains('disabled')) e.preventDefault();
        });
    })();
</script>
{% endblock %}
