{% extends 'base_admin.html' %}

{% block title %}Watchdog Events - SPARK{% endblock %}

{% block page_title %}Watchdog Events{% endblock %}

{% block page_subtitle %}
<p class="page-subtitle">Monitor conversation steering events and diagnostics</p>
{% endblock %}

{% block alerts %}
{% if error %}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="fas fa-exclamation-circle me-2"></i>{{ error }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}
{% endblock %}

{% block content %}
{% set base_query = "per_page=" ~ per_page ~ ("&event_type=" ~ filters.event_type if filters.event_type else "") ~ ("&severity=" ~ filters.severity if filters.severity else "") ~ ("&prompt_id=" ~ filters.prompt_id if filters.prompt_id else "") ~ ("&conversation_id=" ~ filters.conversation_id if filters.conversation_id else "") %}

<!-- Stats -->
<div class="stats-row">
    <span class="stat-badge">
        <i class="fas fa-list-check"></i>
        {% if events|length > 0 %}
            {% set start = (page - 1) * per_page + 1 %}
            {% set end = start + events|length - 1 %}
            Showing <strong>{{ start }}-{{ end }}</strong> of <strong>{{ total_events }}</strong>
        {% else %}
            <strong>0</strong> events
        {% endif %}
    </span>
    <span class="stat-badge">
        <i class="fas fa-bolt"></i> <strong>{{ stats.hints }}</strong> Hints generated
    </span>
    <span class="stat-badge">
        <i class="fas fa-bug"></i> <strong>{{ stats.errors }}</strong> Errors
    </span>
</div>

<!-- Filters -->
<div class="section-container">
    <div class="section-title">
        <i class="fas fa-filter"></i> Filters
    </div>
    <form method="get" action="/admin/watchdog-events" id="filterForm">
        <input type="hidden" name="page" value="1">
        <div class="flex-row">
            <div class="flex-column">
                <div class="mb-3">
                    <label class="form-label" for="filter_event_type">Event Type</label>
                    <select class="form-select" id="filter_event_type" name="event_type" onchange="this.form.submit()">
                        <option value="">All types</option>
                        {% for et in event_types %}
                        <option value="{{ et }}" {% if filters.event_type == et %}selected{% endif %}>{{ et }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="flex-column">
                <div class="mb-3">
                    <label class="form-label" for="filter_severity">Severity</label>
                    <select class="form-select" id="filter_severity" name="severity" onchange="this.form.submit()">
                        <option value="">All severities</option>
                        {% for sev in severities %}
                        <option value="{{ sev }}" {% if filters.severity == sev %}selected{% endif %}>{{ sev }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="flex-column">
                <div class="mb-3">
                    <label class="form-label" for="filter_prompt_id">Prompt</label>
                    <select class="form-select" id="filter_prompt_id" name="prompt_id" onchange="this.form.submit()">
                        <option value="">All prompts</option>
                        {% for p in prompts %}
                        <option value="{{ p.id }}" {% if filters.prompt_id == p.id %}selected{% endif %}>{{ p.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="flex-column">
                <div class="mb-3">
                    <label class="form-label" for="filter_conversation_id">Conversation ID</label>
                    <input class="form-control" id="filter_conversation_id" name="conversation_id"
                           value="{{ filters.conversation_id or '' }}"
                           placeholder="Filter by conv ID" type="number" min="1">
                </div>
            </div>
            <input type="hidden" name="per_page" value="{{ per_page }}">
        </div>
        <div class="mt-2 d-flex gap-2">
            <button type="submit" class="btn btn-primary btn-sm">
                <i class="fas fa-search me-1"></i> Apply
            </button>
            <a href="/admin/watchdog-events" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-times me-1"></i> Clear
            </a>
        </div>
    </form>
</div>

<!-- Events Table -->
<div class="section-container">
    <div class="section-title" style="display: flex; align-items: center; justify-content: space-between;">
        <span><i class="fas fa-eye"></i> Events</span>
        <span class="btn-group btn-group-sm" role="group" aria-label="Events per page" style="font-weight: 400;">
            {% for n in [25, 50, 100] %}
            <a href="/admin/watchdog-events?{{ base_query|replace('per_page=' ~ per_page, 'per_page=' ~ n) }}&page=1"
               class="btn btn-outline-secondary{% if per_page == n %} active{% endif %}" style="font-size: 0.75rem; padding: 2px 10px;">{{ n }}</a>
            {% endfor %}
        </span>
    </div>
    <div class="table-wrapper">
        <table class="table">
            <thead>
                <tr>
                    <th style="width: 140px;">Date</th>
                    <th style="width: 80px;">Conv</th>
                    <th>Prompt</th>
                    <th style="width: 110px;">Event</th>
                    <th style="width: 80px;">Severity</th>
                    <th>Analysis</th>
                    <th>Hint</th>
                    <th style="width: 100px;">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for event in events %}
                <tr>
                    <td><small>{{ event.created_at }}</small></td>
                    <td>
                        <span title="{{ event.chat_name or '' }}" data-bs-toggle="tooltip">
                            {{ event.conversation_id }}
                        </span>
                    </td>
                    <td><small>{{ event.prompt_name or ('-') }}</small></td>
                    <td>
                        {% if event.event_type == 'none' %}
                        <span class="badge bg-secondary">none</span>
                        {% elif event.event_type == 'error' %}
                        <span class="badge bg-danger">error</span>
                        {% elif event.event_type == 'drift' %}
                        <span class="badge bg-warning text-dark">drift</span>
                        {% elif event.event_type == 'rabbit_hole' %}
                        <span class="badge bg-warning text-dark">rabbit_hole</span>
                        {% elif event.event_type == 'stuck' %}
                        <span class="badge bg-info text-dark">stuck</span>
                        {% elif event.event_type == 'inconsistency' %}
                        <span class="badge bg-danger">inconsistency</span>
                        {% elif event.event_type == 'saturation' %}
                        <span class="badge bg-info text-dark">saturation</span>
                        {% elif event.event_type == 'security' %}
                        <span class="badge bg-dark">security</span>
                        {% else %}
                        <span class="badge bg-secondary">{{ event.event_type }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if event.severity == 'info' %}
                        <span class="badge bg-secondary">info</span>
                        {% elif event.severity == 'nudge' %}
                        <span class="badge bg-primary">nudge</span>
                        {% elif event.severity == 'redirect' %}
                        <span class="badge bg-warning text-dark">redirect</span>
                        {% elif event.severity == 'alert' %}
                        <span class="badge bg-danger">alert</span>
                        {% else %}
                        <span class="badge bg-secondary">{{ event.severity }}</span>
                        {% endif %}
                    </td>
                    <td><small class="text-break">{{ event.analysis[:200] if event.analysis else '-' }}{% if event.analysis and event.analysis|length > 200 %}...{% endif %}</small></td>
                    <td><small class="text-break">{{ event.hint[:150] if event.hint else '-' }}{% if event.hint and event.hint|length > 150 %}...{% endif %}</small></td>
                    <td>
                        {% if event.action_taken == 'hint_generated' %}
                        <span class="badge bg-success">hint</span>
                        {% elif event.action_taken == 'error' %}
                        <span class="badge bg-danger">error</span>
                        {% elif event.action_taken == 'blocked' %}
                        <span class="badge bg-dark">blocked</span>
                        {% else %}
                        <span class="badge bg-secondary">none</span>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="text-center text-muted py-4">
                        <i class="fas fa-eye fa-2x mb-2 d-block opacity-50"></i>
                        No watchdog events found.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
    <nav aria-label="Watchdog events pagination" class="mt-3">
        <ul class="pagination justify-content-center mb-0">
            <!-- Previous -->
            <li class="page-item {% if page <= 1 %}disabled{% endif %}">
                <a class="page-link" href="/admin/watchdog-events?{{ base_query }}&page={{ page - 1 }}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>

            <!-- Page 1 always shown -->
            <li class="page-item {% if page == 1 %}active{% endif %}">
                <a class="page-link" href="/admin/watchdog-events?{{ base_query }}&page=1">1</a>
            </li>

            <!-- Left ellipsis -->
            {% if page > 4 %}
            <li class="page-item disabled">
                <span class="page-link">...</span>
            </li>
            {% endif %}

            <!-- Neighbor pages around current (skip 1 and total_pages, shown separately) -->
            {% for p in range([page - 2, 2]|max, [page + 3, total_pages]|min) %}
            <li class="page-item {% if p == page %}active{% endif %}">
                <a class="page-link" href="/admin/watchdog-events?{{ base_query }}&page={{ p }}">{{ p }}</a>
            </li>
            {% endfor %}

            <!-- Right ellipsis -->
            {% if page < total_pages - 3 %}
            <li class="page-item disabled">
                <span class="page-link">...</span>
            </li>
            {% endif %}

            <!-- Last page (if more than 1 page) -->
            {% if total_pages > 1 %}
            <li class="page-item {% if page == total_pages %}active{% endif %}">
                <a class="page-link" href="/admin/watchdog-events?{{ base_query }}&page={{ total_pages }}">{{ total_pages }}</a>
            </li>
            {% endif %}

            <!-- Next -->
            <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
                <a class="page-link" href="/admin/watchdog-events?{{ base_query }}&page={{ page + 1 }}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
        </ul>
    </nav>
    {% endif %}
</div>
{% endblock %}
