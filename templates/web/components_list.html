{% extends 'base.html' %}

{% block title %}Components List - {{ prompt_name }}{% endblock %}

{% block styles %}
<style>
    body {
        background-color: #f8f9fa;
    }
    .card {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }
    .card:hover {
        box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }
    .list-group-item {
        transition: background-color 0.2s ease;
    }
    .list-group-item:hover {
        background-color: #f1f3f5;
    }
    .component-type-options {
        display: none;
        margin-top: 10px;
    }
    .image-preview img {
        max-width: 100px;
        margin-right: 10px;
    }
</style>
{% endblock %}

{% block header %}{% endblock %}
{% block toolbar %}{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h2 class="mb-0"><i class="fas fa-puzzle-piece me-2"></i>Components for {{ prompt_name }}</h2>
                </div>
                <div class="card-body">
                    <ul class="list-group">
                        {% for component_type, components in components_by_type.items() %}
                        <li class="list-group-item">
                            <h5>{{ component_type|upper }} Components</h5>
                            <ul class="list-group list-group-flush">
                                {% for component in components %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span><i class="fas fa-code me-2"></i>{{ component }}</span>
                                    <a href="/landing/{{ prompt_id }}/components/{{ component_type }}/{{ component }}/edit" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-edit me-1"></i>Edit
                                    </a>
                                </li>
                                {% endfor %}
                            </ul>
                        </li>
                        {% endfor %}
                    </ul>

                    <form id="addComponentForm" class="mt-4">
                        <div class="input-group">
                            <input type="text" name="component_name" class="form-control" placeholder="New component name" required>
                            <button type="button" class="btn btn-success" id="showComponentTypeOptions">
                                <i class="fas fa-plus me-1"></i>Create New Component
                            </button>
                        </div>
                        <div class="component-type-options" id="componentTypeOptions">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="component_type" id="htmlType" value="html" required>
                                <label class="form-check-label" for="htmlType">
                                    HTML
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="component_type" id="cssType" value="css" required>
                                <label class="form-check-label" for="cssType">
                                    CSS
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="component_type" id="jsType" value="js" required>
                                <label class="form-check-label" for="jsType">
                                    JavaScript
                                </label>
                            </div>
                            <button type="submit" class="btn btn-primary mt-2">
                                Create Component
                            </button>
                        </div>
                    </form>

                <!-- Modify image upload section -->
                    <div class="card mt-4">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="fas fa-image me-2"></i>Upload Images</h5>
                        </div>
                        <div class="card-body">
                            <form id="imageUploadForm" enctype="multipart/form-data">
                                <div class="mb-3">
                                    <label for="imageUpload" class="form-label">Select Image(s)</label>
                                    <input type="file" class="form-control" id="imageUpload" name="images" accept="image/*" required multiple>
                                </div>
                                <div id="imageNames"></div>
                                <div class="mb-3">
                                    <label for="imagePreview" class="form-label">Preview</label>
                                    <div id="imagePreview" class="image-preview"></div>
                                </div>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-upload me-1"></i>Upload Image(s)
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Modify uploaded images section -->
                    <div class="card mt-4">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="fas fa-images me-2"></i>Uploaded Images</h5>
                        </div>
                        <div class="card-body">
                            <div id="uploadedImagesContainer" class="row">
                                <!-- Images will be loaded dynamically here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center mt-4">
            <a href="/" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-1"></i>Back to Admin Index
            </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_inline %}
<script>
    document.getElementById('showComponentTypeOptions').addEventListener('click', function() {
        document.getElementById('componentTypeOptions').style.display = 'block';
        this.style.display = 'none';
    });

    // Handle add component form submission
    document.getElementById('addComponentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const componentName = this.querySelector('input[name="component_name"]').value.trim();
        const componentType = this.querySelector('input[name="component_type"]:checked')?.value;

        if (!componentName || !componentType) {
            NotificationModal.warning('Missing Information', 'Please enter a component name and select a type');
            return;
        }

        fetch('/api/landing/{{ prompt_id }}/components', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ component_name: componentName, component_type: componentType })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            } else {
                NotificationModal.error('Error', data.message || 'Error creating component');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            NotificationModal.error('Error', 'Error creating component');
        });
    });

    document.getElementById('imageUpload').addEventListener('change', function(e) {
        const imageNames = document.getElementById('imageNames');
        const imagePreview = document.getElementById('imagePreview');
        imageNames.innerHTML = '';
        imagePreview.innerHTML = '';
        for (let i = 0; i < this.files.length; i++) {
            const file = this.files[i];
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.name = 'names';
            nameInput.className = 'form-control mt-2';
            nameInput.value = file.name.split('.')[0];  // Filename without extension
            nameInput.placeholder = `Name for ${file.name}`;
            imageNames.appendChild(nameInput);

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.alt = file.name;
                imagePreview.appendChild(img);
            }
            reader.readAsDataURL(file);
        }
    });

    document.getElementById('imageUploadForm').addEventListener('submit', function(e) {
        e.preventDefault();

        var formData = new FormData(this);

        fetch('/api/landing/{{ prompt_id }}/images', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if(data.message) {
                NotificationModal.success('Upload Complete', data.message);
                updateImageList();
                resetImageUploadForm();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            NotificationModal.error('Upload Error', 'An error occurred while uploading the image');
            resetImageUploadForm();
        });
    });

    function resetImageUploadForm() {
        const imageUpload = document.getElementById('imageUpload');
        const imageNames = document.getElementById('imageNames');
        const imagePreview = document.getElementById('imagePreview');

        imageUpload.value = '';
        imageNames.innerHTML = '';
        imagePreview.innerHTML = '';
    }

    function updateImageList() {
        fetch('/api/landing/{{ prompt_id }}/images')
        .then(response => response.json())
        .then(data => {
            const imageContainer = document.getElementById('uploadedImagesContainer');
            imageContainer.innerHTML = '';

            data.images.forEach(image => {
                const imageElement = `
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=" data-src="${image.url}" class="card-img-top lazy" alt="${image.name}">
                            <div class="card-body">
                                <h6 class="card-title">${image.name}</h6>
                                <button onclick="deleteImage('${image.id}')" class="btn btn-danger btn-sm">
                                    <i class="fas fa-trash me-1"></i>Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                imageContainer.innerHTML += imageElement;
            });

            lazyLoadImages();
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    function deleteImage(imageId) {
        fetch(`/api/landing/{{ prompt_id }}/images/${imageId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            NotificationModal.success('Image Deleted', data.message);
            updateImageList();
        })
        .catch(error => {
            console.error('Error:', error);
            NotificationModal.error('Delete Error', 'An error occurred while deleting the image');
        });
    }

    function lazyLoadImages() {
        const images = document.querySelectorAll('img.lazy');
        const options = {
            root: null,
            rootMargin: '0px',
            threshold: 0.1
        };

        const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    img.src = img.dataset.src;
                    img.classList.remove('lazy');
                    imageObserver.unobserve(img);
                }
            });
        }, options);

        images.forEach(img => imageObserver.observe(img));
    }

    // Call updateImageList on page load to ensure images are up to date
    document.addEventListener('DOMContentLoaded', () => {
        updateImageList();
    });
</script>
{% endblock %}
