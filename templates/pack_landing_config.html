{% extends 'base_admin.html' %}

{% block title %}Landing Page - {{ pack.name }} - AURVEK{% endblock %}

{% block page_title %}Landing Page - "{{ pack.name }}"{% endblock %}
{% block page_subtitle %}<p class="page-subtitle">Manage your pack's custom landing page</p>{% endblock %}

{% block page_actions %}
<a href="/admin/packs/edit/{{ pack.id }}" class="btn btn-outline-secondary">
    <i class="fas fa-arrow-left me-1"></i> Back to Pack
</a>
{% endblock %}

{% block styles %}
<style>
    .public-url-box {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        background: var(--bg-tertiary, #202225);
        border: 1px solid var(--border-color, #40444b);
        margin-bottom: 0.5rem;
    }
    .public-url-box .url-text {
        flex: 1;
        font-family: monospace;
        font-size: 0.95rem;
        word-break: break-all;
        color: var(--text-primary, #fff);
    }
    .table-pages {
        width: 100%;
        margin-bottom: 0;
    }
    .table-pages th {
        border-bottom: 2px solid var(--border-color, #40444b);
        color: var(--text-muted, #888);
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding: 0.5rem;
    }
    .table-pages td {
        padding: 0.75rem 0.5rem;
        border-bottom: 1px solid var(--border-color, #40444b);
        vertical-align: middle;
    }
    .btn-icon {
        padding: 0.25rem 0.5rem;
        font-size: 0.85rem;
    }
    .image-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 1rem;
    }
    .image-container {
        border: 1px solid var(--border-color, #40444b);
        border-radius: 8px;
        overflow: hidden;
        background: var(--bg-tertiary, #202225);
    }
    .image-container img {
        width: 100%;
        height: 140px;
        object-fit: cover;
    }
    .image-name {
        padding: 0.5rem;
        font-size: 0.85rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: var(--text-secondary, #ccc);
    }
    .nav-tabs {
        border-bottom: 2px solid var(--border-color, #40444b);
        margin-bottom: 0;
    }
    .nav-tabs .nav-link {
        color: var(--text-muted, #888);
        border: none;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
        padding: 0.75rem 1.25rem;
    }
    .nav-tabs .nav-link:hover {
        color: var(--text-primary, #fff);
        border-bottom-color: var(--accent, #6366f1);
    }
    .nav-tabs .nav-link.active {
        color: var(--accent, #6366f1);
        background: transparent;
        border-bottom-color: var(--accent, #6366f1);
    }
    .tab-content > .tab-pane {
        padding-top: 0;
    }
    .list-group-item {
        background: var(--bg-tertiary, #202225);
        border-color: var(--border-color, #40444b);
        color: var(--text-primary, #fff);
    }
</style>
{% endblock %}

{% block content %}
        <!-- Public URL Section -->
        <div class="section-container">
            <div class="section-title">
                <i class="fas fa-link"></i> Pack Landing URL
            </div>
            <div class="public-url-box">
                <span class="url-text" id="publicUrl">{{ public_url }}</span>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="copyUrl()" title="Copy URL">
                    <i class="fas fa-copy"></i>
                </button>
                <a href="{{ public_url }}" target="_blank" class="btn btn-outline-primary btn-sm" title="Open in new tab">
                    <i class="fas fa-external-link-alt"></i>
                </a>
            </div>

            {% if not has_home_page %}
            <div class="alert alert-warning mt-3 mb-0">
                <i class="fas fa-exclamation-triangle me-2"></i>
                No <code>home.html</code> page exists yet. Create one to make your pack landing accessible.
            </div>
            {% endif %}
        </div>

        <!-- AI Wizard Section -->
        <div class="section-container text-center">
            <button type="button" class="btn btn-primary btn-lg" onclick="openAIWizard()">
                <i class="fas fa-magic me-2"></i> Generate with AI
            </button>
            <p class="text-muted mt-2 mb-0">Let AI create or modify your landing page</p>
            <small class="text-muted">
                Requires <a href="https://docs.anthropic.com/en/docs/claude-code/getting-started" target="_blank" rel="noopener">Claude Code CLI</a>
            </small>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs" id="configTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="pages-tab" data-bs-toggle="tab" data-bs-target="#pages" type="button" role="tab">
                    <i class="fas fa-file-code me-1"></i> Pages
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="components-tab" data-bs-toggle="tab" data-bs-target="#components" type="button" role="tab">
                    <i class="fas fa-puzzle-piece me-1"></i> Components
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="images-tab" data-bs-toggle="tab" data-bs-target="#images" type="button" role="tab">
                    <i class="fas fa-images me-1"></i> Images
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Pages Tab -->
            <div class="tab-pane fade show active" id="pages" role="tabpanel">
                <div class="section-container">
                        <table class="table table-pages mb-4">
                            <thead>
                                <tr>
                                    <th>Page</th>
                                    <th>URL Path</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for page in pages %}
                                <tr>
                                    <td>
                                        <i class="fas fa-file-alt text-muted me-2"></i>
                                        {{ page.name }}{% if page.is_home %} <span class="badge bg-primary">Main</span>{% endif %}
                                    </td>
                                    <td><code>{{ page.url_path }}</code></td>
                                    <td class="text-end">
                                        <a href="{{ public_url }}{{ page.name if not page.is_home else '' }}" target="_blank" class="btn btn-outline-secondary btn-sm btn-icon" title="View">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="/landing/pack/{{ pack.id }}/pages/{{ page.name }}/edit" class="btn btn-outline-primary btn-sm btn-icon" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        {% if not page.is_home %}
                                        <button type="button" class="btn btn-outline-danger btn-sm btn-icon" onclick="deletePage('{{ page.name }}')" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted py-4">
                                        No pages created yet. Add your first page below.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>

                        <!-- Add New Page -->
                        <form id="addPageForm" class="row g-2 align-items-end">
                            <div class="col-auto">
                                <label for="newPageName" class="form-label">New Page</label>
                                <input type="text" class="form-control" id="newPageName" placeholder="e.g., pricing, about" pattern="[a-zA-Z0-9_-]+" required>
                            </div>
                            <div class="col-auto">
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-plus me-1"></i> Add Page
                                </button>
                            </div>
                        </form>
                </div>
            </div>

            <!-- Components Tab -->
            <div class="tab-pane fade" id="components" role="tabpanel">
                <div class="section-container">
                        <!-- Components List -->
                        {% for type_name, component_list in components.items() %}
                        {% if component_list %}
                        <h6 class="text-uppercase text-muted mb-2">
                            {% if type_name == 'html' %}<i class="fas fa-code me-1"></i>{% elif type_name == 'css' %}<i class="fas fa-palette me-1"></i>{% else %}<i class="fas fa-cog me-1"></i>{% endif %}
                            {{ type_name }} Components
                        </h6>
                        <ul class="list-group mb-4">
                            {% for comp in component_list %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>{{ comp }}</span>
                                <div>
                                    <a href="/landing/pack/{{ pack.id }}/components/{{ type_name }}/{{ comp }}/edit" class="btn btn-outline-primary btn-sm btn-icon" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button type="button" class="btn btn-outline-danger btn-sm btn-icon" onclick="deleteComponent('{{ type_name }}', '{{ comp }}')" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                        {% endfor %}

                        {% if not components.html and not components.css and not components.js %}
                        <p class="text-center text-muted py-4">No components created yet.</p>
                        {% endif %}

                        <!-- Add New Component -->
                        <form id="addComponentForm" class="row g-2 align-items-end mt-3">
                            <div class="col-auto">
                                <label for="componentName" class="form-label">New Component</label>
                                <input type="text" name="component_name" class="form-control" id="componentName" placeholder="e.g., navbar, styles" required>
                            </div>
                            <div class="col-auto">
                                <label class="form-label">Type</label>
                                <div class="btn-group" role="group">
                                    <input type="radio" class="btn-check" name="component_type" id="typeHtml" value="html" checked>
                                    <label class="btn btn-outline-secondary" for="typeHtml">HTML</label>
                                    <input type="radio" class="btn-check" name="component_type" id="typeCss" value="css">
                                    <label class="btn btn-outline-secondary" for="typeCss">CSS</label>
                                    <input type="radio" class="btn-check" name="component_type" id="typeJs" value="js">
                                    <label class="btn btn-outline-secondary" for="typeJs">JS</label>
                                </div>
                            </div>
                            <div class="col-auto">
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-plus me-1"></i> Add Component
                                </button>
                            </div>
                        </form>
                </div>
            </div>

            <!-- Images Tab -->
            <div class="tab-pane fade" id="images" role="tabpanel">
                <div class="section-container">
                        <!-- Upload Form -->
                        <form id="imageUploadForm" enctype="multipart/form-data" class="mb-4">
                            <div class="row g-2 align-items-end">
                                <div class="col-auto">
                                    <label for="imageFiles" class="form-label">Upload Images</label>
                                    <input type="file" class="form-control" id="imageFiles" name="images" accept="image/*" multiple required>
                                </div>
                                <div class="col-auto">
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-upload me-1"></i> Upload
                                    </button>
                                </div>
                            </div>
                            <div id="imageNamesContainer" class="mt-2"></div>
                        </form>

                        <!-- Images Grid -->
                        <div id="imagesGrid" class="image-grid">
                            <!-- Images loaded dynamically -->
                        </div>
                        <p id="noImagesMsg" class="text-center text-muted py-4" style="display: none;">No images uploaded yet.</p>
                </div>
            </div>
        </div>

    <!-- Mode Selection Modal -->
    <div class="modal fade" id="modeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content" style="background: var(--bg-secondary, #1e1e1e); color: var(--text-primary, #fff);">
                <div class="modal-header" style="background: var(--accent, #6366f1); color: #fff; border-color: var(--border-color, #333);">
                    <h5 class="modal-title"><i class="fas fa-magic me-2"></i>AI Landing Page Assistant</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Files summary -->
                    <div id="modeFileSummary" class="alert alert-info mb-4">
                        <i class="fas fa-folder-open me-2"></i>
                        <span id="modeFileSummaryText">Loading files...</span>
                    </div>

                    <p class="mb-3">What would you like to do?</p>

                    <!-- Mode options -->
                    <div class="list-group">
                        <button type="button" class="list-group-item list-group-item-action" onclick="selectMode('create')">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-plus-circle text-success me-3 fa-lg"></i>
                                <div>
                                    <strong>Create new landing page</strong>
                                    <br><small class="text-muted">Generate a complete landing from scratch (replaces home.html)</small>
                                </div>
                            </div>
                        </button>
                        <button type="button" class="list-group-item list-group-item-action" id="modifyOption" onclick="selectMode('modify')">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-edit text-primary me-3 fa-lg"></i>
                                <div>
                                    <strong>Modify existing landing</strong>
                                    <br><small class="text-muted">Ask Claude to improve, add sections, or make changes</small>
                                </div>
                            </div>
                        </button>
                        <button type="button" class="list-group-item list-group-item-action" id="freshOption" onclick="selectMode('fresh')">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-trash-alt text-danger me-3 fa-lg"></i>
                                <div>
                                    <strong>Start fresh (delete all)</strong>
                                    <br><small class="text-muted">Remove all files and generate from scratch</small>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
                <div class="modal-footer" style="border-color: var(--border-color, #333);">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modify Instructions Modal -->
    <div class="modal fade" id="modifyModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="background: var(--bg-secondary, #1e1e1e); color: var(--text-primary, #fff);">
                <div class="modal-header" style="background: var(--accent, #6366f1); color: #fff; border-color: var(--border-color, #333);">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Modify Existing Landing</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Current files info -->
                    <div class="alert alert-secondary mb-4">
                        <strong><i class="fas fa-folder-open me-2"></i>Current files:</strong>
                        <div id="modifyFileList" class="mt-2 small"></div>
                    </div>

                    <!-- Instructions textarea -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold">What would you like to change?</label>
                        <textarea id="modifyInstructions" class="form-control" rows="5"
                            placeholder="Example: Add a testimonials section with 3 customer reviews below the hero section..."></textarea>
                    </div>

                    <!-- Timeout -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Maximum execution time</label>
                        <div class="input-group" style="max-width: 200px;">
                            <input type="number" id="modifyTimeout" class="form-control" value="3" min="1" max="60">
                            <span class="input-group-text">minutes</span>
                        </div>
                        <small class="text-muted">Max: 60 minutes.</small>
                    </div>

                    <!-- Examples -->
                    <div class="small text-muted">
                        <strong>Examples:</strong>
                        <ul class="mb-0 mt-1">
                            <li>"Add a FAQ section at the bottom"</li>
                            <li>"Make the CTA buttons more prominent with the primary color"</li>
                            <li>"Add a pricing table with 3 tiers: Basic, Pro, Enterprise"</li>
                            <li>"Translate all text to English"</li>
                            <li>"Use the logo.png image in the header"</li>
                        </ul>
                    </div>

                    <!-- Progress indicator -->
                    <div id="modifyProgress" class="text-center py-4" style="display: none;">
                        <div class="spinner-border text-primary mb-3" role="status"></div>
                        <p class="mb-0 fw-semibold">Applying modifications...</p>
                        <small class="text-muted">Claude is reading your files and making changes...</small>
                    </div>

                    <!-- Error message -->
                    <div id="modifyError" class="alert alert-danger mt-3" style="display: none;"></div>
                </div>
                <div class="modal-footer" style="border-color: var(--border-color, #333);">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="modifyCancelBtn">Cancel</button>
                    <button type="button" class="btn btn-primary" id="modifyApplyBtn" onclick="applyModifications()">
                        <i class="fas fa-check me-1"></i> Apply Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Fresh Start Modal -->
    <div class="modal fade" id="freshConfirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content" style="background: var(--bg-secondary, #1e1e1e); color: var(--text-primary, #fff);">
                <div class="modal-header bg-danger text-white" style="border-color: var(--border-color, #333);">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Confirm Delete All</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>This will delete all landing page files:</p>
                    <ul id="freshDeleteList" class="text-danger"></ul>
                    <p class="mb-0"><strong>Note:</strong> Images in <code>static/img/</code> will be preserved.</p>
                </div>
                <div class="modal-footer" style="border-color: var(--border-color, #333);">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmFreshStart()">
                        <i class="fas fa-trash me-1"></i> Delete All & Continue
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Wizard Modal (Create New) -->
    <div class="modal fade" id="wizardModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="background: var(--bg-secondary, #1e1e1e); color: var(--text-primary, #fff);">
                <div class="modal-header" style="background: var(--accent, #6366f1); color: #fff; border-color: var(--border-color, #333);">
                    <h5 class="modal-title"><i class="fas fa-magic me-2"></i>Create New Landing Page</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Description -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Describe your pack or product *</label>
                        <textarea id="wizardDescription" class="form-control" rows="4"
                            placeholder="Example: A collection of AI prompts for entrepreneurs - includes business plan creator, pitch deck writer, and marketing strategist..."></textarea>
                        <small class="text-muted">The more detailed your description, the better the result.</small>
                    </div>

                    <!-- Style -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Visual style</label>
                        <div class="btn-group d-flex" role="group">
                            <input type="radio" class="btn-check" name="wizardStyle" id="styleModern" value="modern" checked>
                            <label class="btn btn-outline-primary" for="styleModern">Modern</label>
                            <input type="radio" class="btn-check" name="wizardStyle" id="styleMinimalist" value="minimalist">
                            <label class="btn btn-outline-primary" for="styleMinimalist">Minimalist</label>
                            <input type="radio" class="btn-check" name="wizardStyle" id="styleCorporate" value="corporate">
                            <label class="btn btn-outline-primary" for="styleCorporate">Corporate</label>
                            <input type="radio" class="btn-check" name="wizardStyle" id="styleCreative" value="creative">
                            <label class="btn btn-outline-primary" for="styleCreative">Creative</label>
                        </div>
                    </div>

                    <!-- Colors -->
                    <div class="row mb-4">
                        <div class="col-6">
                            <label class="form-label fw-semibold">Primary color</label>
                            <div class="input-group">
                                <input type="color" id="wizardPrimaryColor" class="form-control form-control-color" value="#3B82F6">
                                <input type="text" id="wizardPrimaryColorText" class="form-control" value="#3B82F6" pattern="^#[0-9A-Fa-f]{6}$">
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="form-label fw-semibold">Secondary color</label>
                            <div class="input-group">
                                <input type="color" id="wizardSecondaryColor" class="form-control form-control-color" value="#10B981">
                                <input type="text" id="wizardSecondaryColorText" class="form-control" value="#10B981" pattern="^#[0-9A-Fa-f]{6}$">
                            </div>
                        </div>
                    </div>

                    <!-- Language -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Content language</label>
                        <select id="wizardLanguage" class="form-select" style="max-width: 200px;">
                            <option value="es">Spanish</option>
                            <option value="en">English</option>
                        </select>
                    </div>

                    <!-- Timeout -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Maximum execution time</label>
                        <div class="input-group" style="max-width: 200px;">
                            <input type="number" id="wizardTimeout" class="form-control" value="3" min="1" max="60">
                            <span class="input-group-text">minutes</span>
                        </div>
                        <small class="text-muted">Complex pages may need more time. Max: 60 minutes.</small>
                    </div>

                    <!-- Warning if home.html exists -->
                    {% if has_home_page %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> A <code>home.html</code> already exists. Generating a new one will overwrite it.
                    </div>
                    {% endif %}

                    <!-- Progress indicator -->
                    <div id="wizardProgress" class="text-center py-4" style="display: none;">
                        <div class="spinner-border text-primary mb-3" role="status"></div>
                        <p class="mb-0 fw-semibold">Generating your landing page...</p>
                        <small class="text-muted">Please wait...</small>
                    </div>

                    <!-- Error message -->
                    <div id="wizardError" class="alert alert-danger" style="display: none;"></div>
                </div>
                <div class="modal-footer" style="border-color: var(--border-color, #333);">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="wizardCancelBtn">Cancel</button>
                    <button type="button" class="btn btn-primary" id="wizardGenerateBtn" onclick="generateLanding()">
                        <i class="fas fa-wand-magic-sparkles me-1"></i> Generate Landing Page
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script src="{{ get_static_url('/static/js/fullsize-viewer.js') }}"></script>
{% endblock %}

{% block scripts_inline %}
    <script>
        const packId = {{ pack.id }};
        const publicUrl = '{{ public_url }}';

        // === AI Job Polling System ===
        let activeJobTaskId = null;
        let pollingInterval = null;
        const POLLING_INTERVAL_MS = 4000;

        async function pollJobStatus(taskId, onComplete, onError, progressElement, errorElement) {
            try {
                const response = await secureFetch(`/api/landing/pack/${packId}/ai/status/${taskId}`);
                if (!response) {
                    stopPolling();
                    return;
                }

                const data = await response.json();

                if (!data.success) {
                    onError(data.message || 'Failed to get job status');
                    stopPolling();
                    return;
                }

                if (data.status === 'running') {
                    const elapsed = Math.round((Date.now() - new Date(data.started_at).getTime()) / 1000);
                    const progressSmall = progressElement.querySelector('small');
                    if (progressSmall) {
                        progressSmall.textContent = `Claude is working... (${elapsed}s elapsed)`;
                    }
                }

                if (data.status === 'completed') {
                    stopPolling();
                    onComplete(data);
                } else if (data.status === 'failed' || data.status === 'timeout') {
                    stopPolling();
                    onError(data.error || `Job ${data.status}`);
                }
            } catch (err) {
                console.error('Polling error:', err);
            }
        }

        function startPolling(taskId, onComplete, onError, progressElement, errorElement) {
            activeJobTaskId = taskId;
            pollJobStatus(taskId, onComplete, onError, progressElement, errorElement);
            pollingInterval = setInterval(() => {
                pollJobStatus(taskId, onComplete, onError, progressElement, errorElement);
            }, POLLING_INTERVAL_MS);
        }

        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
            activeJobTaskId = null;
        }

        async function checkActiveJob() {
            try {
                const response = await secureFetch(`/api/landing/pack/${packId}/ai/active-job`);
                if (!response) return;

                const data = await response.json();
                if (data.success && data.has_active_job) {
                    NotificationModal.info(
                        'Job In Progress',
                        `A ${data.type} job is currently running. Task ID: ${data.task_id.substring(0, 8)}...`
                    );
                    const dummyProgress = document.createElement('div');
                    startPolling(
                        data.task_id,
                        () => {
                            NotificationModal.success('Job Completed!', 'The AI wizard has finished. Reloading page...');
                            setTimeout(() => window.location.reload(), 1500);
                        },
                        (errorMsg) => {
                            NotificationModal.error('Job Failed', errorMsg);
                        },
                        dummyProgress,
                        dummyProgress
                    );
                }
            } catch (err) {
                console.error('Error checking active job:', err);
            }
        }

        document.addEventListener('DOMContentLoaded', checkActiveJob);

        // Copy URL to clipboard
        function copyUrl() {
            navigator.clipboard.writeText(publicUrl).then(() => {
                NotificationModal.success('Copied!', 'URL copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        // === Pages Management ===

        document.getElementById('addPageForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const pageName = document.getElementById('newPageName').value.trim().toLowerCase();

            if (!pageName || !/^[a-zA-Z0-9_-]+$/.test(pageName)) {
                NotificationModal.warning('Invalid Page Name', 'Use only letters, numbers, underscores, and hyphens.');
                return;
            }

            try {
                const response = await secureFetch(`/api/landing/pack/${packId}/pages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ page_name: pageName })
                });
                if (!response) return;

                const data = await response.json();
                if (data.success) {
                    window.location.reload();
                } else {
                    NotificationModal.error('Page Creation Failed', data.message || 'Error creating page');
                }
            } catch (err) {
                console.error('Error:', err);
                NotificationModal.error('Page Creation Failed', 'Error creating page');
            }
        });

        async function deletePage(pageName) {
            NotificationModal.confirm(
                'Delete Page',
                `Are you sure you want to delete the page "${pageName}"?`,
                async () => {
                    try {
                        const response = await secureFetch(`/api/landing/pack/${packId}/pages/${pageName}`, {
                            method: 'DELETE'
                        });
                        if (!response) return;

                        const data = await response.json();
                        if (data.success) {
                            window.location.reload();
                        } else {
                            NotificationModal.error('Page Deletion Failed', data.message || 'Error deleting page');
                        }
                    } catch (err) {
                        console.error('Error:', err);
                        NotificationModal.error('Page Deletion Failed', 'Error deleting page');
                    }
                },
                null,
                { type: 'error', confirmText: 'Delete' }
            );
        }

        // === Components Management ===

        document.getElementById('addComponentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const name = document.getElementById('componentName').value.trim();
            const type = document.querySelector('input[name="component_type"]:checked').value;

            if (!name) {
                NotificationModal.warning('Name Required', 'Please enter a component name.');
                return;
            }

            try {
                const response = await secureFetch(`/api/landing/pack/${packId}/components`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ component_name: name, component_type: type })
                });
                if (!response) return;

                const data = await response.json();
                if (data.success) {
                    window.location.reload();
                } else {
                    NotificationModal.error('Component Creation Failed', data.message || 'Error creating component');
                }
            } catch (err) {
                console.error('Error:', err);
                NotificationModal.error('Component Creation Failed', 'Error creating component');
            }
        });

        async function deleteComponent(type, name) {
            NotificationModal.confirm(
                'Delete Component',
                `Are you sure you want to delete the component "${name}"?`,
                async () => {
                    try {
                        const response = await secureFetch(`/api/landing/pack/${packId}/components/${type}/${name}`, {
                            method: 'DELETE'
                        });
                        if (!response) return;

                        const data = await response.json();
                        if (data.success) {
                            window.location.reload();
                        } else {
                            NotificationModal.error('Component Deletion Failed', data.message || 'Error deleting component');
                        }
                    } catch (err) {
                        console.error('Error:', err);
                        NotificationModal.error('Component Deletion Failed', 'Error deleting component');
                    }
                },
                null,
                { type: 'error', confirmText: 'Delete' }
            );
        }

        // === Images Management ===

        document.getElementById('imageFiles').addEventListener('change', function() {
            const container = document.getElementById('imageNamesContainer');
            container.innerHTML = '';
            for (let i = 0; i < this.files.length; i++) {
                const file = this.files[i];
                const input = document.createElement('input');
                input.type = 'text';
                input.name = 'names';
                input.className = 'form-control form-control-sm mt-1';
                input.value = file.name.split('.')[0];
                input.placeholder = `Name for ${file.name}`;
                container.appendChild(input);
            }
        });

        document.getElementById('imageUploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const form = this;

            try {
                const response = await secureFetch(`/api/landing/pack/${packId}/images`, {
                    method: 'POST',
                    body: formData
                });
                if (!response) return;

                const data = await response.json();
                if (data.message) {
                    NotificationModal.info('Image Upload', data.message);
                    loadImages();
                    form.reset();
                    document.getElementById('imageNamesContainer').innerHTML = '';
                }
            } catch (err) {
                console.error('Error:', err);
                NotificationModal.error('Upload Failed', 'Error uploading images');
            }
        });

        async function loadImages() {
            try {
                const response = await secureFetch(`/api/landing/pack/${packId}/images`);
                if (!response) return;

                const data = await response.json();
                const grid = document.getElementById('imagesGrid');
                const noMsg = document.getElementById('noImagesMsg');
                grid.innerHTML = '';

                if (!data.images || data.images.length === 0) {
                    noMsg.style.display = 'block';
                    return;
                }

                noMsg.style.display = 'none';
                FullsizeViewer.setImages(data.images);

                data.images.forEach((image, index) => {
                    const card = document.createElement('div');
                    card.className = 'image-container';

                    const img = document.createElement('img');
                    img.src = image.url;
                    img.alt = image.name;
                    img.loading = 'lazy';
                    img.style.cursor = 'pointer';
                    img.addEventListener('click', () => FullsizeViewer.show(image.url, index));
                    card.appendChild(img);

                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'image-name';
                    nameDiv.title = image.name;
                    nameDiv.textContent = image.name;
                    card.appendChild(nameDiv);

                    const btnDiv = document.createElement('div');
                    btnDiv.className = 'p-2 pt-0';
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-outline-danger btn-sm w-100';
                    btn.innerHTML = '<i class="fas fa-trash"></i>';
                    btn.addEventListener('click', () => deleteImage(image.id));
                    btnDiv.appendChild(btn);
                    card.appendChild(btnDiv);

                    grid.appendChild(card);
                });
            } catch (err) {
                console.error('Error loading images:', err);
            }
        }

        async function deleteImage(imageId) {
            NotificationModal.confirm(
                'Delete Image',
                'Are you sure you want to delete this image?',
                async () => {
                    try {
                        const response = await secureFetch(`/api/landing/pack/${packId}/images/${imageId}`, {
                            method: 'DELETE'
                        });
                        if (!response) return;

                        const data = await response.json();
                        NotificationModal.info('Image Deleted', data.message);
                        loadImages();
                    } catch (err) {
                        console.error('Error:', err);
                        NotificationModal.error('Image Deletion Failed', 'Error deleting image');
                    }
                },
                null,
                { type: 'error', confirmText: 'Delete' }
            );
        }

        // Initialize fullsize viewer
        FullsizeViewer.init({
            showNav: true,
            showDownload: true,
            showDelete: false,
            transformUrl: false
        });

        // Load images on page load
        document.addEventListener('DOMContentLoaded', loadImages);

        // === AI Wizard ===

        // Sync color pickers with text inputs
        document.getElementById('wizardPrimaryColor').addEventListener('input', function() {
            document.getElementById('wizardPrimaryColorText').value = this.value;
        });
        document.getElementById('wizardPrimaryColorText').addEventListener('input', function() {
            if (/^#[0-9A-Fa-f]{6}$/.test(this.value)) {
                document.getElementById('wizardPrimaryColor').value = this.value;
            }
        });
        document.getElementById('wizardSecondaryColor').addEventListener('input', function() {
            document.getElementById('wizardSecondaryColorText').value = this.value;
        });
        document.getElementById('wizardSecondaryColorText').addEventListener('input', function() {
            if (/^#[0-9A-Fa-f]{6}$/.test(this.value)) {
                document.getElementById('wizardSecondaryColor').value = this.value;
            }
        });

        async function generateLanding() {
            const description = document.getElementById('wizardDescription').value.trim();
            if (!description) {
                NotificationModal.warning('Description Required', 'Please describe your pack or product');
                document.getElementById('wizardDescription').focus();
                return;
            }

            if (description.length < 20) {
                NotificationModal.warning('Description Too Short', 'Please provide a more detailed description (at least 20 characters)');
                document.getElementById('wizardDescription').focus();
                return;
            }

            const style = document.querySelector('input[name="wizardStyle"]:checked').value;
            const primaryColor = document.getElementById('wizardPrimaryColor').value;
            const secondaryColor = document.getElementById('wizardSecondaryColor').value;
            const language = document.getElementById('wizardLanguage').value;

            let timeoutMinutes = parseInt(document.getElementById('wizardTimeout').value, 10) || 5;
            timeoutMinutes = Math.max(1, Math.min(60, timeoutMinutes));

            const progressElement = document.getElementById('wizardProgress');
            const errorElement = document.getElementById('wizardError');

            progressElement.querySelector('small').textContent = 'Starting job...';
            progressElement.style.display = 'block';
            errorElement.style.display = 'none';
            document.getElementById('wizardGenerateBtn').disabled = true;
            document.getElementById('wizardCancelBtn').disabled = true;

            try {
                const response = await secureFetch(`/api/landing/pack/${packId}/ai/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        description,
                        style,
                        primary_color: primaryColor,
                        secondary_color: secondaryColor,
                        language,
                        timeout_minutes: timeoutMinutes
                    })
                });
                if (!response) return;

                const data = await response.json();

                if (data.success && data.task_id) {
                    progressElement.querySelector('small').textContent = 'Claude is working...';

                    startPolling(
                        data.task_id,
                        (result) => {
                            bootstrap.Modal.getInstance(document.getElementById('wizardModal')).hide();
                            const filesCreated = result.files_created ? result.files_created.join(', ') : 'home.html';
                            NotificationModal.success('Landing Page Generated!', 'Files created: ' + filesCreated);
                            window.location.reload();
                        },
                        (errorMsg) => {
                            errorElement.textContent = errorMsg;
                            errorElement.style.display = 'block';
                            progressElement.style.display = 'none';
                            document.getElementById('wizardGenerateBtn').disabled = false;
                            document.getElementById('wizardCancelBtn').disabled = false;
                        },
                        progressElement,
                        errorElement
                    );
                } else {
                    errorElement.textContent = data.message || 'Failed to start job';
                    errorElement.style.display = 'block';
                    progressElement.style.display = 'none';
                    document.getElementById('wizardGenerateBtn').disabled = false;
                    document.getElementById('wizardCancelBtn').disabled = false;
                }
            } catch (err) {
                console.error('Error:', err);
                errorElement.textContent = 'Network error. Please try again.';
                errorElement.style.display = 'block';
                progressElement.style.display = 'none';
                document.getElementById('wizardGenerateBtn').disabled = false;
                document.getElementById('wizardCancelBtn').disabled = false;
            }
        }

        // === Mode Selection System ===

        let currentFiles = null;

        async function openAIWizard() {
            try {
                const response = await secureFetch(`/api/landing/pack/${packId}/files`);
                if (!response) return;

                const data = await response.json();

                if (!data.success) {
                    NotificationModal.error('File Check Error', data.message || 'Unknown error');
                    return;
                }

                currentFiles = data.files;

                if (currentFiles.total_count === 0) {
                    new bootstrap.Modal(document.getElementById('wizardModal')).show();
                } else {
                    showModeSelection();
                }
            } catch (err) {
                console.error('Error:', err);
                NotificationModal.error('File Check Error', 'Error checking existing files');
            }
        }

        function showModeSelection() {
            const parts = [];
            if (currentFiles.pages.length > 0) {
                parts.push(`${currentFiles.pages.length} page(s)`);
            }
            if (currentFiles.css.length > 0) {
                parts.push(`${currentFiles.css.length} CSS file(s)`);
            }
            if (currentFiles.js.length > 0) {
                parts.push(`${currentFiles.js.length} JS file(s)`);
            }
            if (currentFiles.images.length > 0) {
                parts.push(`${currentFiles.images.length} image(s)`);
            }

            const summaryText = parts.length > 0
                ? `Current files: ${parts.join(', ')}`
                : 'No files found';

            document.getElementById('modeFileSummaryText').textContent = summaryText;

            const modifyOption = document.getElementById('modifyOption');
            if (currentFiles.pages.length === 0) {
                modifyOption.classList.add('disabled');
                modifyOption.style.opacity = '0.5';
                modifyOption.style.pointerEvents = 'none';
            } else {
                modifyOption.classList.remove('disabled');
                modifyOption.style.opacity = '1';
                modifyOption.style.pointerEvents = 'auto';
            }

            const freshOption = document.getElementById('freshOption');
            if (currentFiles.total_count === 0) {
                freshOption.classList.add('disabled');
                freshOption.style.opacity = '0.5';
                freshOption.style.pointerEvents = 'none';
            } else {
                freshOption.classList.remove('disabled');
                freshOption.style.opacity = '1';
                freshOption.style.pointerEvents = 'auto';
            }

            new bootstrap.Modal(document.getElementById('modeModal')).show();
        }

        function selectMode(mode) {
            bootstrap.Modal.getInstance(document.getElementById('modeModal')).hide();

            setTimeout(() => {
                if (mode === 'create') {
                    new bootstrap.Modal(document.getElementById('wizardModal')).show();
                } else if (mode === 'modify') {
                    showModifyModal();
                } else if (mode === 'fresh') {
                    showFreshConfirmation();
                }
            }, 300);
        }

        function showModifyModal() {
            const fileListHtml = [];

            if (currentFiles.pages.length > 0) {
                fileListHtml.push(`<strong>Pages:</strong> ${currentFiles.pages.join(', ')}`);
            }
            if (currentFiles.css.length > 0) {
                fileListHtml.push(`<strong>CSS:</strong> ${currentFiles.css.join(', ')}`);
            }
            if (currentFiles.js.length > 0) {
                fileListHtml.push(`<strong>JS:</strong> ${currentFiles.js.join(', ')}`);
            }
            if (currentFiles.images.length > 0) {
                fileListHtml.push(`<strong>Images:</strong> ${currentFiles.images.join(', ')}`);
            }

            document.getElementById('modifyFileList').innerHTML = fileListHtml.join('<br>') || 'No files';
            document.getElementById('modifyInstructions').value = '';
            document.getElementById('modifyError').style.display = 'none';

            new bootstrap.Modal(document.getElementById('modifyModal')).show();
        }

        async function applyModifications() {
            const instructions = document.getElementById('modifyInstructions').value.trim();

            if (!instructions) {
                NotificationModal.warning('Instructions Required', 'Please describe what changes you want to make');
                document.getElementById('modifyInstructions').focus();
                return;
            }

            if (instructions.length < 10) {
                NotificationModal.warning('Instructions Too Short', 'Please provide more detailed instructions (at least 10 characters)');
                document.getElementById('modifyInstructions').focus();
                return;
            }

            let timeoutMinutes = parseInt(document.getElementById('modifyTimeout').value, 10) || 5;
            timeoutMinutes = Math.max(1, Math.min(60, timeoutMinutes));

            const progressElement = document.getElementById('modifyProgress');
            const errorElement = document.getElementById('modifyError');

            progressElement.querySelector('small').textContent = 'Starting job...';
            progressElement.style.display = 'block';
            errorElement.style.display = 'none';
            document.getElementById('modifyApplyBtn').disabled = true;
            document.getElementById('modifyCancelBtn').disabled = true;

            try {
                const response = await secureFetch(`/api/landing/pack/${packId}/ai/modify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ instructions, timeout_minutes: timeoutMinutes })
                });
                if (!response) return;

                const data = await response.json();

                if (data.success && data.task_id) {
                    progressElement.querySelector('small').textContent = 'Claude is reading your files and making changes...';

                    startPolling(
                        data.task_id,
                        (result) => {
                            bootstrap.Modal.getInstance(document.getElementById('modifyModal')).hide();
                            NotificationModal.success('Modifications Applied!', 'Your changes have been applied successfully.');
                            window.location.reload();
                        },
                        (errorMsg) => {
                            errorElement.textContent = errorMsg;
                            errorElement.style.display = 'block';
                            progressElement.style.display = 'none';
                            document.getElementById('modifyApplyBtn').disabled = false;
                            document.getElementById('modifyCancelBtn').disabled = false;
                        },
                        progressElement,
                        errorElement
                    );
                } else {
                    errorElement.textContent = data.message || 'Failed to start job';
                    errorElement.style.display = 'block';
                    progressElement.style.display = 'none';
                    document.getElementById('modifyApplyBtn').disabled = false;
                    document.getElementById('modifyCancelBtn').disabled = false;
                }
            } catch (err) {
                console.error('Error:', err);
                errorElement.textContent = 'Network error. Please try again.';
                errorElement.style.display = 'block';
                progressElement.style.display = 'none';
                document.getElementById('modifyApplyBtn').disabled = false;
                document.getElementById('modifyCancelBtn').disabled = false;
            }
        }

        function showFreshConfirmation() {
            const deleteItems = [];

            if (currentFiles.pages.length > 0) {
                currentFiles.pages.forEach(p => deleteItems.push(`<li>${p}</li>`));
            }
            if (currentFiles.css.length > 0) {
                currentFiles.css.forEach(c => deleteItems.push(`<li>static/css/${c}</li>`));
            }
            if (currentFiles.js.length > 0) {
                currentFiles.js.forEach(j => deleteItems.push(`<li>static/js/${j}</li>`));
            }
            if (currentFiles.other && currentFiles.other.length > 0) {
                currentFiles.other.forEach(o => deleteItems.push(`<li>${o}</li>`));
            }

            document.getElementById('freshDeleteList').innerHTML = deleteItems.join('') || '<li>No files to delete</li>';

            new bootstrap.Modal(document.getElementById('freshConfirmModal')).show();
        }

        async function confirmFreshStart() {
            try {
                const response = await secureFetch(`/api/landing/pack/${packId}/files`, {
                    method: 'DELETE'
                });
                if (!response) return;

                const data = await response.json();

                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('freshConfirmModal')).hide();

                    setTimeout(() => {
                        new bootstrap.Modal(document.getElementById('wizardModal')).show();
                    }, 300);
                } else {
                    NotificationModal.error('File Deletion Failed', data.message || 'Unknown error');
                }
            } catch (err) {
                console.error('Error:', err);
                NotificationModal.error('File Deletion Failed', 'Error deleting files');
            }
        }
    </script>
{% endblock %}
