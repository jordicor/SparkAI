{% extends 'base.html' %}

{% block title %}{% if prompt %}Login - {{ prompt.name }}{% else %}Login - SparkAI{% endif %}{% endblock %}

{% block styles %}
{# Theme CSS loaded by theme-loader.js #}
<style>
    /* Override base.html main-container for auth pages */
    .main-container {
        padding: 0;
        max-width: none;
    }
    /* Fallback styles for prompt context */
    {% if prompt %}
    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
    }
    .login-wrapper {
        max-width: 420px;
        width: 100%;
        padding: 20px;
    }
    .prompt-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid white;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .prompt-name {
        color: white;
        font-weight: 600;
    }
    .prompt-description {
        color: rgba(255,255,255,0.85);
        font-size: 0.9rem;
    }
    .card {
        border: none;
        border-radius: 16px;
    }
    .btn-primary {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        border: none;
        padding: 12px 24px;
        font-weight: 600;
    }
    .btn-primary:hover {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    }
    .form-control:focus {
        border-color: #6366f1;
        box-shadow: 0 0 0 0.2rem rgba(99, 102, 241, 0.25);
    }
    {% endif %}
    /* Divider with text */
    .divider-with-text {
        display: flex;
        align-items: center;
        text-align: center;
        color: #9ca3af;
        font-size: 0.875rem;
    }
    .divider-with-text::before,
    .divider-with-text::after {
        content: '';
        flex: 1;
        border-bottom: 1px solid #e5e7eb;
    }
    .divider-with-text span {
        padding: 0 1rem;
    }
</style>
{% endblock %}

{% block head_extra %}
<!-- CAPTCHA Scripts -->
{% if captcha and captcha.enabled %}
    {% if captcha.provider == 'turnstile' %}
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    {% elif captcha.provider == 'recaptcha' %}
    <script src="https://www.google.com/recaptcha/api.js?render={{ captcha.site_key }}"></script>
    {% endif %}
{% endif %}
{% endblock %}

{# Auth pages don't need navbar or header #}
{% block header %}{% endblock %}
{% block toolbar %}{% endblock %}
{% block alerts %}{% endblock %}

{% block content %}
{% if message %}
    <p>{{ message }}</p>
{% endif %}

<div class="container d-flex align-items-center justify-content-center" style="min-height: 100vh;">
    {% if prompt %}
    <!-- Login from prompt landing page -->
    <div class="login-wrapper">
        <!-- Prompt Header -->
        <div class="prompt-header text-center mb-4">
            {% if prompt.image %}
            <img src="/static/img/prompts/{{ prompt.image }}" alt="{{ prompt.name }}" class="prompt-avatar mb-3">
            {% endif %}
            <h2 class="prompt-name">{{ prompt.name }}</h2>
            {% if prompt.description %}
            <p class="prompt-description">{{ prompt.description[:100] }}{% if prompt.description|length > 100 %}...{% endif %}</p>
            {% endif %}
        </div>

        <div class="card shadow-lg">
            <div class="card-body p-4">
                <div id="oauthError" class="alert alert-danger d-none" role="alert"></div>

                {% if error %}
                <div class="alert alert-danger" role="alert">{{ error }}</div>
                {% endif %}

                <form action="{{ login_url }}" method="POST" id="loginFormPrompt" class="login-form">
                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" class="form-control form-control-lg" id="username" name="username" required
                               placeholder="Your username" autocomplete="username">
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control form-control-lg" id="password" name="password" required
                               placeholder="Your password" autocomplete="current-password">
                    </div>
                    <!-- CAPTCHA Widget -->
                    {% if captcha and captcha.enabled and captcha.provider == 'turnstile' %}
                    <div class="cf-turnstile mb-3" data-sitekey="{{ captcha.site_key }}" data-theme="light" data-callback="onTurnstileSuccess"></div>
                    {% endif %}
                    <input type="hidden" name="captcha_token" id="captchaTokenPrompt" value="">
                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary btn-lg login-submit-btn" {% if captcha and captcha.enabled and captcha.provider == 'turnstile' %}disabled{% endif %}>Log In</button>
                    </div>
                </form>

                <div class="divider-with-text my-4">
                    <span>or</span>
                </div>

                <div class="d-grid gap-2">
                    <a href="/auth/google{% if prompt %}?prompt_id={{ prompt.id }}{% endif %}"
                       class="btn btn-outline-secondary btn-lg d-flex align-items-center justify-content-center">
                        <img src="/static/img/providers/google.svg" width="20" height="20" class="me-2" alt="">
                        Sign in with Google
                    </a>
                </div>

                <hr class="my-4">

                <p class="text-center text-muted mb-0">
                    Don't have an account? <a href="{{ register_url }}" class="text-decoration-none">Register</a>
                </p>
            </div>
        </div>
    </div>
    {% else %}
    <!-- Login from SparkAI main site (original layout) -->
    <div class="card shadow" style="width: 22rem;">
        <div class="card-body">
            <h2 class="card-title text-center mb-4">Log In</h2>

            <div id="oauthErrorMain" class="alert alert-danger d-none" role="alert"></div>

            {% if error %}
            <div class="alert alert-danger" role="alert">{{ error }}</div>
            {% endif %}

            <form action="{{ login_url|default('/login') }}" method="POST" id="loginFormMain" class="login-form">
                <div class="mb-3">
                    <label for="usernameMain" class="form-label">Username:</label>
                    <input type="text" class="form-control" id="usernameMain" name="username" required>
                </div>
                <div class="mb-3">
                    <label for="passwordMain" class="form-label">Password:</label>
                    <input type="password" class="form-control" id="passwordMain" name="password" required>
                </div>
                <!-- CAPTCHA Widget -->
                {% if captcha and captcha.enabled and captcha.provider == 'turnstile' %}
                <div class="cf-turnstile mb-3" data-sitekey="{{ captcha.site_key }}" data-theme="light" data-callback="onTurnstileSuccess"></div>
                {% endif %}
                <input type="hidden" name="captcha_token" id="captchaTokenMain" value="">
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary login-submit-btn" {% if captcha and captcha.enabled and captcha.provider == 'turnstile' %}disabled{% endif %}>Log In</button>
                </div>
            </form>

            <div class="divider-with-text my-3">
                <span>or</span>
            </div>

            <div class="d-grid gap-2">
                <a href="/auth/google"
                   class="btn btn-outline-secondary d-flex align-items-center justify-content-center">
                    <img src="/static/img/providers/google.svg" width="18" height="18" class="me-2" alt="">
                    Sign in with Google
                </a>
            </div>

            <hr class="my-3">

            <p class="text-center text-muted mb-0">
                Don't have an account? <a href="{{ register_url|default('/register') }}">Register</a>
            </p>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{% endblock %}

{% block scripts_inline %}
<script>
    // CAPTCHA configuration
    const captchaConfig = {
        provider: '{{ captcha.provider if captcha else "none" }}',
        siteKey: '{{ captcha.site_key if captcha else "" }}',
        enabled: {{ 'true' if captcha and captcha.enabled else 'false' }}
    };

    // Turnstile callback - enable submit buttons when CAPTCHA is completed
    function onTurnstileSuccess(token) {
        // Enable all login submit buttons
        document.querySelectorAll('.login-submit-btn').forEach(btn => {
            btn.disabled = false;
        });
    }

    // OAuth error messages
    const oauthErrors = {
        'oauth_denied': 'Google sign-in was cancelled or denied.',
        'invalid_state': 'Invalid authentication state. Please try again.',
        'no_email': 'Google did not provide an email address.',
        'account_disabled': 'Your account has been disabled. Contact support for assistance.',
        'email_linked_other_google': 'This email is already linked to a different Google account.',
        'create_failed': 'Failed to create account. Please try again.',
        'oauth_failed': 'Authentication failed. Please try again.'
    };

    // Check for OAuth errors on page load
    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const error = urlParams.get('error');

        if (error && oauthErrors[error]) {
            // Show error in the appropriate container
            const errorDiv = document.getElementById('oauthError') || document.getElementById('oauthErrorMain');
            if (errorDiv) {
                errorDiv.textContent = oauthErrors[error];
                errorDiv.classList.remove('d-none');
            }

            // Clean up URL
            const url = new URL(window.location);
            url.searchParams.delete('error');
            window.history.replaceState({}, '', url);
        }

        // Handle CAPTCHA for login forms
        if (captchaConfig.enabled && captchaConfig.provider === 'recaptcha') {
            // reCAPTCHA v3: intercept form submissions
            document.querySelectorAll('.login-form').forEach(form => {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    try {
                        const token = await grecaptcha.execute(captchaConfig.siteKey, {action: 'login'});
                        const tokenInput = form.querySelector('[name="captcha_token"]');
                        if (tokenInput) tokenInput.value = token;
                        form.submit();
                    } catch (err) {
                        console.error('reCAPTCHA error:', err);
                        form.submit(); // Submit anyway, server will handle
                    }
                });
            });
        }
    });
</script>
{% endblock %}
