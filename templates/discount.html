{% extends 'base.html' %}

{% block title %}Generate Discount{% endblock %}

{% block styles %}
{# Theme CSS loaded by theme-loader.js #}
{% endblock %}

{% block page_title %}Generate Discount Code{% endblock %}

{% block back_url %}/admin/discount-list{% endblock %}
{% block back_title %}Return to Discounts{% endblock %}

{% block toolbar %}{% endblock %}

{% block content %}
<div class="section-container">
    <div class="section-title"><i class="fas fa-tag"></i> New Discount Code</div>

    <form action="/process-discount" method="POST" onsubmit="handleSubmit(event)">
        <div class="flex-row">
            <div class="flex-column">
                <div class="mb-3">
                    <label for="code" class="form-label">Name</label>
                    <input type="text" class="form-control" id="code" name="code" required>
                </div>
            </div>
            <div class="flex-column">
                <div class="mb-3">
                    <label for="discount" class="form-label">Discount (%)</label>
                    <input type="text" class="form-control" id="discount" name="discount" inputmode="numeric" pattern="[0-9]*" oninput="this.value = this.value.replace(/[^0-9]/g, '')" required>
                </div>
            </div>
        </div>

        <div class="flex-row">
            <div class="flex-column">
                <div class="mb-3">
                    <label for="validity_date" class="form-label">Validity Date</label>
                    <input type="date" class="form-control" id="validity_date" name="validity_date">
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="unlimited_date" name="unlimited_date" onchange="toggleInput('unlimited_date', 'validity_date')">
                    <label class="form-check-label" for="unlimited_date">Unlimited Validity</label>
                </div>
            </div>
            <div class="flex-column">
                <div class="mb-3">
                    <label for="usage_limit" class="form-label">Usage Quantity</label>
                    <input type="text" class="form-control" id="usage_limit" name="usage_limit" inputmode="numeric" pattern="[0-9]*" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="unlimited_usage" name="unlimited_usage" onchange="toggleInput('unlimited_usage', 'usage_limit')">
                    <label class="form-check-label" for="unlimited_usage">Unlimited Usage</label>
                </div>
            </div>
        </div>

        <div class="mt-4">
            <button type="submit" class="btn btn-success">
                <i class="fas fa-plus me-1"></i> Generate Code
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts_inline %}
<script>
    async function handleSubmit(event) {
        event.preventDefault();

        const form = event.target;
        const formData = new FormData(form);

        const response = await fetch(form.action, {
            method: form.method,
            body: formData
        });

        if (response.ok) {
            const result = await response.json();
            NotificationModal.info('Discount Created', result.message);
            form.reset();
        } else {
            NotificationModal.error('Creation Failed', 'There was a problem creating the discount code.');
        }
    }

    function toggleInput(checkboxId, inputId) {
        const input = document.getElementById(inputId);
        const checkbox = document.getElementById(checkboxId);
        input.disabled = checkbox.checked;

        if (checkbox.checked) {
            input.value = '';
        }
    }
</script>
{% endblock %}
