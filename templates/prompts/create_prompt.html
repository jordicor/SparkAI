{% extends 'base.html' %}

{% block title %}Create Prompt - SPARK{% endblock %}

{% block styles %}
{# Theme CSS loaded by theme-loader.js - category styles now in default.css #}
{% endblock %}

{% block page_title %}Create New Prompt{% endblock %}

{% block back_url %}/prompts{% endblock %}
{% block back_title %}Back to Prompts{% endblock %}

{% block content %}
<form action="/prompts/new" method="post" enctype="multipart/form-data" id="createPromptForm">

    <!-- Section 1: Basic Information -->
    <div class="section-container">
        <div class="section-title"><i class="fas fa-info-circle me-2"></i>Basic Information</div>
        <div class="flex-row">
            <div class="flex-column">
                <div class="mb-3">
                    <label for="promptName" class="form-label">Prompt Name</label>
                    <input type="text" class="form-control" id="promptName" name="name" required>
                </div>
            </div>
            <div class="flex-column">
                <div class="mb-3">
                    <label for="description" class="form-label">Description</label>
                    <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Section 2: Appearance & Voice -->
    <div class="section-container">
        <div class="section-title"><i class="fas fa-palette me-2"></i>Appearance & Voice</div>
        <div class="flex-row">
            <div class="flex-column d-flex justify-content-center align-items-center">
                <div class="mb-3 text-center">
                    <label for="promptImageInput" class="form-label">Prompt Image</label>
                    <div class="avatar-wrapper" style="margin: 0 auto;">
                        <div class="avatar-container" id="promptImageContainer">
                            <span class="avatar-initial" id="defaultPromptInitial">P</span>
                            <div class="avatar-icons">
                                <span class="avatar-icon edit"><i class="fas fa-pencil-alt"></i></span>
                            </div>
                        </div>
                        <div class="avatar-preview hidden" id="previewContainer">
                            <img id="previewImage" alt="Preview">
                            <div class="avatar-icons">
                                <span class="avatar-icon edit"><i class="fas fa-pencil-alt"></i></span>
                                <span class="avatar-icon cancel"><i class="fas fa-times"></i></span>
                            </div>
                        </div>
                        <input type="file" id="promptImageInput" name="image" accept="image/*">
                    </div>
                </div>
            </div>
            <div class="flex-column">
                <div class="voice-section">
                    <label for="voiceSelect" class="form-label">
                        <i class="fas fa-microphone me-1"></i>Voice
                    </label>
                    <div class="voice-controls">
                        <select class="form-select" id="voiceSelect" name="sample_voice_id" required>
                            <!-- Options will be loaded dynamically -->
                        </select>
                        <select class="form-select" id="sampleCategory" style="display: none;">
                            <!-- Categories will be loaded dynamically -->
                        </select>
                        <button type="button" class="btn" id="playVoiceButton" style="display: none;">
                            <i class="fas fa-play"></i>Play Sample
                        </button>
                    </div>
                    <small class="form-text text-muted mt-2">Select a voice for this prompt's text-to-speech.</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Section 3: Prompt Content -->
    <div class="section-container">
        <div class="section-title"><i class="fas fa-file-alt me-2"></i>Prompt Content</div>
        <div class="mb-3">
            <label for="promptText" class="form-label">Prompt Text</label>
            <textarea class="form-control" id="promptText" name="prompt" rows="10" required></textarea>
            <small class="form-text text-muted">The system prompt that defines the AI's personality and behavior</small>
        </div>
    </div>

    <!-- Section 4: Settings -->
    <div class="section-container">
        <div class="section-title"><i class="fas fa-cog me-2"></i>Settings</div>
        <div class="flex-row">
            <div class="flex-column">
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="isPublic" name="public">
                    <label class="form-check-label" for="isPublic">
                        <i class="fas fa-globe me-1 text-muted"></i>Share My Prompt
                        <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Making a prompt public lists it in the marketplace. You must select at least one category. You can set a price to earn money when others use it."></i>
                    </label>
                    <small class="form-text text-muted d-block">Share with the community and earn money when others use it</small>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="disableWebSearch" name="disable_web_search">
                    <label class="form-check-label" for="disableWebSearch">
                        <i class="fas fa-globe-americas me-1 text-muted"></i>Disable Web Search
                    </label>
                    <small class="form-text text-muted d-block">Prevent AI from searching the internet when using this prompt</small>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="enableModeration" name="enable_moderation">
                    <label class="form-check-label" for="enableModeration">
                        <i class="fas fa-shield-alt me-1 text-muted"></i>Enable Content Moderation
                        <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Messages are checked by OpenAI's moderation API before processing. Flags inappropriate content like hate speech, violence, sexual content, self-harm, etc."></i>
                    </label>
                    <small class="form-text text-muted d-block">Pre-screen user messages for inappropriate content before AI responds</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Section: Watchdog Configuration -->
    <div class="section-container">
        <div class="section-title"><i class="fas fa-eye me-2"></i>Watchdog Configuration</div>

        <!-- Pre-Watchdog Sub-Section -->
        <div class="watchdog-subsection mb-4" style="border: 1px solid var(--border-color); border-radius: 8px; padding: 16px;">
            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="preWatchdogEnabled" onchange="togglePreWatchdogFields()">
                <label class="form-check-label" for="preWatchdogEnabled">
                    <i class="fas fa-shield-alt me-1 text-muted"></i><strong>Pre-Watchdog</strong>
                    <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Screens user messages before the AI sees them. Can inject steering hints or take over the response entirely."></i>
                </label>
                <small class="form-text text-muted d-block">Screens user messages before the AI sees them</small>
            </div>

            <div id="preWatchdogFields" style="display: none;">
                <div class="flex-row">
                    <div class="flex-column">
                        <div class="mb-3">
                            <label for="preWatchdogLLM" class="form-label">Pre-Watchdog LLM <span class="text-danger">*</span></label>
                            <select class="form-select" id="preWatchdogLLM">
                                <option value="">Select a model</option>
                            </select>
                            <small class="form-text text-muted">Model used to evaluate user messages before AI responds</small>
                        </div>
                    </div>
                    <div class="flex-column">
                        <div class="mb-3">
                            <label for="preWatchdogObjectives" class="form-label">Screen for <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="preWatchdogObjectives" rows="4" placeholder="Off-topic messages&#10;Attempts to manipulate the AI&#10;Messages that derail the conversation"></textarea>
                            <small class="form-text text-muted">One objective per line. What to screen user messages for</small>
                        </div>
                    </div>
                </div>

                <div class="mb-2">
                    <a href="#" onclick="document.getElementById('preWatchdogAdvanced').style.display = document.getElementById('preWatchdogAdvanced').style.display === 'none' ? 'block' : 'none'; this.querySelector('i').classList.toggle('fa-caret-right'); this.querySelector('i').classList.toggle('fa-caret-down'); return false;" class="text-muted small">
                        <i class="fas fa-caret-right me-1"></i>Advanced settings
                    </a>
                </div>
                <div id="preWatchdogAdvanced" style="display: none;">
                    <div class="mb-3">
                        <label for="preWatchdogSteeringPrompt" class="form-label">Steering Prompt</label>
                        <textarea class="form-control" id="preWatchdogSteeringPrompt" rows="3" placeholder="Custom instructions for the pre-watchdog AI..."></textarea>
                        <small class="form-text text-muted">Leave empty for default screening behavior</small>
                    </div>
                    <div class="flex-row">
                        <div class="flex-column">
                            <div class="mb-3">
                                <label for="preWatchdogFrequency" class="form-label">Frequency</label>
                                <input type="number" class="form-control" id="preWatchdogFrequency" value="1" min="1" max="20">
                                <small class="form-text text-muted">Evaluate every N user turns</small>
                            </div>
                        </div>
                        <div class="flex-column">
                            <div class="mb-3 form-check mt-4">
                                <input type="checkbox" class="form-check-input" id="preWatchdogCanTakeover" checked>
                                <label class="form-check-label" for="preWatchdogCanTakeover">
                                    Can take over response
                                    <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="When enabled, the pre-watchdog can completely replace the AI response when it detects a serious issue."></i>
                                </label>
                            </div>
                        </div>
                        <div class="flex-column">
                            <div class="mb-3 form-check mt-4">
                                <input type="checkbox" class="form-check-input" id="preWatchdogCanLock">
                                <label class="form-check-label" for="preWatchdogCanLock">
                                    Can lock conversation
                                    <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="When enabled, the pre-watchdog can permanently lock the conversation on critical alerts."></i>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Post-Watchdog Sub-Section -->
        <div class="watchdog-subsection" style="border: 1px solid var(--border-color); border-radius: 8px; padding: 16px;">
            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="postWatchdogEnabled" onchange="togglePostWatchdogFields()">
                <label class="form-check-label" for="postWatchdogEnabled">
                    <i class="fas fa-eye me-1 text-muted"></i><strong>Post-Watchdog</strong>
                    <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Monitors the conversation after each AI response and steers it toward objectives. Runs in background."></i>
                </label>
                <small class="form-text text-muted d-block">Monitors the conversation and steers the AI</small>
            </div>

            <div id="postWatchdogFields" style="display: none;">
                <div class="mb-3 d-flex align-items-center gap-2">
                    <button type="button" class="btn btn-outline-primary btn-sm" id="watchdogAutoFillBtn"
                            onclick="requestWatchdogAutoFill()">
                        <i class="fas fa-wand-magic-sparkles me-1"></i>AI Auto-fill
                    </button>
                    <i class="fas fa-info-circle text-muted"
                       data-bs-toggle="tooltip" data-bs-placement="right"
                       title="Uses the selected Post-Watchdog LLM to analyze your prompt and suggest optimal settings (mode, objectives, steering prompt, frequency, thresholds)."></i>
                </div>
                <div class="flex-row">
                    <div class="flex-column">
                        <div class="mb-3">
                            <label for="postWatchdogLLM" class="form-label">Post-Watchdog LLM <span class="text-danger">*</span></label>
                            <select class="form-select" id="postWatchdogLLM">
                                <option value="">Select a model</option>
                            </select>
                            <small class="form-text text-muted">Model used to evaluate conversations after AI responds</small>
                        </div>
                        <div class="mb-3">
                            <label for="postWatchdogMode" class="form-label">Mode</label>
                            <select class="form-select" id="postWatchdogMode">
                                <option value="interview">Interview</option>
                                <option value="coaching">Coaching</option>
                                <option value="education">Education</option>
                                <option value="custom" selected>Custom</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex-column">
                        <div class="mb-3">
                            <label for="postWatchdogObjectives" class="form-label">Objectives <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="postWatchdogObjectives" rows="4" placeholder="Track topic coverage&#10;Detect drift from objectives&#10;Flag factual inconsistencies"></textarea>
                            <small class="form-text text-muted">One objective per line. These tell the watchdog what to evaluate</small>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="postWatchdogSteeringPrompt" class="form-label">Steering Prompt</label>
                    <textarea class="form-control" id="postWatchdogSteeringPrompt" rows="3" placeholder="Custom instructions for the watchdog AI..."></textarea>
                    <small class="form-text text-muted">Leave empty for a default prompt based on the selected mode</small>
                </div>
                <div class="flex-row">
                    <div class="flex-column">
                        <div class="mb-3">
                            <label for="postWatchdogFrequency" class="form-label">Frequency</label>
                            <input type="number" class="form-control" id="postWatchdogFrequency" value="3" min="1" max="20">
                            <small class="form-text text-muted">Evaluate every N user turns (not every message)</small>
                        </div>
                    </div>
                    <div class="flex-column"></div>
                </div>

                <!-- Post-Watchdog Takeover Settings -->
                <div class="mb-2">
                    <a href="#" onclick="document.getElementById('postWatchdogTakeover').style.display = document.getElementById('postWatchdogTakeover').style.display === 'none' ? 'block' : 'none'; this.querySelector('i').classList.toggle('fa-caret-right'); this.querySelector('i').classList.toggle('fa-caret-down'); return false;" class="text-muted small">
                        <i class="fas fa-caret-right me-1"></i>Takeover settings
                    </a>
                </div>
                <div id="postWatchdogTakeover" style="display: none;">
                    <div class="flex-row">
                        <div class="flex-column">
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="postWatchdogCanTakeover">
                                <label class="form-check-label" for="postWatchdogCanTakeover">
                                    Can take over response
                                    <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="After N consecutive hints are ignored, the watchdog takes over the AI response."></i>
                                </label>
                            </div>
                        </div>
                        <div class="flex-column">
                            <div class="mb-3">
                                <label for="postWatchdogTakeoverThreshold" class="form-label">Takeover threshold</label>
                                <input type="number" class="form-control" id="postWatchdogTakeoverThreshold" value="5" min="1" max="50">
                                <small class="form-text text-muted">Consecutive ignored hints before takeover</small>
                            </div>
                        </div>
                        <div class="flex-column">
                            <div class="mb-3 form-check mt-4">
                                <input type="checkbox" class="form-check-input" id="postWatchdogCanLock">
                                <label class="form-check-label" for="postWatchdogCanLock">
                                    Can lock conversation
                                    <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="When enabled, the post-watchdog can permanently lock the conversation on takeover."></i>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Post-Watchdog Advanced Settings -->
                <div class="mb-2">
                    <a href="#" onclick="document.getElementById('postWatchdogAdvanced').style.display = document.getElementById('postWatchdogAdvanced').style.display === 'none' ? 'block' : 'none'; this.querySelector('i').classList.toggle('fa-caret-right'); this.querySelector('i').classList.toggle('fa-caret-down'); return false;" class="text-muted small">
                        <i class="fas fa-caret-right me-1"></i>Advanced settings
                    </a>
                </div>
                <div id="postWatchdogAdvanced" style="display: none;">
                    <div class="flex-row">
                        <div class="flex-column">
                            <div class="mb-3">
                                <label for="postWatchdogMaxHintChars" class="form-label">Max hint chars</label>
                                <input type="number" class="form-control" id="postWatchdogMaxHintChars" value="500" min="100" max="2000">
                            </div>
                        </div>
                        <div class="flex-column">
                            <div class="mb-3">
                                <label for="postWatchdogMaxOffTopic" class="form-label">Max turns off-topic</label>
                                <input type="number" class="form-control" id="postWatchdogMaxOffTopic" value="3" min="1" max="50">
                            </div>
                        </div>
                        <div class="flex-column">
                            <div class="mb-3">
                                <label for="postWatchdogMaxSameSubtopic" class="form-label">Max turns same subtopic</label>
                                <input type="number" class="form-control" id="postWatchdogMaxSameSubtopic" value="5" min="1" max="50">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <input type="hidden" id="watchdogConfigInput" name="watchdog_config" value="">
    </div>

    <!-- Section 5: Categories (shown for public prompts) -->
    <div class="section-container" id="categoriesSection" style="display: none;">
        <div class="section-title"><i class="fas fa-tags me-2"></i>Categories</div>
        <p class="text-muted small mb-3">Select at least one category for your public prompt</p>
        <div class="categories-grid" id="categoriesGrid">
            <!-- Categories will be loaded dynamically -->
            <div class="text-center py-3">
                <div class="spinner-border spinner-border-sm" role="status"></div>
                <span class="ms-2">Loading categories...</span>
            </div>
        </div>
        <input type="hidden" id="categoryIds" name="category_ids" value="">
        <div id="categoryError" class="text-danger small mt-2" style="display: none;">
            Public prompts require at least one category
        </div>
    </div>

    <!-- Section 6: Pricing (shown for public prompts) -->
    <div class="section-container" id="pricingSection" style="display: none;">
        <div class="section-title">
            <i class="fas fa-dollar-sign me-2"></i>Monetization
            <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="You can make your prompt free or set a markup per million tokens. You receive 70% of your markup; 30% goes to the platform."></i>
        </div>
        <p class="text-muted small mb-3">Configure pricing for your public prompt. You earn 70% of your markup when others use it.</p>

        <div class="flex-row">
            <div class="flex-column">
                <div class="mb-3">
                    <label class="form-label">Pricing Model</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="is_paid" id="pricingFree" value="0" checked onchange="togglePricingOptions()">
                        <label class="form-check-label" for="pricingFree">
                            <i class="fas fa-gift me-1 text-success"></i>Free
                            <small class="text-muted d-block">Anyone can use without paying markup</small>
                        </label>
                    </div>
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="radio" name="is_paid" id="pricingPaid" value="1" onchange="togglePricingOptions()">
                        <label class="form-check-label" for="pricingPaid">
                            <i class="fas fa-coins me-1 text-warning"></i>Paid
                            <small class="text-muted d-block">Earn money when others use this prompt</small>
                        </label>
                    </div>
                </div>

                <div id="markupOptions" style="display: none;">
                    <div class="mb-3">
                        <label for="markupInput" class="form-label">Your Markup ($ per million tokens)</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="text" class="form-control" id="markupInput" name="markup_per_mtokens"
                                   value="0" inputmode="decimal" pattern="[0-9]*\.?[0-9]*"
                                   oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1'); updateEarningsPreview()">
                            <span class="input-group-text">/ Mtokens</span>
                        </div>
                    </div>

                    <div class="alert alert-success" id="earningsPreview">
                        <i class="fas fa-calculator me-2"></i>
                        <strong>You will earn:</strong> <span id="previewEarnings">$0.00</span> per million tokens (70% of markup)
                    </div>
                </div>
            </div>

            <div class="flex-column">
                <div class="mb-3">
                    <label class="form-label">AI Model Restrictions</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="llm_mode" id="llmModeAny" value="any" checked onchange="toggleLLMOptions()">
                        <label class="form-check-label" for="llmModeAny">
                            Any model (user chooses)
                        </label>
                    </div>
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="radio" name="llm_mode" id="llmModeForced" value="forced" onchange="toggleLLMOptions()">
                        <label class="form-check-label" for="llmModeForced">
                            Force specific model
                            <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="When enabled, users cannot choose a different AI model. The selected model will always be used for this prompt."></i>
                        </label>
                    </div>
                </div>

                <div id="forcedLLMOptions" style="display: none;">
                    <div class="mb-3">
                        <label for="forcedLLM" class="form-label">Select Model</label>
                        <select class="form-select" id="forcedLLM" name="forced_llm_id">
                            <!-- LLMs loaded dynamically -->
                        </select>
                    </div>
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" id="hideLLMName" name="hide_llm_name">
                        <label class="form-check-label" for="hideLLMName">
                            Hide model name in chat UI
                            <small class="text-muted d-block">Show "AI" instead of model name</small>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-1"></i>Create Prompt
        </button>
        <a href="{{ url_for('list_prompts') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i>Back to List
        </a>
    </div>
</form>

<!-- Watchdog AI Suggestion Modal -->
<div class="modal fade" id="watchdogSuggestionModal" tabindex="-1"
     aria-labelledby="wdSuggestionLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <div class="d-flex align-items-center">
                    <i class="fas fa-wand-magic-sparkles me-2" style="color: var(--accent);"></i>
                    <h5 class="modal-title mb-0" id="wdSuggestionLabel">AI Suggested Configuration</h5>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="wdSuggestionBody">
                <!-- Populated dynamically by JS -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="wdSuggestionApplyBtn"
                        onclick="applyWatchdogSuggestions()">
                    Apply Selected (7)
                </button>
            </div>
        </div>
    </div>
</div>

<style>
#watchdogSuggestionModal .modal-content {
    background-color: var(--bg-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
}
#watchdogSuggestionModal .modal-header {
    background-color: var(--bg-tertiary);
    border-bottom: 1px solid var(--border-color);
}
#watchdogSuggestionModal .modal-footer {
    background-color: var(--bg-tertiary);
    border-top: 1px solid var(--border-color);
}
#watchdogSuggestionModal .suggestion-item {
    padding: 10px 0;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: flex-start;
    gap: 10px;
}
#watchdogSuggestionModal .suggestion-item:last-child {
    border-bottom: none;
}
#watchdogSuggestionModal .suggestion-label {
    font-weight: 600;
    color: var(--text-primary);
    cursor: pointer;
}
#watchdogSuggestionModal .suggestion-value {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-top: 2px;
    white-space: pre-wrap;
    max-height: 150px;
    overflow-y: auto;
}
#watchdogSuggestionModal .bulk-actions {
    display: flex;
    gap: 16px;
    margin-bottom: 8px;
}
#watchdogSuggestionModal .bulk-actions a {
    font-size: 0.85rem;
    cursor: pointer;
    color: var(--accent);
    text-decoration: none;
}
#watchdogSuggestionModal .bulk-actions a:hover {
    text-decoration: underline;
}
#watchdogSuggestionModal .suggestion-list {
    background: var(--bg-tertiary);
    border-radius: 6px;
    padding: 4px 16px;
    border: 1px solid var(--border-color);
}
</style>
{% endblock %}

{% block scripts_inline %}
<script>

    let audioPlayer = null;

    function loadVoices() {
        fetch('/api/voices')
            .then(response => response.json())
            .then(voices => {
                const voiceSelect = document.getElementById('voiceSelect');
                voiceSelect.innerHTML = '<option value="">Select a voice</option>';
                voices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.id;
                    option.textContent = voice.name;
                    voiceSelect.appendChild(option);
                });
                setupVoiceControls();
            })
            .catch(error => console.error('Error loading voices:', error));
    }

    function setupVoiceControls() {
        const voiceSelect = document.getElementById('voiceSelect');
        const categorySelect = document.getElementById('sampleCategory');
        const playButton = document.getElementById('playVoiceButton');

        const categories = [
            "Children and Basic Education",
            "Finance and Business",
            "Relaxation and Meditation",
            "Casual Conversation",
            "Drama and Emotional Narration",
            "Storytelling",
            "Advertising and Announcements",
            "Science and Technology",
            "Education and Advanced Training",
            "Corporate Environments",
            "Mystery and Suspense",
            "Sports and Energy"
        ];

        categories.forEach((category, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = category;
            categorySelect.appendChild(option);
        });

        voiceSelect.addEventListener('change', function() {
            categorySelect.style.display = this.value ? 'inline-block' : 'none';
            playButton.style.display = this.value ? 'inline-block' : 'none';
        });

        playButton.addEventListener('click', function(e) {
            e.preventDefault();
            playVoiceSample(voiceSelect.value, categorySelect.value);
        });
    }

    function playVoiceSample(voiceId, categoryId) {
        if (!voiceId) return;

        if (audioPlayer) {
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            audioPlayer = null;
            playVoiceButton.innerHTML = '<i class="fas fa-play me-1"></i>Play Sample';
            return;
        }

        playVoiceButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Loading...';
        playVoiceButton.disabled = true;

        fetch(`/api/voice-sample/${voiceId}?category=${categoryId}`)
            .then(response => response.blob())
            .then(blob => {
                const url = URL.createObjectURL(blob);
                audioPlayer = new Audio(url);

                audioPlayer.onended = function() {
                    playVoiceButton.innerHTML = '<i class="fas fa-play me-1"></i>Play Sample';
                    playVoiceButton.disabled = false;
                    audioPlayer = null;
                };

                audioPlayer.play();
                playVoiceButton.innerHTML = '<i class="fas fa-stop me-1"></i>Stop Sample';
                playVoiceButton.disabled = false;
            })
            .catch(error => {
                console.error('Error playing voice sample:', error);
                playVoiceButton.innerHTML = '<i class="fas fa-play me-1"></i>Play Sample';
                playVoiceButton.disabled = false;
            });
    }

    // Categories functionality
    let selectedCategories = [];

    function loadCategories() {
        fetch('/api/categories?include_restricted=true')
            .then(response => response.json())
            .then(categories => {
                const grid = document.getElementById('categoriesGrid');
                grid.innerHTML = '';

                if (categories.length === 0) {
                    grid.innerHTML = '<p class="text-muted">No categories available</p>';
                    return;
                }

                categories.forEach(cat => {
                    const div = document.createElement('div');
                    div.className = 'form-check category-item';
                    div.innerHTML = `
                        <input class="form-check-input category-checkbox" type="checkbox"
                               id="cat_${cat.id}" value="${cat.id}"
                               data-age-restricted="${cat.is_age_restricted}">
                        <label class="form-check-label" for="cat_${cat.id}">
                            <i class="fas ${cat.icon} me-1"></i>
                            ${cat.name}
                            ${cat.is_age_restricted ? '<span class="badge bg-danger ms-1">18+</span>' : ''}
                        </label>
                    `;
                    grid.appendChild(div);
                });

                // Add event listeners to checkboxes
                document.querySelectorAll('.category-checkbox').forEach(cb => {
                    cb.addEventListener('change', updateSelectedCategories);
                });
            })
            .catch(error => {
                console.error('Error loading categories:', error);
                document.getElementById('categoriesGrid').innerHTML =
                    '<p class="text-danger">Error loading categories</p>';
            });
    }

    function updateSelectedCategories() {
        selectedCategories = Array.from(document.querySelectorAll('.category-checkbox:checked'))
            .map(cb => parseInt(cb.value));
        document.getElementById('categoryIds').value = JSON.stringify(selectedCategories);
        validateCategories();
    }

    function validateCategories() {
        const isPublic = document.getElementById('isPublic').checked;
        const errorDiv = document.getElementById('categoryError');

        if (isPublic && selectedCategories.length === 0) {
            errorDiv.style.display = 'block';
            return false;
        } else {
            errorDiv.style.display = 'none';
            return true;
        }
    }

    // Pricing and Categories visibility functions
    function togglePricingSection() {
        const isPublic = document.getElementById('isPublic').checked;
        const pricingSection = document.getElementById('pricingSection');
        const categoriesSection = document.getElementById('categoriesSection');

        pricingSection.style.display = isPublic ? 'block' : 'none';
        categoriesSection.style.display = isPublic ? 'block' : 'none';

        // Reset to free if hiding
        if (!isPublic) {
            document.getElementById('pricingFree').checked = true;
            togglePricingOptions();
        }
    }

    function togglePricingOptions() {
        const isPaid = document.getElementById('pricingPaid').checked;
        document.getElementById('markupOptions').style.display = isPaid ? 'block' : 'none';
        if (!isPaid) {
            document.getElementById('markupInput').value = '0';
        }
        updateEarningsPreview();
    }

    function updateEarningsPreview() {
        const markup = parseFloat(document.getElementById('markupInput').value) || 0;
        const earnings = markup * 0.70;  // 70% to creator
        document.getElementById('previewEarnings').textContent = `$${earnings.toFixed(2)}`;
    }

    function toggleLLMOptions() {
        const isForced = document.getElementById('llmModeForced').checked;
        document.getElementById('forcedLLMOptions').style.display = isForced ? 'block' : 'none';
        document.getElementById('forcedLLM').disabled = !isForced;
    }

    function loadLLMs() {
        fetch('/api/llms')
            .then(response => response.json())
            .then(llms => {
                const select = document.getElementById('forcedLLM');
                const preWdSelect = document.getElementById('preWatchdogLLM');
                const postWdSelect = document.getElementById('postWatchdogLLM');
                select.innerHTML = '<option value="">Select a model</option>';
                preWdSelect.innerHTML = '<option value="">Select a model</option>';
                postWdSelect.innerHTML = '<option value="">Select a model</option>';
                llms.forEach(llm => {
                    const option = document.createElement('option');
                    option.value = llm.id;
                    option.textContent = `${llm.machine} - ${llm.model}`;
                    select.appendChild(option);
                    preWdSelect.appendChild(option.cloneNode(true));
                    postWdSelect.appendChild(option.cloneNode(true));
                });
            })
            .catch(error => console.error('Error loading LLMs:', error));
    }

    // --- Watchdog functions ---
    function togglePreWatchdogFields() {
        const enabled = document.getElementById('preWatchdogEnabled').checked;
        document.getElementById('preWatchdogFields').style.display = enabled ? 'block' : 'none';
    }

    function togglePostWatchdogFields() {
        const enabled = document.getElementById('postWatchdogEnabled').checked;
        document.getElementById('postWatchdogFields').style.display = enabled ? 'block' : 'none';
    }

    function serializeWatchdogConfig() {
        const preEnabled = document.getElementById('preWatchdogEnabled').checked;
        const postEnabled = document.getElementById('postWatchdogEnabled').checked;

        const preConfig = { enabled: preEnabled };
        if (preEnabled) {
            const llmId = document.getElementById('preWatchdogLLM').value;
            preConfig.llm_id = llmId ? parseInt(llmId) : null;
            preConfig.objectives = document.getElementById('preWatchdogObjectives').value
                .split('\n').map(s => s.trim()).filter(s => s.length > 0);
            preConfig.steering_prompt = document.getElementById('preWatchdogSteeringPrompt').value.trim();
            preConfig.frequency = parseInt(document.getElementById('preWatchdogFrequency').value) || 1;
            preConfig.can_takeover = document.getElementById('preWatchdogCanTakeover').checked;
            preConfig.can_lock = document.getElementById('preWatchdogCanLock').checked;
        }

        const postConfig = { enabled: postEnabled };
        if (postEnabled) {
            const llmId = document.getElementById('postWatchdogLLM').value;
            postConfig.llm_id = llmId ? parseInt(llmId) : null;
            postConfig.mode = document.getElementById('postWatchdogMode').value;
            postConfig.objectives = document.getElementById('postWatchdogObjectives').value
                .split('\n').map(s => s.trim()).filter(s => s.length > 0);
            postConfig.steering_prompt = document.getElementById('postWatchdogSteeringPrompt').value.trim();
            postConfig.frequency = parseInt(document.getElementById('postWatchdogFrequency').value) || 3;
            postConfig.max_hint_chars = parseInt(document.getElementById('postWatchdogMaxHintChars').value) || 500;
            postConfig.thresholds = {
                max_turns_off_topic: parseInt(document.getElementById('postWatchdogMaxOffTopic').value) || 3,
                max_turns_same_subtopic: parseInt(document.getElementById('postWatchdogMaxSameSubtopic').value) || 5
            };
            postConfig.can_takeover = document.getElementById('postWatchdogCanTakeover').checked;
            postConfig.takeover_threshold = parseInt(document.getElementById('postWatchdogTakeoverThreshold').value) || 5;
            postConfig.can_lock = document.getElementById('postWatchdogCanLock').checked;
        }

        const config = { pre_watchdog: preConfig, post_watchdog: postConfig };
        document.getElementById('watchdogConfigInput').value = JSON.stringify(config);
    }

    // --- Watchdog AI Auto-fill functions ---
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    async function requestWatchdogAutoFill() {
        const llmSelect = document.getElementById('postWatchdogLLM');
        const promptTextarea = document.getElementById('promptText');

        if (!llmSelect.value) {
            NotificationModal.warning(
                'Post-Watchdog LLM Required',
                'Please select a <strong>Post-Watchdog LLM</strong> before using AI Auto-fill.'
            );
            return;
        }

        if (!promptTextarea.value.trim()) {
            NotificationModal.warning(
                'Prompt Text Required',
                'Write the <strong>main prompt text</strong> first. The AI needs it to suggest appropriate watchdog settings.'
            );
            return;
        }

        const btn = document.getElementById('watchdogAutoFillBtn');
        const originalHTML = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Analyzing...';

        try {
            const response = await fetch('/api/watchdog/suggest-config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    llm_id: parseInt(llmSelect.value),
                    prompt_text: promptTextarea.value.trim()
                })
            });

            if (!response.ok) {
                const err = await response.json().catch(() => ({ detail: 'Unknown error' }));
                throw new Error(err.detail || `HTTP ${response.status}`);
            }

            const suggestion = await response.json();
            showWatchdogSuggestionModal(suggestion);

        } catch (error) {
            console.error('Watchdog auto-fill error:', error);
            NotificationModal.error(
                'Auto-fill Error',
                'Could not get AI suggestions. Please try again or configure manually.'
            );
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalHTML;
        }
    }

    function showWatchdogSuggestionModal(suggestion) {
        const fields = [
            {
                key: 'mode',
                label: 'Mode',
                value: suggestion.mode,
                display: suggestion.mode.charAt(0).toUpperCase() + suggestion.mode.slice(1)
            },
            {
                key: 'objectives',
                label: 'Objectives',
                value: suggestion.objectives,
                display: suggestion.objectives.map(o => '- ' + o).join('\n')
            },
            {
                key: 'steering_prompt',
                label: 'Steering Prompt',
                value: suggestion.steering_prompt,
                display: suggestion.steering_prompt
            },
            {
                key: 'frequency',
                label: 'Frequency',
                value: suggestion.frequency,
                display: suggestion.frequency + ' (every ' + suggestion.frequency + ' user turns)'
            },
            {
                key: 'max_hint_chars',
                label: 'Max Hint Chars',
                value: suggestion.max_hint_chars,
                display: String(suggestion.max_hint_chars)
            },
            {
                key: 'max_turns_off_topic',
                label: 'Max Turns Off-Topic',
                value: suggestion.thresholds.max_turns_off_topic,
                display: String(suggestion.thresholds.max_turns_off_topic)
            },
            {
                key: 'max_turns_same_subtopic',
                label: 'Max Turns Same Subtopic',
                value: suggestion.thresholds.max_turns_same_subtopic,
                display: String(suggestion.thresholds.max_turns_same_subtopic)
            }
        ];

        let itemsHTML = fields.map(f => `
            <div class="suggestion-item">
                <input type="checkbox" class="form-check-input suggestion-checkbox"
                       id="suggest_${f.key}" data-key="${f.key}" checked>
                <div>
                    <label class="suggestion-label" for="suggest_${f.key}">${f.label}</label>
                    <div class="suggestion-value">${escapeHtml(f.display)}</div>
                </div>
            </div>
        `).join('');

        const modalBody = document.getElementById('wdSuggestionBody');
        modalBody.innerHTML = `
            <p class="text-muted mb-3" style="font-size: 0.9rem;">
                The AI analyzed your prompt and suggests these settings:
            </p>
            <div class="bulk-actions">
                <a href="#" onclick="toggleAllSuggestions(true); return false;">Select All</a>
                <a href="#" onclick="toggleAllSuggestions(false); return false;">Deselect All</a>
            </div>
            <div class="suggestion-list">${itemsHTML}</div>
        `;

        window._watchdogSuggestion = suggestion;

        updateSuggestionApplyBtn();
        modalBody.querySelectorAll('.suggestion-checkbox').forEach(cb => {
            cb.addEventListener('change', updateSuggestionApplyBtn);
        });

        const modalEl = document.getElementById('watchdogSuggestionModal');
        modalEl.addEventListener('hidden.bs.modal', () => {
            window._watchdogSuggestion = null;
        }, { once: true });
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
    }

    function toggleAllSuggestions(checked) {
        document.querySelectorAll('#wdSuggestionBody .suggestion-checkbox')
            .forEach(cb => { cb.checked = checked; });
        updateSuggestionApplyBtn();
    }

    function updateSuggestionApplyBtn() {
        const checkboxes = document.querySelectorAll('#wdSuggestionBody .suggestion-checkbox');
        const checkedCount = [...checkboxes].filter(cb => cb.checked).length;
        const applyBtn = document.getElementById('wdSuggestionApplyBtn');
        applyBtn.disabled = checkedCount === 0;
        applyBtn.textContent = 'Apply Selected (' + checkedCount + ')';
    }

    function applyWatchdogSuggestions() {
        const suggestion = window._watchdogSuggestion;
        if (!suggestion) return;

        const isChecked = (key) => {
            const cb = document.getElementById('suggest_' + key);
            return cb && cb.checked;
        };

        if (isChecked('mode')) {
            document.getElementById('postWatchdogMode').value = suggestion.mode;
        }
        if (isChecked('objectives')) {
            document.getElementById('postWatchdogObjectives').value =
                suggestion.objectives.join('\n');
        }
        if (isChecked('steering_prompt')) {
            document.getElementById('postWatchdogSteeringPrompt').value =
                suggestion.steering_prompt;
        }
        if (isChecked('frequency')) {
            document.getElementById('postWatchdogFrequency').value = suggestion.frequency;
        }
        if (isChecked('max_hint_chars')) {
            document.getElementById('postWatchdogMaxHintChars').value = suggestion.max_hint_chars;
        }
        if (isChecked('max_turns_off_topic')) {
            document.getElementById('postWatchdogMaxOffTopic').value =
                suggestion.thresholds.max_turns_off_topic;
        }
        if (isChecked('max_turns_same_subtopic')) {
            document.getElementById('postWatchdogMaxSameSubtopic').value =
                suggestion.thresholds.max_turns_same_subtopic;
        }

        // Expand advanced settings if any advanced field was applied
        if (isChecked('max_hint_chars') || isChecked('max_turns_off_topic') || isChecked('max_turns_same_subtopic')) {
            const advancedSection = document.getElementById('postWatchdogAdvanced');
            if (advancedSection.style.display !== 'block') {
                advancedSection.style.display = 'block';
                const toggleIcon = advancedSection.previousElementSibling?.querySelector('i.fas');
                if (toggleIcon) {
                    toggleIcon.classList.replace('fa-caret-right', 'fa-caret-down');
                }
            }
        }

        const modalEl = document.getElementById('watchdogSuggestionModal');
        bootstrap.Modal.getInstance(modalEl)?.hide();
    }

    document.addEventListener('DOMContentLoaded', function() {
        loadVoices();
        loadCategories();
        loadLLMs();
        toggleLLMOptions();

        // Add validation on public checkbox change
        document.getElementById('isPublic').addEventListener('change', function() {
            validateCategories();
            togglePricingSection();
        });

        // Form validation on submit
        document.getElementById('createPromptForm').addEventListener('submit', function(e) {
            serializeWatchdogConfig();
            if (!validateCategories()) {
                e.preventDefault();
                document.getElementById('categoriesSection').scrollIntoView({ behavior: 'smooth' });
                return false;
            }
        });

        const promptImageInput = document.getElementById('promptImageInput');
        const promptImageContainer = document.getElementById('promptImageContainer');
        const previewContainer = document.getElementById('previewContainer');
        const previewImage = document.getElementById('previewImage');

        promptImageContainer.addEventListener('click', function(e) {
            if (e.target.closest('.avatar-icon.edit')) {
                promptImageInput.click();
            }
        });

        previewContainer.addEventListener('click', function(e) {
            if (e.target.closest('.avatar-icon.edit')) {
                promptImageInput.click();
            } else if (e.target.closest('.avatar-icon.cancel')) {
                resetPreview();
            }
        });

        promptImageInput.addEventListener('change', function(event) {
            handleFileSelection(event);
        });

        function handleFileSelection(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    previewContainer.classList.remove('hidden');
                    promptImageContainer.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function resetPreview() {
            previewContainer.classList.add('hidden');
            promptImageContainer.classList.remove('hidden');
            promptImageInput.value = '';
        }
    });
</script>
{% endblock %}
