{% extends 'base.html' %}

{% block title %}Edit Prompt - AURVEK{% endblock %}

{% block styles %}
{# Theme CSS loaded by theme-loader.js - category styles now in default.css #}
{% endblock %}

{% block page_title %}Edit Prompt{% endblock %}

{% block back_url %}/prompts{% endblock %}
{% block back_title %}Back to Prompts{% endblock %}

{% block content %}
<form action="/prompts/update/{{ prompt_id }}" method="post" enctype="multipart/form-data" id="editPromptForm">

    <!-- Section 1: Basic Information -->
    <div class="section-container">
        <div class="section-title"><i class="fas fa-info-circle me-2"></i>Basic Information</div>
        <div class="flex-row">
            <div class="flex-column">
                <div class="mb-3">
                    <label for="promptName" class="form-label">Prompt Name</label>
                    <input type="text" class="form-control" id="promptName" name="name" value="{{ prompt_name }}" required>
                </div>
                <div class="mb-3">
                    <label for="description" class="form-label">Description</label>
                    <textarea class="form-control" id="description" name="description" rows="3">{{ description }}</textarea>
                </div>
            </div>
            <div class="flex-column">
                {% if is_admin or is_owner %}
                <div class="mb-3">
                    <label for="new_owner" class="form-label">Owner</label>
                    <select class="form-select" name="new_owner_id" id="new_owner">
                        {% for user in users %}
                            <option value="{{ user[0] }}" {% if user[0] == current_owner_id %}selected{% endif %}>
                                {{ user[0] }} - {{ user[1] }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Editors</label>
                    <div class="editors-container">
                        <div class="editor-list mb-2">
                            {% for editor in editors %}
                            <div class="editor-item">
                                <span>{{ editor.username }}</span>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeEditor({{ editor.id }})">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="input-group">
                            <select class="form-select" id="editorSelect">
                                {% for user in users %}
                                    <option value="{{ user.id }}">{{ user.username }}</option>
                                {% endfor %}
                            </select>
                            <button class="btn btn-outline-secondary" type="button" onclick="addEditor()">
                                <i class="fas fa-plus me-1"></i>Add
                            </button>
                        </div>
                    </div>
                    <input type="hidden" id="editorIds" name="editor_ids" value="{{ editor_ids }}">
                </div>
                {% else %}
                <div class="mb-3">
                    <label class="form-label">Prompt ID</label>
                    <input type="text" class="form-control" value="{{ prompt_id }}" disabled>
                    <small class="form-text text-muted">Unique identifier for this prompt</small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Section 2: Appearance & Voice -->
    <div class="section-container">
        <div class="section-title"><i class="fas fa-palette me-2"></i>Appearance & Voice</div>
        <div class="flex-row">
            <div class="flex-column d-flex justify-content-center align-items-center">
                <div class="mb-3 text-center">
                    <label for="promptImageInput" class="form-label">Prompt Image</label>
                    <div class="avatar-wrapper" style="margin: 0 auto;">
                        <div class="avatar-container" id="promptImageContainer">
                            {% if image_url %}
                                <img src="{{ image_url }}" alt="Prompt Image" id="currentPromptImage">
                                <div class="avatar-icons">
                                    <span class="avatar-icon edit"><i class="fas fa-pencil-alt"></i></span>
                                    <span class="avatar-icon delete"><i class="fas fa-trash"></i></span>
                                </div>
                            {% else %}
                                <span class="avatar-initial" id="defaultPromptInitial">{{ prompt_name|first|upper }}</span>
                                <div class="avatar-icons">
                                    <span class="avatar-icon edit"><i class="fas fa-pencil-alt"></i></span>
                                </div>
                            {% endif %}
                        </div>
                        <div class="avatar-preview hidden" id="previewContainer">
                            <img id="previewImage" alt="Preview">
                            <div class="avatar-icons">
                                <span class="avatar-icon edit"><i class="fas fa-pencil-alt"></i></span>
                                <span class="avatar-icon cancel"><i class="fas fa-times"></i></span>
                            </div>
                        </div>
                        <input type="file" id="promptImageInput" name="image" accept="image/*">
                    </div>
                </div>
            </div>
            <div class="flex-column">
                <div class="voice-section">
                    <label for="voiceSelect" class="form-label">
                        <i class="fas fa-microphone me-1"></i>Voice
                    </label>
                    <div class="voice-controls">
                        <select class="form-select" id="voiceSelect" name="sample_voice_id" required>
                            <!-- Options will be loaded dynamically -->
                        </select>
                        <select class="form-select" id="sampleCategory" style="display: none;">
                            <!-- Categories will be loaded dynamically -->
                        </select>
                        <button type="button" class="btn" id="playVoiceButton" style="display: none;">
                            <i class="fas fa-play"></i>Play Sample
                        </button>
                    </div>
                    <small class="form-text text-muted mt-2">Select a voice for this prompt's text-to-speech.</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Section 3: Prompt Content -->
    <div class="section-container">
        <div class="section-title"><i class="fas fa-file-alt me-2"></i>Prompt Content</div>
        <div class="mb-3">
            <label for="promptText" class="form-label">Prompt Text</label>
            <textarea class="form-control" id="promptText" name="prompt" rows="10">{{ prompt_text }}</textarea>
            <small class="form-text text-muted">The system prompt that defines the AI's personality and behavior</small>
        </div>
    </div>

    <!-- Section: Extensions -->
    <div class="section-container">
        <div class="section-title"><i class="fas fa-layer-group me-2"></i>Extensions (Levels / Phases)</div>

        <!-- Enable toggle -->
        <div class="mb-3 form-check form-switch">
            <input class="form-check-input" type="checkbox" id="extensions_enabled" name="extensions_enabled_toggle"
                   {% if extensions_enabled %}checked{% endif %}
                   onchange="toggleExtensionsPanel()">
            <label class="form-check-label" for="extensions_enabled">
                Enable Extensions
                <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip"
                   title="Extensions add levels/phases to your prompt. The main prompt defines the base personality. Each extension adds specific instructions for a level or phase."></i>
            </label>
        </div>

        <!-- Extensions panel (shown when enabled) -->
        <div id="extensions-panel" style="display: none;">
            <!-- Config options -->
            <div class="flex-row mb-3">
                <div class="flex-column">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="extensions_auto_advance"
                               {% if extensions_auto_advance %}checked{% endif %}>
                        <label class="form-check-label" for="extensions_auto_advance">
                            AI can auto-advance
                            <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip"
                               title="When enabled, the AI can decide when to move to the next level during the conversation."></i>
                        </label>
                    </div>
                </div>
                <div class="flex-column">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="extensions_free_selection"
                               {% if extensions_free_selection is not defined or extensions_free_selection %}checked{% endif %}>
                        <label class="form-check-label" for="extensions_free_selection">
                            Users can select any level
                            <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip"
                               title="When enabled, users can jump to any level. When disabled, levels must be followed in order."></i>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Extension list -->
            <div id="extensions-list" class="mb-3">
                <!-- Populated by JS -->
            </div>

            <!-- Add button -->
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="showExtensionEditor()">
                <i class="fas fa-plus"></i> Add Extension
            </button>

            <!-- Inline editor (hidden by default) -->
            <div id="extension-editor" class="mt-3" style="display: none; border: 1px solid var(--border-color); border-radius: 8px; padding: 16px;">
                <h6 id="extension-editor-title">New Extension</h6>
                <input type="hidden" id="extension-editor-id" value="">

                <div class="mb-2">
                    <label for="ext-name" class="form-label">Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-control form-control-sm" id="ext-name" placeholder="e.g., Childhood, Level BOSS, Beginner">
                </div>

                <div class="mb-2">
                    <label for="ext-description" class="form-label">Description</label>
                    <input type="text" class="form-control form-control-sm" id="ext-description" placeholder="Short description of what this level covers">
                </div>

                <div class="mb-2">
                    <label for="ext-prompt-text" class="form-label">Extension Prompt <span class="text-danger">*</span></label>
                    <textarea class="form-control form-control-sm" id="ext-prompt-text" rows="6" placeholder="Additional instructions for this level. This text is appended to the main prompt when this extension is active."></textarea>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="ext-is-default">
                    <label class="form-check-label" for="ext-is-default">Set as default level</label>
                </div>

                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-sm btn-primary" onclick="saveExtension()">Save</button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="hideExtensionEditor()">Cancel</button>
                </div>
            </div>
        </div>

        <input type="hidden" name="extensions_enabled" id="hidden_extensions_enabled" value="0">
        <input type="hidden" name="extensions_auto_advance" id="hidden_extensions_auto_advance" value="0">
        <input type="hidden" name="extensions_free_selection" id="hidden_extensions_free_selection" value="1">
    </div>

    <!-- Section: Welcome Message -->
    <div class="section-container">
        <div class="section-title"><i class="fas fa-hand-wave me-2"></i>Welcome Message</div>
        <p class="text-muted small mb-2">HTML welcome message shown to users on the home page for this prompt.</p>
        <textarea id="prompt-welcome-editor" class="form-control" rows="6" placeholder="Write HTML content for your welcome message..."></textarea>
        <div class="mt-2 d-flex gap-2">
            <button type="button" class="btn btn-sm btn-primary" onclick="savePromptWelcome()">
                <i class="fas fa-save me-1"></i> Save Welcome
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="previewPromptWelcome()">
                <i class="fas fa-eye me-1"></i> Preview
            </button>
        </div>
    </div>

    <!-- Section: Welcome Page (AI Wizard) -->
    <div class="section-container">
        <div class="section-title">
            <i class="fas fa-door-open me-2"></i>Welcome Page
            <span id="welcome-status-badge" class="badge bg-secondary ms-2" style="font-size: 0.75rem;">Checking...</span>
        </div>
        <p class="text-muted small mb-3">
            An immersive welcome page for authenticated users. Generated by AI in the background.
        </p>

        <!-- File list -->
        <div id="welcome-file-list" class="mb-3" style="display: none;">
            <label class="form-label small fw-semibold">Current files:</label>
            <ul id="welcome-files-ul" class="list-unstyled small text-muted mb-0"></ul>
        </div>

        <!-- Progress indicator (shown during active job) -->
        <div id="welcome-progress" class="text-center py-3 mb-3" style="display: none; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-tertiary);">
            <div class="spinner-border spinner-border-sm text-primary mb-2" role="status"></div>
            <p class="mb-0 small fw-semibold">AI job in progress...</p>
            <small class="text-muted" id="welcome-progress-text">Checking status...</small>
        </div>

        <!-- Action buttons -->
        <div class="d-flex gap-2 flex-wrap">
            <button type="button" class="btn btn-sm btn-primary" id="welcome-generate-btn" onclick="welcomeOpenGenerateModal()">
                <i class="fas fa-magic me-1"></i> Generate Welcome Page
            </button>
            <button type="button" class="btn btn-sm btn-outline-primary" id="welcome-modify-btn" onclick="welcomeOpenModifyModal()" style="display: none;">
                <i class="fas fa-edit me-1"></i> Modify Welcome Page
            </button>
            <button type="button" class="btn btn-sm btn-outline-danger" id="welcome-delete-btn" onclick="welcomeDeleteFiles()" style="display: none;">
                <i class="fas fa-trash me-1"></i> Delete Welcome Files
            </button>
        </div>
    </div>

    <!-- Welcome Page Generate Modal -->
    <div class="modal fade" id="welcome-wizard-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--bg-tertiary); border-color: var(--border-color);">
                    <h5 class="modal-title"><i class="fas fa-magic me-2" style="color: var(--accent);"></i>Generate Welcome Page</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="background: var(--bg-secondary); color: var(--text-primary);">
                    <!-- Description -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Describe the welcome experience *</label>
                        <textarea id="welcome-wizard-description" class="form-control" rows="4"
                            placeholder="Example: An immersive onboarding page that introduces the user to the AI coach, explains how sessions work, and sets expectations..."></textarea>
                        <small class="text-muted">Minimum 20 characters. The more detailed, the better.</small>
                    </div>

                    <!-- Style -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Visual style</label>
                        <div class="btn-group d-flex" role="group">
                            <input type="radio" class="btn-check" name="welcomeWizardStyle" id="welcomeStyleModern" value="modern" checked>
                            <label class="btn btn-outline-primary" for="welcomeStyleModern">Modern</label>
                            <input type="radio" class="btn-check" name="welcomeWizardStyle" id="welcomeStyleMinimalist" value="minimalist">
                            <label class="btn btn-outline-primary" for="welcomeStyleMinimalist">Minimalist</label>
                            <input type="radio" class="btn-check" name="welcomeWizardStyle" id="welcomeStyleCorporate" value="corporate">
                            <label class="btn btn-outline-primary" for="welcomeStyleCorporate">Corporate</label>
                            <input type="radio" class="btn-check" name="welcomeWizardStyle" id="welcomeStyleCreative" value="creative">
                            <label class="btn btn-outline-primary" for="welcomeStyleCreative">Creative</label>
                        </div>
                    </div>

                    <!-- Colors -->
                    <div class="row mb-4">
                        <div class="col-6">
                            <label class="form-label fw-semibold">Primary color</label>
                            <div class="input-group">
                                <input type="color" id="welcome-primary-color" class="form-control form-control-color" value="#3B82F6">
                                <input type="text" id="welcome-primary-color-text" class="form-control" value="#3B82F6" pattern="^#[0-9A-Fa-f]{6}$">
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="form-label fw-semibold">Secondary color</label>
                            <div class="input-group">
                                <input type="color" id="welcome-secondary-color" class="form-control form-control-color" value="#10B981">
                                <input type="text" id="welcome-secondary-color-text" class="form-control" value="#10B981" pattern="^#[0-9A-Fa-f]{6}$">
                            </div>
                        </div>
                    </div>

                    <!-- Language -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Content language</label>
                        <select id="welcome-wizard-language" class="form-select" style="max-width: 200px;">
                            <option value="es">Spanish</option>
                            <option value="en">English</option>
                        </select>
                    </div>

                    <!-- Timeout -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Maximum execution time</label>
                        <div class="input-group" style="max-width: 200px;">
                            <input type="number" id="welcome-wizard-timeout" class="form-control" value="5" min="1" max="60">
                            <span class="input-group-text">minutes</span>
                        </div>
                        <small class="text-muted">Max: 60 minutes.</small>
                    </div>

                    <!-- Progress -->
                    <div id="welcome-wizard-progress" class="text-center py-4" style="display: none;">
                        <div class="spinner-border text-primary mb-3" role="status"></div>
                        <p class="mb-0 fw-semibold">Generating welcome page...</p>
                        <small class="text-muted">Please wait...</small>
                    </div>

                    <!-- Error -->
                    <div id="welcome-wizard-error" class="alert alert-danger" style="display: none;"></div>
                </div>
                <div class="modal-footer" style="background: var(--bg-tertiary); border-color: var(--border-color);">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="welcome-wizard-cancel-btn">Cancel</button>
                    <button type="button" class="btn btn-primary" id="welcome-wizard-generate-btn" onclick="welcomeGenerate()">
                        <i class="fas fa-wand-magic-sparkles me-1"></i> Generate Welcome Page
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Welcome Page Modify Modal -->
    <div class="modal fade" id="welcome-modify-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--bg-tertiary); border-color: var(--border-color);">
                    <h5 class="modal-title"><i class="fas fa-edit me-2" style="color: var(--accent);"></i>Modify Welcome Page</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="background: var(--bg-secondary); color: var(--text-primary);">
                    <!-- Current files -->
                    <div class="alert alert-secondary mb-4">
                        <strong><i class="fas fa-folder-open me-2"></i>Current files:</strong>
                        <div id="welcome-modify-file-list" class="mt-2 small"></div>
                    </div>

                    <!-- Instructions -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold">What would you like to change?</label>
                        <textarea id="welcome-modify-instructions" class="form-control" rows="5"
                            placeholder="Example: Add a progress indicator at the top, change the color scheme to warmer tones..."></textarea>
                        <small class="text-muted">Minimum 10 characters.</small>
                    </div>

                    <!-- Timeout -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Maximum execution time</label>
                        <div class="input-group" style="max-width: 200px;">
                            <input type="number" id="welcome-modify-timeout" class="form-control" value="5" min="1" max="60">
                            <span class="input-group-text">minutes</span>
                        </div>
                        <small class="text-muted">Max: 60 minutes.</small>
                    </div>

                    <!-- Progress -->
                    <div id="welcome-modify-progress" class="text-center py-4" style="display: none;">
                        <div class="spinner-border text-primary mb-3" role="status"></div>
                        <p class="mb-0 fw-semibold">Applying modifications...</p>
                        <small class="text-muted">Working on changes...</small>
                    </div>

                    <!-- Error -->
                    <div id="welcome-modify-error" class="alert alert-danger mt-3" style="display: none;"></div>
                </div>
                <div class="modal-footer" style="background: var(--bg-tertiary); border-color: var(--border-color);">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="welcome-modify-cancel-btn">Cancel</button>
                    <button type="button" class="btn btn-primary" id="welcome-modify-apply-btn" onclick="welcomeApplyModifications()">
                        <i class="fas fa-check me-1"></i> Apply Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Section 4: Settings -->
    <div class="section-container">
        <div class="section-title"><i class="fas fa-cog me-2"></i>Settings</div>
        <div class="flex-row">
            <div class="flex-column">
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="isPublic" name="public" {% if is_public %}checked{% endif %}>
                    <label class="form-check-label" for="isPublic">
                        <i class="fas fa-globe me-1 text-muted"></i>Share My Prompt
                    </label>
                    <small class="form-text text-muted d-block">Share with the community and earn money when others use it</small>
                </div>
                <!-- Pack inclusion settings (nested under Share My Prompt) -->
                <div id="packSettings" style="padding-left: 24px; display: {% if is_public %}block{% else %}none{% endif %};">
                    <div class="mb-2 form-check">
                        <input type="checkbox" class="form-check-input" id="allowInPacks" name="allow_in_packs" {% if allow_in_packs %}checked{% endif %} onchange="togglePackOptions()">
                        <label class="form-check-label" for="allowInPacks">
                            <i class="fas fa-box me-1 text-muted"></i>Allow others to include this prompt in packs
                        </label>
                        <small class="form-text text-muted d-block">You'll earn your markup on every use, even inside packs.</small>
                    </div>
                    <div id="noticePeriodOptions" style="padding-left: 24px; display: {% if allow_in_packs %}block{% else %}none{% endif %};">
                        <label for="noticePeriod" class="form-label mb-1"><small>Removal notice period:</small></label>
                        <select class="form-select form-select-sm" id="noticePeriod" name="pack_notice_period_days" style="max-width: 200px;">
                            <option value="0" {% if pack_notice_period_days == 0 %}selected{% endif %} {% if pack_notice_period_days > 0 %}disabled{% endif %}>None{% if pack_notice_period_days == 0 %} (current){% endif %}</option>
                            <option value="90" {% if pack_notice_period_days == 90 %}selected{% endif %} {% if pack_notice_period_days > 90 %}disabled{% endif %}>90 days{% if pack_notice_period_days == 90 %} (current){% endif %}</option>
                            <option value="180" {% if pack_notice_period_days == 180 %}selected{% endif %} {% if pack_notice_period_days > 180 %}disabled{% endif %}>180 days{% if pack_notice_period_days == 180 %} (current){% endif %}</option>
                            <option value="365" {% if pack_notice_period_days == 365 %}selected{% endif %} {% if pack_notice_period_days > 365 %}disabled{% endif %}>1 year{% if pack_notice_period_days == 365 %} (current){% endif %}</option>
                            <option value="730" {% if pack_notice_period_days == 730 %}selected{% endif %}>2 years{% if pack_notice_period_days == 730 %} (current){% endif %}</option>
                        </select>
                        <small class="form-text text-muted d-block mt-1">
                            <i class="fas fa-info-circle me-1"></i>Once set, you can only increase this period. A longer period signals reliability to pack creators.
                        </small>
                    </div>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="disableWebSearch" name="disable_web_search" {% if disable_web_search %}checked{% endif %}>
                    <label class="form-check-label" for="disableWebSearch">
                        <i class="fas fa-globe-americas me-1 text-muted"></i>Disable Web Search
                    </label>
                    <small class="form-text text-muted d-block">Prevent AI from searching the internet when using this prompt</small>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="enableModeration" name="enable_moderation" {% if enable_moderation %}checked{% endif %}>
                    <label class="form-check-label" for="enableModeration">
                        <i class="fas fa-shield-alt me-1 text-muted"></i>Enable Content Moderation
                        <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Messages are checked by OpenAI's moderation API before processing. Flags inappropriate content like hate speech, violence, sexual content, self-harm, etc."></i>
                    </label>
                    <small class="form-text text-muted d-block">Pre-screen user messages for inappropriate content before AI responds</small>
                </div>

                <!-- AI Model Restrictions -->
                <div class="mt-4 pt-3" style="border-top: 1px solid var(--border-color);">
                    <label class="form-label"><i class="fas fa-robot me-1 text-muted"></i>AI Model Restrictions</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="llm_mode" id="llmModeAny" value="any" {% if not forced_llm_id and allowed_llms_json == '[]' %}checked{% endif %} onchange="toggleLLMOptions()">
                        <label class="form-check-label" for="llmModeAny">
                            Any model (user chooses)
                        </label>
                    </div>
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="radio" name="llm_mode" id="llmModeRestricted" value="restricted" {% if allowed_llms_json != '[]' and not forced_llm_id %}checked{% endif %} onchange="toggleLLMOptions()">
                        <label class="form-check-label" for="llmModeRestricted">
                            Restrict to specific models
                            <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Users can only choose from the selected models when using this prompt."></i>
                        </label>
                    </div>
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="radio" name="llm_mode" id="llmModeForced" value="forced" {% if forced_llm_id %}checked{% endif %} onchange="toggleLLMOptions()">
                        <label class="form-check-label" for="llmModeForced">
                            Force specific model
                            <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="When enabled, users cannot choose a different AI model. The selected model will always be used for this prompt."></i>
                        </label>
                    </div>

                    <!-- Restricted options: checkbox list of models -->
                    <div id="restrictedLLMOptions" class="mt-2" style="display: {% if allowed_llms_json != '[]' and not forced_llm_id %}block{% else %}none{% endif %};">
                        <div id="llmCheckboxList" class="ms-3" style="max-height: 220px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 6px; padding: 8px;"></div>
                        <input type="hidden" id="allowedLLMsInput" name="allowed_llms">
                    </div>

                    <!-- Forced options: single select + hide name -->
                    <div id="forcedLLMOptions" style="{% if not forced_llm_id %}display: none;{% endif %}">
                        <div class="mb-3 mt-2">
                            <label for="forcedLLM" class="form-label">Select Model</label>
                            <select class="form-select" id="forcedLLM" name="forced_llm_id">
                                <!-- LLMs loaded dynamically -->
                            </select>
                        </div>
                        <div class="form-check mb-3">
                            <input type="checkbox" class="form-check-input" id="hideLLMName" name="hide_llm_name" {% if hide_llm_name %}checked{% endif %}>
                            <label class="form-check-label" for="hideLLMName">
                                Hide model name in chat UI
                                <small class="text-muted d-block">Show "AI" instead of model name</small>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section: Watchdog Configuration -->
    <div class="section-container">
        <div class="section-title"><i class="fas fa-eye me-2"></i>Watchdog Configuration</div>

        <!-- Pre-Watchdog Sub-Section -->
        <div class="watchdog-subsection mb-4" style="border: 1px solid var(--border-color); border-radius: 8px; padding: 16px;">
            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="preWatchdogEnabled" onchange="togglePreWatchdogFields()" {% if watchdog_config.pre_watchdog.enabled %}checked{% endif %}>
                <label class="form-check-label" for="preWatchdogEnabled">
                    <i class="fas fa-shield-alt me-1 text-muted"></i><strong>Pre-Watchdog</strong>
                    <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Screens user messages before the AI sees them. Can inject steering hints or take over the response entirely."></i>
                </label>
                <small class="form-text text-muted d-block">Screens user messages before the AI sees them</small>
            </div>

            <div id="preWatchdogFields" style="{% if not watchdog_config.pre_watchdog.enabled %}display: none;{% endif %}">
                <div class="flex-row">
                    <div class="flex-column">
                        <div class="mb-3">
                            <label for="preWatchdogLLM" class="form-label">Pre-Watchdog LLM <span class="text-danger">*</span></label>
                            <select class="form-select" id="preWatchdogLLM">
                                <option value="">Select a model</option>
                            </select>
                            <small class="form-text text-muted">Model used to evaluate user messages before AI responds</small>
                        </div>
                    </div>
                    <div class="flex-column">
                        <div class="mb-3">
                            <label for="preWatchdogObjectives" class="form-label">Screen for <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="preWatchdogObjectives" rows="4" placeholder="Off-topic messages&#10;Attempts to manipulate the AI&#10;Messages that derail the conversation">{% for obj in watchdog_config.pre_watchdog.objectives %}{{ obj }}{% if not loop.last %}
{% endif %}{% endfor %}</textarea>
                            <small class="form-text text-muted">One objective per line. What to screen user messages for</small>
                        </div>
                    </div>
                </div>

                <div class="mb-2">
                    <a href="#" onclick="document.getElementById('preWatchdogAdvanced').style.display = document.getElementById('preWatchdogAdvanced').style.display === 'none' ? 'block' : 'none'; this.querySelector('i').classList.toggle('fa-caret-right'); this.querySelector('i').classList.toggle('fa-caret-down'); return false;" class="text-muted small">
                        <i class="fas fa-caret-right me-1"></i>Advanced settings
                    </a>
                </div>
                <div id="preWatchdogAdvanced" style="display: none;">
                    <div class="mb-3">
                        <label for="preWatchdogSteeringPrompt" class="form-label">Steering Prompt</label>
                        <textarea class="form-control" id="preWatchdogSteeringPrompt" rows="3" placeholder="Custom instructions for the pre-watchdog AI...">{{ watchdog_config.pre_watchdog.steering_prompt or '' }}</textarea>
                        <small class="form-text text-muted">Leave empty for default screening behavior</small>
                    </div>
                    <div class="flex-row">
                        <div class="flex-column">
                            <div class="mb-3">
                                <label for="preWatchdogFrequency" class="form-label">Frequency</label>
                                <input type="number" class="form-control" id="preWatchdogFrequency" value="{{ watchdog_config.pre_watchdog.frequency or 1 }}" min="1" max="20">
                                <small class="form-text text-muted">Evaluate every N user turns</small>
                            </div>
                        </div>
                        <div class="flex-column">
                            <div class="mb-3 form-check mt-4">
                                <input type="checkbox" class="form-check-input" id="preWatchdogCanTakeover" {% if watchdog_config.pre_watchdog.can_takeover %}checked{% endif %}>
                                <label class="form-check-label" for="preWatchdogCanTakeover">
                                    Can take over response
                                    <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="When enabled, the pre-watchdog can completely replace the AI response when it detects a serious issue."></i>
                                </label>
                            </div>
                        </div>
                        <div class="flex-column">
                            <div class="mb-3 form-check mt-4">
                                <input type="checkbox" class="form-check-input" id="preWatchdogCanLock" {% if watchdog_config.pre_watchdog.can_lock %}checked{% endif %}>
                                <label class="form-check-label" for="preWatchdogCanLock">
                                    Can lock conversation
                                    <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="When enabled, the pre-watchdog can permanently lock the conversation on critical alerts."></i>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Post-Watchdog Sub-Section -->
        <div class="watchdog-subsection" style="border: 1px solid var(--border-color); border-radius: 8px; padding: 16px;">
            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="postWatchdogEnabled" onchange="togglePostWatchdogFields()" {% if watchdog_config.post_watchdog.enabled %}checked{% endif %}>
                <label class="form-check-label" for="postWatchdogEnabled">
                    <i class="fas fa-eye me-1 text-muted"></i><strong>Post-Watchdog</strong>
                    <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Monitors the conversation after each AI response and steers it toward objectives. Runs in background."></i>
                </label>
                <small class="form-text text-muted d-block">Monitors the conversation and steers the AI</small>
            </div>

            <div id="postWatchdogFields" style="{% if not watchdog_config.post_watchdog.enabled %}display: none;{% endif %}">
                <div class="mb-3 d-flex align-items-center gap-2">
                    <button type="button" class="btn btn-outline-primary btn-sm" id="watchdogAutoFillBtn"
                            onclick="requestWatchdogAutoFill()">
                        <i class="fas fa-wand-magic-sparkles me-1"></i>AI Auto-fill
                    </button>
                    <i class="fas fa-info-circle text-muted"
                       data-bs-toggle="tooltip" data-bs-placement="right"
                       title="Uses the selected Post-Watchdog LLM to analyze your prompt and suggest optimal settings (mode, objectives, steering prompt, frequency, thresholds)."></i>
                </div>
                <div class="flex-row">
                    <div class="flex-column">
                        <div class="mb-3">
                            <label for="postWatchdogLLM" class="form-label">Post-Watchdog LLM <span class="text-danger">*</span></label>
                            <select class="form-select" id="postWatchdogLLM">
                                <option value="">Select a model</option>
                            </select>
                            <small class="form-text text-muted">Model used to evaluate conversations after AI responds</small>
                        </div>
                        <div class="mb-3">
                            <label for="postWatchdogMode" class="form-label">Mode</label>
                            <select class="form-select" id="postWatchdogMode">
                                <option value="interview" {% if watchdog_config.post_watchdog.mode == 'interview' %}selected{% endif %}>Interview</option>
                                <option value="coaching" {% if watchdog_config.post_watchdog.mode == 'coaching' %}selected{% endif %}>Coaching</option>
                                <option value="education" {% if watchdog_config.post_watchdog.mode == 'education' %}selected{% endif %}>Education</option>
                                <option value="custom" {% if watchdog_config.post_watchdog.mode == 'custom' %}selected{% endif %}>Custom</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex-column">
                        <div class="mb-3">
                            <label for="postWatchdogObjectives" class="form-label">Objectives <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="postWatchdogObjectives" rows="4" placeholder="Track topic coverage&#10;Detect drift from objectives&#10;Flag factual inconsistencies">{% for obj in watchdog_config.post_watchdog.objectives %}{{ obj }}{% if not loop.last %}
{% endif %}{% endfor %}</textarea>
                            <small class="form-text text-muted">One objective per line. These tell the watchdog what to evaluate</small>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="postWatchdogSteeringPrompt" class="form-label">Steering Prompt</label>
                    <textarea class="form-control" id="postWatchdogSteeringPrompt" rows="3" placeholder="Custom instructions for the watchdog AI...">{{ watchdog_config.post_watchdog.steering_prompt or '' }}</textarea>
                    <small class="form-text text-muted">Leave empty for a default prompt based on the selected mode</small>
                </div>
                <div class="flex-row">
                    <div class="flex-column">
                        <div class="mb-3">
                            <label for="postWatchdogFrequency" class="form-label">Frequency</label>
                            <input type="number" class="form-control" id="postWatchdogFrequency" value="{{ watchdog_config.post_watchdog.frequency or 3 }}" min="1" max="20">
                            <small class="form-text text-muted">Evaluate every N user turns (not every message)</small>
                        </div>
                    </div>
                    <div class="flex-column"></div>
                </div>

                <!-- Post-Watchdog Takeover Settings -->
                <div class="mb-2">
                    <a href="#" onclick="document.getElementById('postWatchdogTakeover').style.display = document.getElementById('postWatchdogTakeover').style.display === 'none' ? 'block' : 'none'; this.querySelector('i').classList.toggle('fa-caret-right'); this.querySelector('i').classList.toggle('fa-caret-down'); return false;" class="text-muted small">
                        <i class="fas fa-caret-right me-1"></i>Takeover settings
                    </a>
                </div>
                <div id="postWatchdogTakeover" style="display: none;">
                    <div class="flex-row">
                        <div class="flex-column">
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="postWatchdogCanTakeover" {% if watchdog_config.post_watchdog.can_takeover %}checked{% endif %}>
                                <label class="form-check-label" for="postWatchdogCanTakeover">
                                    Can take over response
                                    <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="After N consecutive hints are ignored, the watchdog takes over the AI response."></i>
                                </label>
                            </div>
                        </div>
                        <div class="flex-column">
                            <div class="mb-3">
                                <label for="postWatchdogTakeoverThreshold" class="form-label">Takeover threshold</label>
                                <input type="number" class="form-control" id="postWatchdogTakeoverThreshold" value="{{ watchdog_config.post_watchdog.takeover_threshold or 5 }}" min="1" max="50">
                                <small class="form-text text-muted">Consecutive ignored hints before takeover</small>
                            </div>
                        </div>
                        <div class="flex-column">
                            <div class="mb-3 form-check mt-4">
                                <input type="checkbox" class="form-check-input" id="postWatchdogCanLock" {% if watchdog_config.post_watchdog.can_lock %}checked{% endif %}>
                                <label class="form-check-label" for="postWatchdogCanLock">
                                    Can lock conversation
                                    <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="When enabled, the post-watchdog can permanently lock the conversation on takeover."></i>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Post-Watchdog Advanced Settings -->
                <div class="mb-2">
                    <a href="#" onclick="document.getElementById('postWatchdogAdvanced').style.display = document.getElementById('postWatchdogAdvanced').style.display === 'none' ? 'block' : 'none'; this.querySelector('i').classList.toggle('fa-caret-right'); this.querySelector('i').classList.toggle('fa-caret-down'); return false;" class="text-muted small">
                        <i class="fas fa-caret-right me-1"></i>Advanced settings
                    </a>
                </div>
                <div id="postWatchdogAdvanced" style="display: none;">
                    <div class="flex-row">
                        <div class="flex-column">
                            <div class="mb-3">
                                <label for="postWatchdogMaxHintChars" class="form-label">Max hint chars</label>
                                <input type="number" class="form-control" id="postWatchdogMaxHintChars" value="{{ watchdog_config.post_watchdog.max_hint_chars or 500 }}" min="100" max="2000">
                            </div>
                        </div>
                        <div class="flex-column">
                            <div class="mb-3">
                                <label for="postWatchdogMaxOffTopic" class="form-label">Max turns off-topic</label>
                                <input type="number" class="form-control" id="postWatchdogMaxOffTopic" value="{{ watchdog_config.post_watchdog.thresholds.max_turns_off_topic or 3 }}" min="1" max="50">
                            </div>
                        </div>
                        <div class="flex-column">
                            <div class="mb-3">
                                <label for="postWatchdogMaxSameSubtopic" class="form-label">Max turns same subtopic</label>
                                <input type="number" class="form-control" id="postWatchdogMaxSameSubtopic" value="{{ watchdog_config.post_watchdog.thresholds.max_turns_same_subtopic or 5 }}" min="1" max="50">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <input type="hidden" id="watchdogConfigInput" name="watchdog_config" value="">
    </div>

    <!-- Section 5: Categories (shown for public prompts) -->
    <div class="section-container" id="categoriesSection" style="{% if not is_public %}display: none;{% endif %}">
        <div class="section-title"><i class="fas fa-tags me-2"></i>Categories</div>
        <p class="text-muted small mb-3">Select at least one category for your public prompt</p>
        <div class="categories-grid" id="categoriesGrid">
            <!-- Categories will be loaded dynamically -->
            <div class="text-center py-3">
                <div class="spinner-border spinner-border-sm" role="status"></div>
                <span class="ms-2">Loading categories...</span>
            </div>
        </div>
        <input type="hidden" id="categoryIds" name="category_ids" value="">
        <div id="categoryError" class="text-danger small mt-2" style="display: none;">
            Public prompts require at least one category
        </div>
    </div>

    <!-- Section 6: Pricing (shown for public prompts) -->
    <div class="section-container" id="pricingSection" style="{% if not is_public %}display: none;{% endif %}">
        <div class="section-title"><i class="fas fa-dollar-sign me-2"></i>Monetization</div>
        <p class="text-muted small mb-3">Configure pricing for your public prompt. You earn 70% of your markup when others use it.</p>

        <div class="mb-3">
            <label class="form-label">Pricing Model</label>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="is_paid" id="pricingFree" value="0" {% if not is_paid %}checked{% endif %} onchange="togglePricingOptions()">
                <label class="form-check-label" for="pricingFree">
                    <i class="fas fa-gift me-1 text-success"></i>Free
                    <small class="text-muted d-block">Anyone can use without paying markup</small>
                </label>
            </div>
            <div class="form-check mt-2">
                <input class="form-check-input" type="radio" name="is_paid" id="pricingPaid" value="1" {% if is_paid %}checked{% endif %} onchange="togglePricingOptions()">
                <label class="form-check-label" for="pricingPaid">
                    <i class="fas fa-coins me-1 text-warning"></i>Paid
                    <small class="text-muted d-block">Earn money when others use this prompt</small>
                </label>
            </div>
        </div>

        <div id="markupOptions" style="{% if not is_paid %}display: none;{% endif %}">
            <div class="mb-3">
                <label for="markupInput" class="form-label">Your Markup ($ per million tokens)</label>
                <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input type="text" class="form-control" id="markupInput" name="markup_per_mtokens"
                           value="{{ markup_per_mtokens or 0 }}" inputmode="decimal" pattern="[0-9]*\.?[0-9]*"
                           oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1'); updateEarningsPreview()">
                    <span class="input-group-text">/ Mtokens</span>
                </div>
            </div>

            <div class="alert alert-success" id="earningsPreview">
                <i class="fas fa-calculator me-2"></i>
                <strong>You will earn:</strong> <span id="previewEarnings">$0.00</span> per million tokens (70% of markup)
            </div>

            <div class="mb-3 mt-3">
                <label for="purchasePriceInput" class="form-label">One-time purchase price (USD)</label>
                <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input type="number" class="form-control" id="purchasePriceInput" name="purchase_price"
                           value="{{ purchase_price if purchase_price is not none else '' }}"
                           step="0.01" min="0" placeholder="Leave empty to disable individual purchase">
                </div>
                <small class="text-muted">Set a one-time price for users to buy permanent access to this prompt. Leave empty to disable individual purchases. Set to 0 for free access grants.</small>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-1"></i>Save Changes
        </button>
        <button type="button" class="btn btn-secondary" onclick="window.history.back();">
            <i class="fas fa-arrow-left me-1"></i>Back
        </button>
    </div>
</form>

<!-- Watchdog AI Suggestion Modal -->
<div class="modal fade" id="watchdogSuggestionModal" tabindex="-1"
     aria-labelledby="wdSuggestionLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <div class="d-flex align-items-center">
                    <i class="fas fa-wand-magic-sparkles me-2" style="color: var(--accent);"></i>
                    <h5 class="modal-title mb-0" id="wdSuggestionLabel">AI Suggested Configuration</h5>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="wdSuggestionBody">
                <!-- Populated dynamically by JS -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="wdSuggestionApplyBtn"
                        onclick="applyWatchdogSuggestions()">
                    Apply Selected (7)
                </button>
            </div>
        </div>
    </div>
</div>

<style>
#watchdogSuggestionModal .modal-content {
    background-color: var(--bg-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
}
#watchdogSuggestionModal .modal-header {
    background-color: var(--bg-tertiary);
    border-bottom: 1px solid var(--border-color);
}
#watchdogSuggestionModal .modal-footer {
    background-color: var(--bg-tertiary);
    border-top: 1px solid var(--border-color);
}
#watchdogSuggestionModal .suggestion-item {
    padding: 10px 0;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: flex-start;
    gap: 10px;
}
#watchdogSuggestionModal .suggestion-item:last-child {
    border-bottom: none;
}
#watchdogSuggestionModal .suggestion-label {
    font-weight: 600;
    color: var(--text-primary);
    cursor: pointer;
}
#watchdogSuggestionModal .suggestion-value {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-top: 2px;
    white-space: pre-wrap;
    max-height: 150px;
    overflow-y: auto;
}
#watchdogSuggestionModal .bulk-actions {
    display: flex;
    gap: 16px;
    margin-bottom: 8px;
}
#watchdogSuggestionModal .bulk-actions a {
    font-size: 0.85rem;
    cursor: pointer;
    color: var(--accent);
    text-decoration: none;
}
#watchdogSuggestionModal .bulk-actions a:hover {
    text-decoration: underline;
}
#watchdogSuggestionModal .suggestion-list {
    background: var(--bg-tertiary);
    border-radius: 6px;
    padding: 4px 16px;
    border: 1px solid var(--border-color);
}
.extension-item.drag-over {
    border-color: var(--accent, #6366f1) !important;
    background: rgba(99, 102, 241, 0.05);
}
.extension-drag-handle:hover {
    color: var(--accent, #6366f1) !important;
}
</style>
{% endblock %}

{% block scripts_inline %}
<script>
    let editors = {{ editor_ids | tojson }};
    let currentVoiceId = "{{ voice_code }}";
    let audioPlayer = null;
    let selectedCategories = [];
    const PROMPT_ID_FOR_CATEGORIES = {{ prompt_id }};
    const currentForcedLLMId = {{ forced_llm_id or 'null' }};
    const currentAllowedLLMs = {{ allowed_llms_json }};
    const currentPreWatchdogLLMId = {{ watchdog_config.pre_watchdog.llm_id or 'null' }};
    const currentPostWatchdogLLMId = {{ watchdog_config.post_watchdog.llm_id or 'null' }};

    // Extensions Management
    const promptId = {{ prompt_id if prompt_id else 'null' }};

    function toggleExtensionsPanel() {
        const enabled = document.getElementById('extensions_enabled').checked;
        document.getElementById('extensions-panel').style.display = enabled ? 'block' : 'none';
    }

    async function loadExtensions() {
        if (!promptId) return;
        try {
            const resp = await fetch(`/api/prompts/${promptId}/extensions`);
            if (!resp.ok) return;
            const extensions = await resp.json();
            renderExtensionsList(extensions);
        } catch (e) {
            console.error('Failed to load extensions:', e);
        }
    }

    function renderExtensionsList(extensions) {
        const container = document.getElementById('extensions-list');
        if (!extensions.length) {
            container.innerHTML = '<p class="text-muted small">No extensions yet. Add one to create levels.</p>';
            return;
        }

        container.innerHTML = extensions.map((ext, idx) => `
            <div class="extension-item d-flex align-items-center gap-2 p-2 mb-1 border rounded"
                 draggable="true" data-ext-id="${ext.id}" data-order="${idx}">
                <i class="fas fa-grip-vertical text-muted extension-drag-handle" style="cursor: grab;"></i>
                <div class="flex-grow-1">
                    <strong>${escapeHtml(ext.name)}</strong>
                    ${ext.is_default ? '<span class="badge bg-primary ms-1">Default</span>' : ''}
                    ${ext.description ? `<br><small class="text-muted">${escapeHtml(ext.description)}</small>` : ''}
                </div>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="editExtension(${ext.id})" title="Edit">
                    <i class="fas fa-edit"></i>
                </button>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteExtension(${ext.id}, '${escapeHtml(ext.name).replace(/'/g, "\\'")}')" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `).join('');

        initExtensionDragAndDrop();
    }

    function showExtensionEditor(extData = null) {
        const editor = document.getElementById('extension-editor');
        const title = document.getElementById('extension-editor-title');

        if (extData) {
            title.textContent = 'Edit Extension';
            document.getElementById('extension-editor-id').value = extData.id;
            document.getElementById('ext-name').value = extData.name;
            document.getElementById('ext-description').value = extData.description || '';
            document.getElementById('ext-prompt-text').value = extData.prompt_text;
            document.getElementById('ext-is-default').checked = extData.is_default;
        } else {
            title.textContent = 'New Extension';
            document.getElementById('extension-editor-id').value = '';
            document.getElementById('ext-name').value = '';
            document.getElementById('ext-description').value = '';
            document.getElementById('ext-prompt-text').value = '';
            document.getElementById('ext-is-default').checked = false;
        }

        editor.style.display = 'block';
        document.getElementById('ext-name').focus();
    }

    function hideExtensionEditor() {
        document.getElementById('extension-editor').style.display = 'none';
    }

    async function editExtension(extId) {
        try {
            const resp = await fetch(`/api/prompts/${promptId}/extensions`);
            const extensions = await resp.json();
            const ext = extensions.find(e => e.id === extId);
            if (ext) showExtensionEditor(ext);
        } catch (e) {
            console.error('Failed to load extension for editing:', e);
        }
    }

    async function saveExtension() {
        const extId = document.getElementById('extension-editor-id').value;
        const name = document.getElementById('ext-name').value.trim();
        const promptText = document.getElementById('ext-prompt-text').value.trim();
        const description = document.getElementById('ext-description').value.trim();
        const isDefault = document.getElementById('ext-is-default').checked;

        if (!name) { NotificationModal.warning('Validation', 'Extension name is required'); return; }
        if (!promptText) { NotificationModal.warning('Validation', 'Extension prompt text is required'); return; }

        const body = { name, prompt_text: promptText, description, is_default: isDefault };
        const url = extId
            ? `/api/prompts/${promptId}/extensions/${extId}`
            : `/api/prompts/${promptId}/extensions`;
        const method = extId ? 'PUT' : 'POST';

        try {
            const resp = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            if (!resp.ok) {
                const err = await resp.json();
                NotificationModal.error('Save Failed', err.detail || 'Failed to save extension');
                return;
            }
            hideExtensionEditor();
            loadExtensions();
        } catch (e) {
            console.error('Failed to save extension:', e);
        }
    }

    async function deleteExtension(extId, name) {
        const confirmed = await NotificationModal.confirm('Delete Extension', `Delete extension "${name}"?`);
        if (!confirmed) return;
        try {
            const resp = await fetch(`/api/prompts/${promptId}/extensions/${extId}`, { method: 'DELETE' });
            if (resp.ok) loadExtensions();
        } catch (e) {
            console.error('Failed to delete extension:', e);
        }
    }

    function initExtensionDragAndDrop() {
        const items = document.querySelectorAll('.extension-item');
        let draggedEl = null;

        items.forEach(item => {
            item.addEventListener('dragstart', (e) => {
                draggedEl = item;
                item.style.opacity = '0.5';
                e.dataTransfer.effectAllowed = 'move';
            });
            item.addEventListener('dragend', () => {
                item.style.opacity = '1';
                draggedEl = null;
                document.querySelectorAll('.extension-item').forEach(el => el.classList.remove('drag-over'));
            });
            item.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                item.classList.add('drag-over');
            });
            item.addEventListener('dragleave', () => {
                item.classList.remove('drag-over');
            });
            item.addEventListener('drop', (e) => {
                e.preventDefault();
                item.classList.remove('drag-over');
                if (draggedEl && draggedEl !== item) {
                    const container = document.getElementById('extensions-list');
                    const allItems = [...container.querySelectorAll('.extension-item')];
                    const fromIdx = allItems.indexOf(draggedEl);
                    const toIdx = allItems.indexOf(item);
                    if (fromIdx < toIdx) {
                        item.after(draggedEl);
                    } else {
                        item.before(draggedEl);
                    }
                    saveExtensionOrder();
                }
            });
        });
    }

    async function saveExtensionOrder() {
        const items = document.querySelectorAll('.extension-item');
        const order = Array.from(items).map(el => parseInt(el.dataset.extId));
        try {
            await fetch(`/api/prompts/${promptId}/extensions/reorder`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ order })
            });
        } catch (e) {
            console.error('Failed to save extension order:', e);
            NotificationModal.error('Reorder Failed', 'Could not save the new order. The list has been refreshed.');
            loadExtensions();
        }
    }

    // Welcome Message Editor
    async function savePromptWelcome() {
        if (!promptId) return;
        const html = document.getElementById('prompt-welcome-editor').value;
        try {
            const resp = await fetch(`/api/home/prompt/${promptId}/welcome`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ html })
            });
            if (resp.ok) {
                NotificationModal.success('Saved', 'Welcome message saved.');
            } else {
                NotificationModal.error('Save Failed', 'Failed to save welcome message.');
            }
        } catch (e) {
            NotificationModal.error('Error', 'Error saving welcome message.');
        }
    }

    function previewPromptWelcome() {
        const html = document.getElementById('prompt-welcome-editor').value;
        const blob = new Blob([html], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        window.open(url, '_blank');
        setTimeout(() => URL.revokeObjectURL(url), 60000);
    }

    function serializeExtensionsConfig() {
        document.getElementById('hidden_extensions_enabled').value =
            document.getElementById('extensions_enabled').checked ? '1' : '0';
        document.getElementById('hidden_extensions_auto_advance').value =
            document.getElementById('extensions_auto_advance').checked ? '1' : '0';
        document.getElementById('hidden_extensions_free_selection').value =
            document.getElementById('extensions_free_selection').checked ? '1' : '0';
    }

    // Pricing functions
    function togglePricingSection() {
        const isPublic = document.getElementById('isPublic').checked;
        const pricingSection = document.getElementById('pricingSection');
        const categoriesSection = document.getElementById('categoriesSection');
        const packSettings = document.getElementById('packSettings');

        pricingSection.style.display = isPublic ? 'block' : 'none';
        categoriesSection.style.display = isPublic ? 'block' : 'none';
        packSettings.style.display = isPublic ? 'block' : 'none';

        // Reset to free if hiding
        if (!isPublic) {
            document.getElementById('pricingFree').checked = true;
            togglePricingOptions();
            document.getElementById('allowInPacks').checked = false;
            togglePackOptions();
        }
    }

    function togglePackOptions() {
        const allowInPacks = document.getElementById('allowInPacks').checked;
        document.getElementById('noticePeriodOptions').style.display = allowInPacks ? 'block' : 'none';
        if (!allowInPacks) {
            // Reset notice period to the lowest allowed value (keep current if > 0 due to never-decrease rule)
            const select = document.getElementById('noticePeriod');
            for (const opt of select.options) {
                if (!opt.disabled) { select.value = opt.value; break; }
            }
        }
    }

    function togglePricingOptions() {
        const isPaid = document.getElementById('pricingPaid').checked;
        document.getElementById('markupOptions').style.display = isPaid ? 'block' : 'none';
        if (!isPaid) {
            document.getElementById('markupInput').value = '0';
        }
        updateEarningsPreview();
    }

    function updateEarningsPreview() {
        const markup = parseFloat(document.getElementById('markupInput').value) || 0;
        const earnings = markup * 0.70;  // 70% to creator
        document.getElementById('previewEarnings').textContent = `$${earnings.toFixed(2)}`;
    }

    function toggleLLMOptions() {
        const mode = document.querySelector('input[name="llm_mode"]:checked')?.value || 'any';
        document.getElementById('restrictedLLMOptions').style.display = mode === 'restricted' ? 'block' : 'none';
        document.getElementById('forcedLLMOptions').style.display = mode === 'forced' ? 'block' : 'none';
        document.getElementById('forcedLLM').disabled = mode !== 'forced';
    }

    function loadLLMs() {
        fetch('/api/llms')
            .then(response => response.json())
            .then(llms => {
                const select = document.getElementById('forcedLLM');
                const preWdSelect = document.getElementById('preWatchdogLLM');
                const postWdSelect = document.getElementById('postWatchdogLLM');
                const checkboxList = document.getElementById('llmCheckboxList');
                select.innerHTML = '<option value="">Select a model</option>';
                preWdSelect.innerHTML = '<option value="">Select a model</option>';
                postWdSelect.innerHTML = '<option value="">Select a model</option>';
                checkboxList.innerHTML = '';
                llms.forEach(llm => {
                    const option = document.createElement('option');
                    option.value = llm.id;
                    option.textContent = `${llm.machine} - ${llm.model}`;
                    if (currentForcedLLMId && llm.id === currentForcedLLMId) {
                        option.selected = true;
                    }
                    select.appendChild(option);

                    const preOpt = option.cloneNode(true);
                    preOpt.selected = (currentPreWatchdogLLMId && llm.id === currentPreWatchdogLLMId);
                    preWdSelect.appendChild(preOpt);

                    const postOpt = option.cloneNode(true);
                    postOpt.selected = (currentPostWatchdogLLMId && llm.id === currentPostWatchdogLLMId);
                    postWdSelect.appendChild(postOpt);

                    // Add checkbox for restricted mode
                    const isChecked = currentAllowedLLMs.includes(llm.id);
                    const div = document.createElement('div');
                    div.className = 'form-check';
                    div.innerHTML = `
                        <input class="form-check-input llm-restrict-checkbox" type="checkbox" id="llmRestrict_${llm.id}" value="${llm.id}" ${isChecked ? 'checked' : ''}>
                        <label class="form-check-label" for="llmRestrict_${llm.id}">${llm.machine} - ${llm.model}</label>
                    `;
                    checkboxList.appendChild(div);
                });
            })
            .catch(error => console.error('Error loading LLMs:', error));
    }

    // --- Watchdog functions ---
    function togglePreWatchdogFields() {
        const enabled = document.getElementById('preWatchdogEnabled').checked;
        document.getElementById('preWatchdogFields').style.display = enabled ? 'block' : 'none';
    }

    function togglePostWatchdogFields() {
        const enabled = document.getElementById('postWatchdogEnabled').checked;
        document.getElementById('postWatchdogFields').style.display = enabled ? 'block' : 'none';
    }

    function serializeWatchdogConfig() {
        const preEnabled = document.getElementById('preWatchdogEnabled').checked;
        const postEnabled = document.getElementById('postWatchdogEnabled').checked;

        const preConfig = { enabled: preEnabled };
        if (preEnabled) {
            const llmId = document.getElementById('preWatchdogLLM').value;
            preConfig.llm_id = llmId ? parseInt(llmId) : null;
            preConfig.objectives = document.getElementById('preWatchdogObjectives').value
                .split('\n').map(s => s.trim()).filter(s => s.length > 0);
            preConfig.steering_prompt = document.getElementById('preWatchdogSteeringPrompt').value.trim();
            preConfig.frequency = parseInt(document.getElementById('preWatchdogFrequency').value) || 1;
            preConfig.can_takeover = document.getElementById('preWatchdogCanTakeover').checked;
            preConfig.can_lock = document.getElementById('preWatchdogCanLock').checked;
        }

        const postConfig = { enabled: postEnabled };
        if (postEnabled) {
            const llmId = document.getElementById('postWatchdogLLM').value;
            postConfig.llm_id = llmId ? parseInt(llmId) : null;
            postConfig.mode = document.getElementById('postWatchdogMode').value;
            postConfig.objectives = document.getElementById('postWatchdogObjectives').value
                .split('\n').map(s => s.trim()).filter(s => s.length > 0);
            postConfig.steering_prompt = document.getElementById('postWatchdogSteeringPrompt').value.trim();
            postConfig.frequency = parseInt(document.getElementById('postWatchdogFrequency').value) || 3;
            postConfig.max_hint_chars = parseInt(document.getElementById('postWatchdogMaxHintChars').value) || 500;
            postConfig.thresholds = {
                max_turns_off_topic: parseInt(document.getElementById('postWatchdogMaxOffTopic').value) || 3,
                max_turns_same_subtopic: parseInt(document.getElementById('postWatchdogMaxSameSubtopic').value) || 5
            };
            postConfig.can_takeover = document.getElementById('postWatchdogCanTakeover').checked;
            postConfig.takeover_threshold = parseInt(document.getElementById('postWatchdogTakeoverThreshold').value) || 5;
            postConfig.can_lock = document.getElementById('postWatchdogCanLock').checked;
        }

        const config = { pre_watchdog: preConfig, post_watchdog: postConfig };
        document.getElementById('watchdogConfigInput').value = JSON.stringify(config);
    }

    // --- Watchdog AI Auto-fill functions ---
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    async function requestWatchdogAutoFill() {
        const llmSelect = document.getElementById('postWatchdogLLM');
        const promptTextarea = document.getElementById('promptText');

        if (!llmSelect.value) {
            NotificationModal.warning(
                'Post-Watchdog LLM Required',
                'Please select a <strong>Post-Watchdog LLM</strong> before using AI Auto-fill.'
            );
            return;
        }

        if (!promptTextarea.value.trim()) {
            NotificationModal.warning(
                'Prompt Text Required',
                'Write the <strong>main prompt text</strong> first. The AI needs it to suggest appropriate watchdog settings.'
            );
            return;
        }

        const btn = document.getElementById('watchdogAutoFillBtn');
        const originalHTML = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Analyzing...';

        try {
            const response = await fetch('/api/watchdog/suggest-config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    llm_id: parseInt(llmSelect.value),
                    prompt_text: promptTextarea.value.trim()
                })
            });

            if (!response.ok) {
                const err = await response.json().catch(() => ({ detail: 'Unknown error' }));
                throw new Error(err.detail || `HTTP ${response.status}`);
            }

            const suggestion = await response.json();
            showWatchdogSuggestionModal(suggestion);

        } catch (error) {
            console.error('Watchdog auto-fill error:', error);
            NotificationModal.error(
                'Auto-fill Error',
                'Could not get AI suggestions. Please try again or configure manually.'
            );
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalHTML;
        }
    }

    function showWatchdogSuggestionModal(suggestion) {
        const fields = [
            {
                key: 'mode',
                label: 'Mode',
                value: suggestion.mode,
                display: suggestion.mode.charAt(0).toUpperCase() + suggestion.mode.slice(1)
            },
            {
                key: 'objectives',
                label: 'Objectives',
                value: suggestion.objectives,
                display: suggestion.objectives.map(o => '- ' + o).join('\n')
            },
            {
                key: 'steering_prompt',
                label: 'Steering Prompt',
                value: suggestion.steering_prompt,
                display: suggestion.steering_prompt
            },
            {
                key: 'frequency',
                label: 'Frequency',
                value: suggestion.frequency,
                display: suggestion.frequency + ' (every ' + suggestion.frequency + ' user turns)'
            },
            {
                key: 'max_hint_chars',
                label: 'Max Hint Chars',
                value: suggestion.max_hint_chars,
                display: String(suggestion.max_hint_chars)
            },
            {
                key: 'max_turns_off_topic',
                label: 'Max Turns Off-Topic',
                value: suggestion.thresholds.max_turns_off_topic,
                display: String(suggestion.thresholds.max_turns_off_topic)
            },
            {
                key: 'max_turns_same_subtopic',
                label: 'Max Turns Same Subtopic',
                value: suggestion.thresholds.max_turns_same_subtopic,
                display: String(suggestion.thresholds.max_turns_same_subtopic)
            }
        ];

        let itemsHTML = fields.map(f => `
            <div class="suggestion-item">
                <input type="checkbox" class="form-check-input suggestion-checkbox"
                       id="suggest_${f.key}" data-key="${f.key}" checked>
                <div>
                    <label class="suggestion-label" for="suggest_${f.key}">${f.label}</label>
                    <div class="suggestion-value">${escapeHtml(f.display)}</div>
                </div>
            </div>
        `).join('');

        const modalBody = document.getElementById('wdSuggestionBody');
        modalBody.innerHTML = `
            <p class="text-muted mb-3" style="font-size: 0.9rem;">
                The AI analyzed your prompt and suggests these settings:
            </p>
            <div class="bulk-actions">
                <a href="#" onclick="toggleAllSuggestions(true); return false;">Select All</a>
                <a href="#" onclick="toggleAllSuggestions(false); return false;">Deselect All</a>
            </div>
            <div class="suggestion-list">${itemsHTML}</div>
        `;

        window._watchdogSuggestion = suggestion;

        updateSuggestionApplyBtn();
        modalBody.querySelectorAll('.suggestion-checkbox').forEach(cb => {
            cb.addEventListener('change', updateSuggestionApplyBtn);
        });

        const modalEl = document.getElementById('watchdogSuggestionModal');
        modalEl.addEventListener('hidden.bs.modal', () => {
            window._watchdogSuggestion = null;
        }, { once: true });
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
    }

    function toggleAllSuggestions(checked) {
        document.querySelectorAll('#wdSuggestionBody .suggestion-checkbox')
            .forEach(cb => { cb.checked = checked; });
        updateSuggestionApplyBtn();
    }

    function updateSuggestionApplyBtn() {
        const checkboxes = document.querySelectorAll('#wdSuggestionBody .suggestion-checkbox');
        const checkedCount = [...checkboxes].filter(cb => cb.checked).length;
        const applyBtn = document.getElementById('wdSuggestionApplyBtn');
        applyBtn.disabled = checkedCount === 0;
        applyBtn.textContent = 'Apply Selected (' + checkedCount + ')';
    }

    function applyWatchdogSuggestions() {
        const suggestion = window._watchdogSuggestion;
        if (!suggestion) return;

        const isChecked = (key) => {
            const cb = document.getElementById('suggest_' + key);
            return cb && cb.checked;
        };

        if (isChecked('mode')) {
            document.getElementById('postWatchdogMode').value = suggestion.mode;
        }
        if (isChecked('objectives')) {
            document.getElementById('postWatchdogObjectives').value =
                suggestion.objectives.join('\n');
        }
        if (isChecked('steering_prompt')) {
            document.getElementById('postWatchdogSteeringPrompt').value =
                suggestion.steering_prompt;
        }
        if (isChecked('frequency')) {
            document.getElementById('postWatchdogFrequency').value = suggestion.frequency;
        }
        if (isChecked('max_hint_chars')) {
            document.getElementById('postWatchdogMaxHintChars').value = suggestion.max_hint_chars;
        }
        if (isChecked('max_turns_off_topic')) {
            document.getElementById('postWatchdogMaxOffTopic').value =
                suggestion.thresholds.max_turns_off_topic;
        }
        if (isChecked('max_turns_same_subtopic')) {
            document.getElementById('postWatchdogMaxSameSubtopic').value =
                suggestion.thresholds.max_turns_same_subtopic;
        }

        // Expand advanced settings if any advanced field was applied
        if (isChecked('max_hint_chars') || isChecked('max_turns_off_topic') || isChecked('max_turns_same_subtopic')) {
            const advancedSection = document.getElementById('postWatchdogAdvanced');
            if (advancedSection.style.display !== 'block') {
                advancedSection.style.display = 'block';
                const toggleIcon = advancedSection.previousElementSibling?.querySelector('i.fas');
                if (toggleIcon) {
                    toggleIcon.classList.replace('fa-caret-right', 'fa-caret-down');
                }
            }
        }

        const modalEl = document.getElementById('watchdogSuggestionModal');
        bootstrap.Modal.getInstance(modalEl)?.hide();
    }

    function updateEditorIds() {
        document.getElementById('editorIds').value = editors.join(',');
    }

    function addEditor() {
        const select = document.getElementById('editorSelect');
        const editorId = select.value;
        const editorName = select.options[select.selectedIndex].text;

        if (!editors.includes(editorId)) {
            editors.push(editorId);
            const editorList = document.querySelector('.editor-list');
            const editorItem = document.createElement('div');
            editorItem.className = 'editor-item';
            editorItem.innerHTML = `
                <span>${editorName}</span>
                <button type="button" class="btn btn-sm btn-danger" onclick="removeEditor(${editorId})">Remove</button>
            `;
            editorList.appendChild(editorItem);
            updateEditorIds();
        }
    }

    function removeEditor(editorId) {
        editors = editors.filter(id => id !== editorId);
        const editorItem = document.querySelector(`.editor-item button[onclick="removeEditor(${editorId})"]`).parentNode;
        editorItem.remove();
        updateEditorIds();
    }

    function loadVoices() {
        fetch('/api/voices')
            .then(response => response.json())
            .then(voices => {
                const voiceSelect = document.getElementById('voiceSelect');
                voiceSelect.innerHTML = '<option value="">Select a voice</option>';
                voices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.id;
                    option.textContent = voice.name;
                    voiceSelect.appendChild(option);
                });
                if (currentVoiceId) {
                    voiceSelect.value = currentVoiceId;
                }
                setupVoiceControls();
            })
            .catch(error => console.error('Error loading voices:', error));
    }

    function setupVoiceControls() {
        const voiceSelect = document.getElementById('voiceSelect');
        const categorySelect = document.getElementById('sampleCategory');
        const playButton = document.getElementById('playVoiceButton');

        const categories = [
            "Children and Basic Education",
            "Finance and Business",
            "Relaxation and Meditation",
            "Casual Conversation",
            "Drama and Emotional Narration",
            "Storytelling",
            "Advertising and Announcements",
            "Science and Technology",
            "Education and Advanced Training",
            "Corporate Environments",
            "Mystery and Suspense",
            "Sports and Energy"
        ];

        categories.forEach((category, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = category;
            categorySelect.appendChild(option);
        });

        voiceSelect.addEventListener('change', function() {
            categorySelect.style.display = this.value ? 'inline-block' : 'none';
            playButton.style.display = this.value ? 'inline-block' : 'none';
        });

        playButton.addEventListener('click', function(e) {
            e.preventDefault();
            playVoiceSample(voiceSelect.value, categorySelect.value);
        });

        categorySelect.style.display = voiceSelect.value ? 'inline-block' : 'none';
        playButton.style.display = voiceSelect.value ? 'inline-block' : 'none';
    }

    function playVoiceSample(voiceId, categoryId) {
        if (!voiceId) return;

        if (audioPlayer) {
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            audioPlayer = null;
            playVoiceButton.innerHTML = '<i class="fas fa-play me-1"></i>Play Sample';
            return;
        }

        playVoiceButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Loading...';
        playVoiceButton.disabled = true;

        fetch(`/api/voice-sample/${voiceId}?category=${categoryId}`)
            .then(response => response.blob())
            .then(blob => {
                const url = URL.createObjectURL(blob);
                audioPlayer = new Audio(url);

                audioPlayer.onended = function() {
                    playVoiceButton.innerHTML = '<i class="fas fa-play me-1"></i>Play Sample';
                    playVoiceButton.disabled = false;
                    audioPlayer = null;
                };

                audioPlayer.play();
                playVoiceButton.innerHTML = '<i class="fas fa-stop me-1"></i>Stop Sample';
                playVoiceButton.disabled = false;
            })
            .catch(error => {
                console.error('Error playing voice sample:', error);
                playVoiceButton.innerHTML = '<i class="fas fa-play me-1"></i>Play Sample';
                playVoiceButton.disabled = false;
            });
    }

    // Categories functionality
    async function loadCategories() {
        try {
            // Load all categories
            const categoriesResponse = await fetch('/api/categories?include_restricted=true');
            const categories = await categoriesResponse.json();

            // Load current prompt's categories
            const promptCategoriesResponse = await fetch(`/api/prompts/${PROMPT_ID_FOR_CATEGORIES}/categories`);
            const promptCategories = await promptCategoriesResponse.json();
            const currentCategoryIds = promptCategories.map(c => c.id);

            const grid = document.getElementById('categoriesGrid');
            grid.innerHTML = '';

            if (categories.length === 0) {
                grid.innerHTML = '<p class="text-muted">No categories available</p>';
                return;
            }

            categories.forEach(cat => {
                const isChecked = currentCategoryIds.includes(cat.id);
                const div = document.createElement('div');
                div.className = 'form-check category-item';
                div.innerHTML = `
                    <input class="form-check-input category-checkbox" type="checkbox"
                           id="cat_${cat.id}" value="${cat.id}"
                           data-age-restricted="${cat.is_age_restricted}"
                           ${isChecked ? 'checked' : ''}>
                    <label class="form-check-label" for="cat_${cat.id}">
                        <i class="fas ${cat.icon} me-1"></i>
                        ${cat.name}
                        ${cat.is_age_restricted ? '<span class="badge bg-danger ms-1">18+</span>' : ''}
                    </label>
                `;
                grid.appendChild(div);
            });

            // Initialize selectedCategories
            selectedCategories = currentCategoryIds;
            document.getElementById('categoryIds').value = JSON.stringify(selectedCategories);

            // Add event listeners to checkboxes
            document.querySelectorAll('.category-checkbox').forEach(cb => {
                cb.addEventListener('change', updateSelectedCategories);
            });

        } catch (error) {
            console.error('Error loading categories:', error);
            document.getElementById('categoriesGrid').innerHTML =
                '<p class="text-danger">Error loading categories</p>';
        }
    }

    function updateSelectedCategories() {
        selectedCategories = Array.from(document.querySelectorAll('.category-checkbox:checked'))
            .map(cb => parseInt(cb.value));
        document.getElementById('categoryIds').value = JSON.stringify(selectedCategories);
        validateCategories();
    }

    function validateCategories() {
        const isPublic = document.getElementById('isPublic').checked;
        const errorDiv = document.getElementById('categoryError');

        if (isPublic && selectedCategories.length === 0) {
            errorDiv.style.display = 'block';
            return false;
        } else {
            errorDiv.style.display = 'none';
            return true;
        }
    }

    // === Welcome Page Wizard ===
    let welcomePollingInterval = null;
    let welcomeActiveTaskId = null;
    let welcomeCurrentFiles = [];
    const WELCOME_POLL_MS = 4000;

    function welcomeSetUI(hasFiles) {
        const badge = document.getElementById('welcome-status-badge');
        const modifyBtn = document.getElementById('welcome-modify-btn');
        const deleteBtn = document.getElementById('welcome-delete-btn');
        const fileListDiv = document.getElementById('welcome-file-list');

        if (hasFiles) {
            badge.className = 'badge bg-success ms-2';
            badge.style.fontSize = '0.75rem';
            badge.textContent = 'Active';
            modifyBtn.style.display = '';
            deleteBtn.style.display = '';
            fileListDiv.style.display = '';
        } else {
            badge.className = 'badge bg-secondary ms-2';
            badge.style.fontSize = '0.75rem';
            badge.textContent = 'Not created';
            modifyBtn.style.display = 'none';
            deleteBtn.style.display = 'none';
            fileListDiv.style.display = 'none';
        }
    }

    async function welcomeLoadFiles() {
        if (!promptId) return;
        try {
            const resp = await fetch(`/api/welcome/${promptId}/files`);
            if (!resp.ok) { welcomeSetUI(false); return; }
            const data = await resp.json();
            welcomeCurrentFiles = data.files || [];
            const ul = document.getElementById('welcome-files-ul');
            ul.innerHTML = '';
            if (welcomeCurrentFiles.length > 0) {
                welcomeCurrentFiles.forEach(f => {
                    const li = document.createElement('li');
                    li.textContent = f;
                    ul.appendChild(li);
                });
                welcomeSetUI(true);
            } else {
                welcomeSetUI(false);
            }
        } catch (e) {
            console.error('Welcome files load error:', e);
            welcomeSetUI(false);
        }
    }

    async function welcomeCheckActiveJob() {
        if (!promptId) return;
        try {
            const resp = await fetch(`/api/welcome/${promptId}/ai/active-job`);
            if (!resp.ok) return;
            const data = await resp.json();
            if (data.success && data.has_active_job) {
                welcomeShowProgress(`A ${data.type} job is running...`);
                welcomeStartPolling(data.task_id);
            }
        } catch (e) {
            console.error('Welcome active job check error:', e);
        }
    }

    function welcomeShowProgress(text) {
        document.getElementById('welcome-progress').style.display = '';
        document.getElementById('welcome-progress-text').textContent = text || 'Working...';
        document.getElementById('welcome-generate-btn').disabled = true;
        document.getElementById('welcome-modify-btn').disabled = true;
        document.getElementById('welcome-delete-btn').disabled = true;
    }

    function welcomeHideProgress() {
        document.getElementById('welcome-progress').style.display = 'none';
        document.getElementById('welcome-generate-btn').disabled = false;
        document.getElementById('welcome-modify-btn').disabled = false;
        document.getElementById('welcome-delete-btn').disabled = false;
    }

    function welcomeStartPolling(taskId) {
        welcomeActiveTaskId = taskId;
        welcomeShowProgress('AI is working...');
        welcomePollStatus(taskId);
        welcomePollingInterval = setInterval(() => welcomePollStatus(taskId), WELCOME_POLL_MS);
    }

    function welcomeStopPolling() {
        if (welcomePollingInterval) {
            clearInterval(welcomePollingInterval);
            welcomePollingInterval = null;
        }
        welcomeActiveTaskId = null;
    }

    async function welcomePollStatus(taskId) {
        try {
            const resp = await fetch(`/api/welcome/${promptId}/ai/status/${taskId}`);
            if (!resp.ok) { welcomeStopPolling(); welcomeHideProgress(); return; }
            const data = await resp.json();

            if (data.status === 'running') {
                const elapsed = Math.round((Date.now() - new Date(data.started_at).getTime()) / 1000);
                document.getElementById('welcome-progress-text').textContent = `AI is working... (${elapsed}s elapsed)`;
            } else if (data.status === 'completed') {
                welcomeStopPolling();
                welcomeHideProgress();
                NotificationModal.success('Welcome Page', 'Job completed successfully!');
                welcomeLoadFiles();
                // Close any open modals
                ['welcome-wizard-modal', 'welcome-modify-modal'].forEach(id => {
                    const el = document.getElementById(id);
                    const modal = bootstrap.Modal.getInstance(el);
                    if (modal) modal.hide();
                });
            } else if (data.status === 'failed' || data.status === 'timeout') {
                welcomeStopPolling();
                welcomeHideProgress();
                NotificationModal.error('Welcome Page', data.error || `Job ${data.status}`);
            }
        } catch (e) {
            console.error('Welcome poll error:', e);
        }
    }

    function welcomeOpenGenerateModal() {
        document.getElementById('welcome-wizard-description').value = '';
        document.getElementById('welcome-wizard-error').style.display = 'none';
        document.getElementById('welcome-wizard-progress').style.display = 'none';
        document.getElementById('welcome-wizard-generate-btn').disabled = false;
        document.getElementById('welcome-wizard-cancel-btn').disabled = false;
        new bootstrap.Modal(document.getElementById('welcome-wizard-modal')).show();
    }

    async function welcomeGenerate() {
        const description = document.getElementById('welcome-wizard-description').value.trim();
        if (!description || description.length < 20) {
            NotificationModal.warning('Description Required', 'Please provide a detailed description (at least 20 characters).');
            document.getElementById('welcome-wizard-description').focus();
            return;
        }

        const style = document.querySelector('input[name="welcomeWizardStyle"]:checked').value;
        const primaryColor = document.getElementById('welcome-primary-color').value;
        const secondaryColor = document.getElementById('welcome-secondary-color').value;
        const language = document.getElementById('welcome-wizard-language').value;
        let timeoutMinutes = parseInt(document.getElementById('welcome-wizard-timeout').value, 10) || 5;
        timeoutMinutes = Math.max(1, Math.min(60, timeoutMinutes));

        const progressEl = document.getElementById('welcome-wizard-progress');
        const errorEl = document.getElementById('welcome-wizard-error');

        progressEl.style.display = 'block';
        progressEl.querySelector('small').textContent = 'Starting job...';
        errorEl.style.display = 'none';
        document.getElementById('welcome-wizard-generate-btn').disabled = true;
        document.getElementById('welcome-wizard-cancel-btn').disabled = true;

        try {
            const resp = await fetch(`/api/welcome/${promptId}/ai/generate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    description,
                    style,
                    primary_color: primaryColor,
                    secondary_color: secondaryColor,
                    language,
                    timeout_minutes: timeoutMinutes
                })
            });
            const data = await resp.json();

            if (data.success && data.task_id) {
                progressEl.querySelector('small').textContent = 'AI is working...';
                welcomeStartPolling(data.task_id);
            } else {
                errorEl.textContent = data.message || data.detail || 'Failed to start job';
                errorEl.style.display = 'block';
                progressEl.style.display = 'none';
                document.getElementById('welcome-wizard-generate-btn').disabled = false;
                document.getElementById('welcome-wizard-cancel-btn').disabled = false;
            }
        } catch (e) {
            console.error('Welcome generate error:', e);
            errorEl.textContent = 'Network error. Please try again.';
            errorEl.style.display = 'block';
            progressEl.style.display = 'none';
            document.getElementById('welcome-wizard-generate-btn').disabled = false;
            document.getElementById('welcome-wizard-cancel-btn').disabled = false;
        }
    }

    function welcomeOpenModifyModal() {
        document.getElementById('welcome-modify-instructions').value = '';
        document.getElementById('welcome-modify-error').style.display = 'none';
        document.getElementById('welcome-modify-progress').style.display = 'none';
        document.getElementById('welcome-modify-apply-btn').disabled = false;
        document.getElementById('welcome-modify-cancel-btn').disabled = false;

        const fileListHtml = welcomeCurrentFiles.length > 0
            ? welcomeCurrentFiles.map(f => `<code>${f}</code>`).join(', ')
            : 'No files';
        document.getElementById('welcome-modify-file-list').innerHTML = fileListHtml;

        new bootstrap.Modal(document.getElementById('welcome-modify-modal')).show();
    }

    async function welcomeApplyModifications() {
        const instructions = document.getElementById('welcome-modify-instructions').value.trim();
        if (!instructions || instructions.length < 10) {
            NotificationModal.warning('Instructions Required', 'Please provide instructions (at least 10 characters).');
            document.getElementById('welcome-modify-instructions').focus();
            return;
        }

        let timeoutMinutes = parseInt(document.getElementById('welcome-modify-timeout').value, 10) || 5;
        timeoutMinutes = Math.max(1, Math.min(60, timeoutMinutes));

        const progressEl = document.getElementById('welcome-modify-progress');
        const errorEl = document.getElementById('welcome-modify-error');

        progressEl.style.display = 'block';
        progressEl.querySelector('small').textContent = 'Starting job...';
        errorEl.style.display = 'none';
        document.getElementById('welcome-modify-apply-btn').disabled = true;
        document.getElementById('welcome-modify-cancel-btn').disabled = true;

        try {
            const resp = await fetch(`/api/welcome/${promptId}/ai/modify`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ instructions, timeout_minutes: timeoutMinutes })
            });
            const data = await resp.json();

            if (data.success && data.task_id) {
                progressEl.querySelector('small').textContent = 'AI is working on changes...';
                welcomeStartPolling(data.task_id);
            } else {
                errorEl.textContent = data.message || data.detail || 'Failed to start job';
                errorEl.style.display = 'block';
                progressEl.style.display = 'none';
                document.getElementById('welcome-modify-apply-btn').disabled = false;
                document.getElementById('welcome-modify-cancel-btn').disabled = false;
            }
        } catch (e) {
            console.error('Welcome modify error:', e);
            errorEl.textContent = 'Network error. Please try again.';
            errorEl.style.display = 'block';
            progressEl.style.display = 'none';
            document.getElementById('welcome-modify-apply-btn').disabled = false;
            document.getElementById('welcome-modify-cancel-btn').disabled = false;
        }
    }

    async function welcomeDeleteFiles() {
        const confirmed = await NotificationModal.confirm(
            'Delete Welcome Files',
            'Are you sure you want to delete all welcome page files? This cannot be undone.'
        );
        if (!confirmed) return;

        try {
            const resp = await fetch(`/api/welcome/${promptId}/files`, { method: 'DELETE' });
            const data = await resp.json();
            if (data.success || resp.ok) {
                NotificationModal.success('Deleted', 'Welcome page files deleted.');
                welcomeLoadFiles();
            } else {
                NotificationModal.error('Delete Failed', data.message || data.detail || 'Failed to delete files.');
            }
        } catch (e) {
            console.error('Welcome delete error:', e);
            NotificationModal.error('Error', 'Error deleting welcome page files.');
        }
    }

    // Sync welcome color pickers with text inputs
    document.getElementById('welcome-primary-color').addEventListener('input', function() {
        document.getElementById('welcome-primary-color-text').value = this.value;
    });
    document.getElementById('welcome-primary-color-text').addEventListener('input', function() {
        if (/^#[0-9A-Fa-f]{6}$/.test(this.value)) {
            document.getElementById('welcome-primary-color').value = this.value;
        }
    });
    document.getElementById('welcome-secondary-color').addEventListener('input', function() {
        document.getElementById('welcome-secondary-color-text').value = this.value;
    });
    document.getElementById('welcome-secondary-color-text').addEventListener('input', function() {
        if (/^#[0-9A-Fa-f]{6}$/.test(this.value)) {
            document.getElementById('welcome-secondary-color').value = this.value;
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        loadVoices();
        loadCategories();
        loadLLMs();
        toggleLLMOptions();

        // Initialize pricing preview
        updateEarningsPreview();

        // Add validation on public checkbox change
        document.getElementById('isPublic').addEventListener('change', function() {
            validateCategories();
            togglePricingSection();
        });

        // Initialize extensions panel
        toggleExtensionsPanel();
        if (promptId) loadExtensions();

        // Load welcome message
        if (promptId) {
            fetch(`/api/home/prompt/${promptId}/welcome`)
                .then(r => r.ok ? r.json() : null)
                .then(data => {
                    const editor = document.getElementById('prompt-welcome-editor');
                    if (editor && data && data.html) editor.value = data.html;
                })
                .catch(() => {});
        }

        // Initialize welcome page wizard
        if (promptId) {
            welcomeLoadFiles();
            welcomeCheckActiveJob();
        } else {
            welcomeSetUI(false);
        }

        // Form validation on submit
        document.getElementById('editPromptForm').addEventListener('submit', function(e) {
            serializeExtensionsConfig();
            serializeWatchdogConfig();
            // Serialize allowed LLMs for restricted mode
            const llmMode = document.querySelector('input[name="llm_mode"]:checked')?.value;
            if (llmMode === 'restricted') {
                const selectedIds = Array.from(document.querySelectorAll('.llm-restrict-checkbox:checked')).map(cb => parseInt(cb.value));
                document.getElementById('allowedLLMsInput').value = JSON.stringify(selectedIds);
            } else {
                document.getElementById('allowedLLMsInput').value = '';
            }
            if (!validateCategories()) {
                e.preventDefault();
                document.getElementById('categoriesSection').scrollIntoView({ behavior: 'smooth' });
                return false;
            }
        });

        const promptImageInput = document.getElementById('promptImageInput');
        const promptImageContainer = document.getElementById('promptImageContainer');
        const previewContainer = document.getElementById('previewContainer');
        const previewImage = document.getElementById('previewImage');

        promptImageContainer.addEventListener('click', function(e) {
            if (e.target.closest('.avatar-icon.edit')) {
                promptImageInput.click();
            } else if (e.target.closest('.avatar-icon.delete')) {
                deletePromptImage();
            }
        });

        previewContainer.addEventListener('click', function(e) {
            if (e.target.closest('.avatar-icon.edit')) {
                promptImageInput.click();
            } else if (e.target.closest('.avatar-icon.cancel')) {
                resetPreview();
            }
        });

        promptImageInput.addEventListener('change', function(event) {
            handleFileSelection(event);
        });

        function handleFileSelection(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    previewContainer.classList.remove('hidden');
                    promptImageContainer.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function resetPreview() {
            previewContainer.classList.add('hidden');
            promptImageContainer.classList.remove('hidden');
            promptImageInput.value = '';
        }

        function deletePromptImage() {
            NotificationModal.confirm(
                'Delete Prompt Image',
                'Are you sure you want to delete this prompt image?',
                () => {
                    fetch(`/api/delete-prompt-image/{{ prompt_id }}`, {
                        method: 'POST',
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const initial = document.getElementById('promptName').value.charAt(0).toUpperCase();
                            promptImageContainer.innerHTML = `
                                <span class="avatar-initial" id="defaultPromptInitial">${initial}</span>
                                <div class="avatar-icons">
                                    <span class="avatar-icon edit"><i class="fas fa-pencil-alt"></i></span>
                                </div>
                            `;
                        } else {
                            NotificationModal.error('Delete Error', 'Error deleting prompt image: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        NotificationModal.error('Delete Error', 'An error occurred while deleting the prompt image');
                    });
                },
                null,
                { type: 'error', confirmText: 'Delete' }
            );
        }

    });
</script>
{% endblock %}
